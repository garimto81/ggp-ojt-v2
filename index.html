<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OJT Master v2.10.0 - AI ê¸°ë°˜ ì˜¨ë³´ë”© êµìœ¡ í”Œë«í¼</title>
  <!--
    CDN Script Loading Strategy:
    - Critical (sync): Tailwind, React, ReactDOM, Babel, Supabase, Dexie
    - Deferred: PDF.js, Quill, Chart.js, DOMPurify (used after initial render)
  -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase Client (Core - needed for auth) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Dexie.js (Core - needed for local cache) -->
  <script src="https://unpkg.com/dexie@4/dist/dexie.min.js"></script>
  <!-- React Core (Critical for initial render) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- PDF.js (Deferred - only used for PDF upload) -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // PDF.js worker ì„¤ì • (deferëœ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ í›„ ì„¤ì •)
    window.addEventListener('DOMContentLoaded', () => {
      if (typeof pdfjsLib !== 'undefined') {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      }
    });
  </script>
  <!-- Quill 2.0 Rich Text Editor (Deferred - only used in Mentor Dashboard) -->
  <link href="https://cdn.jsdelivr.net/npm/quill@2/dist/quill.snow.css" rel="stylesheet" />
  <script defer src="https://cdn.jsdelivr.net/npm/quill@2/dist/quill.js"></script>
  <!-- Chart.js (Deferred - only used in Admin Dashboard) -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- DOMPurify (Deferred - XSS ë°©ì–´, used for content sanitization) -->
  <script defer src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <!-- React Hot Toast (Deferred - for user notifications) -->
  <script defer src="https://cdn.jsdelivr.net/npm/react-hot-toast@2.4.1/dist/index.umd.min.js"></script>
  <style>
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-spin { animation: spin 1s linear infinite; }
    /* Quill ì—ë””í„° ìŠ¤íƒ€ì¼ ì»¤ìŠ¤í„°ë§ˆì´ì§• */
    .ql-container {
      font-size: 14px;
      min-height: 200px;
      border-bottom-left-radius: 0.5rem;
      border-bottom-right-radius: 0.5rem;
    }
    .ql-toolbar {
      border-top-left-radius: 0.5rem;
      border-top-right-radius: 0.5rem;
      background: #f8fafc;
    }
    .ql-editor {
      min-height: 180px;
    }
    .ql-editor.ql-blank::before {
      font-style: normal;
      color: #94a3b8;
    }
    /* Quill ì—ë””í„° ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
    .ql-editor img {
      max-width: 100%;
      height: auto;
      border-radius: 0.5rem;
      margin: 0.5rem 0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .ql-editor img:hover {
      transform: scale(1.01);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    /* ë“œë˜ê·¸ ë“œë¡­ ì˜ì—­ í•˜ì´ë¼ì´íŠ¸ */
    .ql-editor.drag-over {
      background-color: #e0e7ff;
      border: 2px dashed #6366f1;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo, useRef } = React;

    // ê°„ë‹¨í•œ ì•„ì´ì½˜ ì»´í¬ë„ŒíŠ¸ (SVG ê¸°ë°˜)
    const Icon = ({ name, className = "w-5 h-5" }) => {
      const icons = {
        brain: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>,
        book: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>,
        upload: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>,
        save: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>,
        refresh: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
        x: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
        logout: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>,
        user: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>,
        trash: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
        server: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" /></svg>,
        alert: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>,
        settings: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
        check: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
        play: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
        link: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>,
        file: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>,
        globe: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" /></svg>,
        text: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
        split: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>,
        clock: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
        layers: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>,
        edit: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>,
        eye: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>,
      };
      return icons[name] || null;
    };

    // =========================================
    // ì„¤ì • (Supabase)
    // =========================================
    const SUPABASE_URL = "https://cbvansmxutnogntbyswi.supabase.co";
    const SUPABASE_PUBLISHABLE_KEY = "sb_publishable_cPiRemnriBwn8rCT1JL9Qg_mjCeCBaI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);

    // =========================================
    // ì„¤ì • (Dexie.js - ë¡œì»¬ ìºì‹œ)
    // =========================================
    const CACHE_VERSION = 3; // ìºì‹œ ìŠ¤í‚¤ë§ˆ ë²„ì „ (v3: source í•„ë“œ ë™ê¸°í™”)
    const CACHE_VERSION_KEY = 'ojt_cache_version';

    const localDb = new Dexie('OJTMasterCache');
    // Dexie ìŠ¤í‚¤ë§ˆ v2: ë³µí•© ì¸ë±ìŠ¤ ìµœì í™”
    // - [team+step]: íŒ€ë³„ ìŠ¤í… ìˆœì„œ ì¡°íšŒ
    // - [user_id+doc_id]: ì‚¬ìš©ìë³„ ë¬¸ì„œ í•™ìŠµ ê¸°ë¡ ì¡°íšŒ
    localDb.version(2).stores({
      users: 'id, name, role, department',
      ojt_docs: 'id, team, step, author_id, updated_at, [team+step], [author_id+updated_at]',
      learning_records: 'id, user_id, doc_id, completed_at, [user_id+doc_id], [user_id+completed_at]',
      sync_queue: '++id, table, action, created_at'
    });

    // ì˜¨ë¼ì¸ ìƒíƒœ í™•ì¸
    const isOnline = () => navigator.onLine;

    // =========================================
    // ğŸ” DEBUG: ì„¤ê³„ ë¬¸ì œ ê²€ì¦ìš© ë””ë²„ê¹… ì‹œìŠ¤í…œ
    // =========================================
    const DEBUG = {
      enabled: true,  // ë””ë²„ê¹… í™œì„±í™” ì—¬ë¶€

      // ìƒ‰ìƒ ì½”ë“œ
      colors: {
        data: 'color: #2196F3; font-weight: bold',      // íŒŒë€ìƒ‰: ë°ì´í„° íë¦„
        mapping: 'color: #FF9800; font-weight: bold',   // ì£¼í™©ìƒ‰: í•„ë“œ ë§¤í•‘
        state: 'color: #4CAF50; font-weight: bold',     // ë…¹ìƒ‰: ìƒíƒœ ë³€ê²½
        error: 'color: #F44336; font-weight: bold',     // ë¹¨ê°„ìƒ‰: ì˜¤ë¥˜/ë¶ˆì¼ì¹˜
        render: 'color: #9C27B0; font-weight: bold',    // ë³´ë¼ìƒ‰: ë Œë”ë§
      },

      // v2.8.0: snake_case í†µì¼ ì•„í‚¤í…ì²˜ - snake_case í•„ë“œ ì¡´ì¬ í™•ì¸
      checkFieldMapping(context, obj, expectedFields) {
        if (!this.enabled) return;
        console.group(`%cğŸ” [FIELDS] ${context}`, this.colors.mapping);
        console.log('ê°ì²´:', obj);

        const missing = [];
        expectedFields.forEach(({ snake }) => {
          const hasField = obj?.hasOwnProperty(snake);
          const value = obj?.[snake];
          console.log(`  ${snake}: ${hasField ? 'âœ…' : 'âŒ'} (${value})`);
          if (!hasField) {
            missing.push(snake);
          }
        });

        if (missing.length > 0) {
          console.log('%câš ï¸ ëˆ„ë½ëœ í•„ë“œ:', this.colors.error, missing);
        } else {
          console.log('%câœ… ëª¨ë“  snake_case í•„ë“œ ì •ìƒ', this.colors.state);
        }
        console.groupEnd();
        return missing;
      },

      // ë¬¸ì œ 2: ë°ì´í„° íë¦„ ì¶”ì 
      trackDataFlow(stage, data, meta = {}) {
        if (!this.enabled) return;
        console.group(`%cğŸ“Š [DATA FLOW] ${stage}`, this.colors.data);
        console.log('ë°ì´í„°:', data);
        console.log('ë©”íƒ€ì •ë³´:', meta);
        console.log('íƒ€ì…:', Array.isArray(data) ? `Array(${data.length})` : typeof data);
        if (Array.isArray(data) && data.length > 0) {
          console.log('ì²« ë²ˆì§¸ í•­ëª© í‚¤:', Object.keys(data[0]));
        } else if (data && typeof data === 'object') {
          console.log('ê°ì²´ í‚¤:', Object.keys(data));
        }
        console.groupEnd();
      },

      // ë¬¸ì œ 3: ìƒíƒœ ë³€ê²½ ì¶”ì 
      trackStateChange(stateName, oldValue, newValue, trigger) {
        if (!this.enabled) return;
        console.group(`%cğŸ”„ [STATE] ${stateName} ë³€ê²½`, this.colors.state);
        console.log('ë³€ê²½ ì „:', oldValue);
        console.log('ë³€ê²½ í›„:', newValue);
        console.log('íŠ¸ë¦¬ê±°:', trigger);
        console.groupEnd();
      },

      // ë¬¸ì œ 4: ë Œë”ë§ ì¡°ê±´ ê²€ì¦
      checkRenderCondition(componentName, conditions) {
        if (!this.enabled) return;
        console.group(`%cğŸ¨ [RENDER] ${componentName}`, this.colors.render);
        Object.entries(conditions).forEach(([name, value]) => {
          console.log(`  ${name}: ${value} (${typeof value})`);
        });
        console.groupEnd();
      },

      // í•„ë“œ ë§¤í•‘ ì˜ˆìƒ í•„ë“œ ëª©ë¡
      OJT_DOC_FIELDS: [
        { snake: 'author_id', camel: 'authorId' },
        { snake: 'author_name', camel: 'author' },
        { snake: 'estimated_minutes', camel: 'estimatedMinutes' },
        { snake: 'source_type', camel: 'sourceType' },
        { snake: 'source_url', camel: 'sourceUrl' },
        { snake: 'source_file', camel: 'sourceFile' },
        { snake: 'created_at', camel: 'createdAt' },
        { snake: 'updated_at', camel: 'updatedAt' },
      ]
    };

    // ì½˜ì†”ì— ë””ë²„ê¹… í™œì„±í™” ë©”ì‹œì§€ ì¶œë ¥
    if (DEBUG.enabled) {
      console.log('%cğŸ”§ OJT Master v2.10.0 ë””ë²„ê¹… ëª¨ë“œ', 'color: #E91E63; font-size: 16px; font-weight: bold');
      console.log('DEBUG.enabled = false ë¡œ ë¹„í™œì„±í™” ê°€ëŠ¥');
      console.log('v2.10.0 ì•„í‚¤í…ì²˜: snake_case í†µì¼ + WebLLM ì˜¤í”ˆì†ŒìŠ¤ LLM í†µí•©');
      console.log('ì£¼ìš” ê²€ì¦ ì˜ì—­:');
      console.log('  1. snake_case í•„ë“œ ì¡´ì¬ í™•ì¸');
      console.log('  2. ë°ì´í„° íë¦„ (Supabase â†’ Cache â†’ UI)');
      console.log('  3. ìƒíƒœ ë³€ê²½ ì¶”ì ');
      console.log('  4. ë Œë”ë§ ì¡°ê±´ ê²€ì¦');
    }

    // =========================================
    // ë³´ì•ˆ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ í—¬í¼
    // =========================================
    const SecureSession = {
      // ì„¸ì…˜ ë§Œë£Œ ì‹œê°„ (30ë¶„)
      EXPIRY_MS: 30 * 60 * 1000,

      // í—ˆìš©ëœ í‚¤ ëª©ë¡ (í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸)
      ALLOWED_KEYS: ['ojt_sessionMode'],

      // í—ˆìš©ëœ ê°’ ëª©ë¡ (í‚¤ë³„)
      ALLOWED_VALUES: {
        'ojt_sessionMode': ['admin', 'mentor']
      },

      // ì„¸ì…˜ ë°ì´í„° ì €ì¥ (ë§Œë£Œ ì‹œê°„ í¬í•¨)
      set(key, value) {
        if (!this.ALLOWED_KEYS.includes(key)) {
          console.warn(`SecureSession: í—ˆìš©ë˜ì§€ ì•Šì€ í‚¤ "${key}"`);
          return false;
        }
        if (this.ALLOWED_VALUES[key] && !this.ALLOWED_VALUES[key].includes(value)) {
          console.warn(`SecureSession: í—ˆìš©ë˜ì§€ ì•Šì€ ê°’ "${value}" (í‚¤: ${key})`);
          return false;
        }
        const data = {
          value,
          timestamp: Date.now(),
          expiry: Date.now() + this.EXPIRY_MS
        };
        try {
          sessionStorage.setItem(key, JSON.stringify(data));
          return true;
        } catch (e) {
          console.error('SecureSession ì €ì¥ ì‹¤íŒ¨:', e);
          return false;
        }
      },

      // ì„¸ì…˜ ë°ì´í„° ì¡°íšŒ (ë§Œë£Œ ì²´í¬)
      get(key) {
        if (!this.ALLOWED_KEYS.includes(key)) return null;
        try {
          const raw = sessionStorage.getItem(key);
          if (!raw) return null;

          const data = JSON.parse(raw);

          // ë§Œë£Œ ì²´í¬
          if (Date.now() > data.expiry) {
            this.remove(key);
            console.log(`SecureSession: "${key}" ë§Œë£Œë¨`);
            return null;
          }

          // ê°’ ìœ íš¨ì„± ê²€ì¦
          if (this.ALLOWED_VALUES[key] && !this.ALLOWED_VALUES[key].includes(data.value)) {
            this.remove(key);
            return null;
          }

          return data.value;
        } catch (e) {
          // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë ˆê±°ì‹œ ë°ì´í„° ì²˜ë¦¬
          const legacy = sessionStorage.getItem(key);
          if (this.ALLOWED_VALUES[key]?.includes(legacy)) {
            // ë ˆê±°ì‹œ ê°’ì„ ìƒˆ í˜•ì‹ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜
            this.set(key, legacy);
            return legacy;
          }
          this.remove(key);
          return null;
        }
      },

      // ì„¸ì…˜ ë°ì´í„° ì‚­ì œ
      remove(key) {
        sessionStorage.removeItem(key);
      },

      // ë§Œë£Œ ì‹œê°„ ê°±ì‹  (í™œë™ ì‹œ)
      refresh(key) {
        const value = this.get(key);
        if (value) {
          this.set(key, value);
        }
      }
    };

    // =========================================
    // CSRF ë°©ì–´: ì‚­ì œ í™•ì¸ í—¬í¼
    // =========================================
    const confirmDeleteWithCSRF = (docTitle) => {
      // 1ì°¨ í™•ì¸
      if (!confirm(`"${docTitle}" ë¬¸ì„œë¥¼ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return false;
      }

      // 2ì°¨ í™•ì¸: ì œëª© ì…ë ¥ ìš”êµ¬
      const userInput = prompt(`ì‚­ì œí•˜ë ¤ë©´ ë¬¸ì„œ ì œëª©ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”:\n"${docTitle}"`);
      if (userInput !== docTitle) {
        Toast.warning('ì œëª©ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì‚­ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        return false;
      }

      return true;
    };

    // Toast í—¬í¼ (react-hot-toast ë˜í¼)
    // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì „ì—ëŠ” console.logë¡œ í´ë°±, ë¡œë“œ í›„ ì‹¤ì œ toast ì‚¬ìš©
    const Toast = {
      _getToast() {
        return window.reactHotToast || (typeof toast !== 'undefined' ? toast : null);
      },
      success(message) {
        const t = this._getToast();
        if (t) t.success(message, { duration: 3000 });
        else console.log('[Toast Success]', message);
      },
      error(message) {
        const t = this._getToast();
        if (t) t.error(message, { duration: 5000 });
        else console.error('[Toast Error]', message);
      },
      info(message) {
        const t = this._getToast();
        if (t) t(message, { duration: 3000, icon: 'â„¹ï¸' });
        else console.info('[Toast Info]', message);
      },
      warning(message) {
        const t = this._getToast();
        if (t) t(message, { duration: 4000, icon: 'âš ï¸' });
        else console.warn('[Toast Warning]', message);
      },
      loading(message) {
        const t = this._getToast();
        if (t) return t.loading(message);
        console.log('[Toast Loading]', message);
        return null;
      },
      dismiss(toastId) {
        const t = this._getToast();
        if (t && toastId) t.dismiss(toastId);
      }
    };

    // XSS ë°©ì–´: í…ìŠ¤íŠ¸ sanitize (HTML íƒœê·¸ ì œê±°, ì—”í‹°í‹° ì´ìŠ¤ì¼€ì´í”„)
    const sanitizeText = (text) => {
      if (!text || typeof text !== 'string') return text;
      // DOMPurifyê°€ ë¡œë“œë˜ì–´ ìˆìœ¼ë©´ ì‚¬ìš©
      if (typeof DOMPurify !== 'undefined') {
        return DOMPurify.sanitize(text, { ALLOWED_TAGS: [], ALLOWED_ATTR: [] });
      }
      // fallback: ê¸°ë³¸ HTML ì—”í‹°í‹° ì´ìŠ¤ì¼€ì´í”„
      return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    };

    // JSON ë°ì´í„° deep sanitize (sections, quiz ë“±)
    const sanitizeDocData = (doc) => {
      if (!doc) return doc;
      return {
        ...doc,
        title: sanitizeText(doc.title),
        team: sanitizeText(doc.team),
        sections: Array.isArray(doc.sections) ? doc.sections.map(s => ({
          ...s,
          title: sanitizeText(s.title),
          content: sanitizeText(s.content)
        })) : doc.sections,
        quiz: Array.isArray(doc.quiz) ? doc.quiz.map(q => ({
          ...q,
          question: sanitizeText(q.question),
          options: Array.isArray(q.options) ? q.options.map(opt => sanitizeText(opt)) : q.options
        })) : doc.quiz
      };
    };

    // ì•ˆì „í•œ URL ì—´ê¸° (XSS ë°©ì§€: javascript:, data: í”„ë¡œí† ì½œ ì°¨ë‹¨)
    const safeOpenUrl = (url) => {
      if (!url || typeof url !== 'string') {
        Toast.error('ìœ íš¨í•˜ì§€ ì•Šì€ URLì…ë‹ˆë‹¤.');
        return;
      }
      try {
        const parsedUrl = new URL(url);
        // í—ˆìš©ëœ í”„ë¡œí† ì½œë§Œ ì—´ê¸°
        if (!['http:', 'https:'].includes(parsedUrl.protocol)) {
          Toast.error('HTTP ë˜ëŠ” HTTPS URLë§Œ ì—´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          return;
        }
        window.open(url, '_blank', 'noopener,noreferrer');
      } catch (e) {
        Toast.error('URLì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
    };

    // ìºì‹œ ì „ì²´ í´ë¦¬ì–´ (ë¡œê·¸ì•„ì›ƒ ë˜ëŠ” ë²„ì „ ì—…ê·¸ë ˆì´ë“œ ì‹œ ì‚¬ìš©)
    const clearAllCache = async () => {
      try {
        await localDb.users.clear();
        await localDb.ojt_docs.clear();
        await localDb.learning_records.clear();
        await localDb.sync_queue.clear();
        console.log('All cache cleared successfully');
      } catch (e) {
        console.error('Cache clear error:', e);
      }
    };

    // ìºì‹œ ë²„ì „ ì²´í¬ ë° ë§ˆì´ê·¸ë ˆì´ì…˜ (ì•± ì‹œì‘ ì‹œ ì‹¤í–‰)
    const checkCacheVersion = async () => {
      const storedVersion = parseInt(localStorage.getItem(CACHE_VERSION_KEY) || '0', 10);

      if (storedVersion < CACHE_VERSION) {
        console.log(`Cache version upgrade: ${storedVersion} â†’ ${CACHE_VERSION}`);
        await clearAllCache();
        localStorage.setItem(CACHE_VERSION_KEY, String(CACHE_VERSION));
        console.log('Cache migration completed');
      }
    };

    // ì•± ì‹œì‘ ì‹œ ìºì‹œ ë²„ì „ ì²´í¬ ì‹¤í–‰
    checkCacheVersion();

    // =========================================
    // ì„¤ì • (AI - Google Gemini API)
    // âš ï¸ ë³´ì•ˆ ì£¼ì˜: í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” Supabase Edge Functionìœ¼ë¡œ í”„ë¡ì‹œ ê¶Œì¥
    // í˜„ì¬ í‚¤ëŠ” HTTP Referer ì œí•œ ì„¤ì •ë¨ (ggp-ojt-v2.vercel.appë§Œ í—ˆìš©)
    // =========================================
    const GEMINI_API_KEY = "AIzaSyCvH1uc1OJ7EHmiWfsjbKVFH-X8KuvXH2I"; // Google AI Studioì—ì„œ ë°œê¸‰
    const GEMINI_MODEL = "gemini-2.0-flash-exp"; // ë¬´ë£Œ í‹°ì–´: gemini-2.0-flash-exp (ê¶Œì¥)
    const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models";

    // =========================================
    // ì„¤ì • (Cloudflare R2 ì´ë¯¸ì§€ ìŠ¤í† ë¦¬ì§€)
    // âš ï¸ Worker URLì€ ë°°í¬ í›„ ì‹¤ì œ URLë¡œ ë³€ê²½ í•„ìš”
    // =========================================
    const R2_WORKER_URL = "https://ojt-r2-upload.garimto81.workers.dev"; // Cloudflare Worker URL
    const R2_MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
    const R2_ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];

    // R2 ì´ë¯¸ì§€ ì—…ë¡œë“œ í•¨ìˆ˜
    async function uploadImageToR2(file) {
      // íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬
      if (!file) {
        throw new Error('íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
      }

      if (!R2_ALLOWED_TYPES.includes(file.type)) {
        throw new Error('í—ˆìš©ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. (JPG, PNG, GIF, WebPë§Œ ì§€ì›)');
      }

      if (file.size > R2_MAX_FILE_SIZE) {
        throw new Error('íŒŒì¼ í¬ê¸°ëŠ” 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      }

      try {
        // 1. Workerì— ì—…ë¡œë“œ URL ìš”ì²­
        const prepareRes = await fetch(R2_WORKER_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            filename: file.name,
            contentType: file.type,
            fileSize: file.size
          })
        });

        if (!prepareRes.ok) {
          const error = await prepareRes.json();
          throw new Error(error.error || 'ì—…ë¡œë“œ ì¤€ë¹„ ì‹¤íŒ¨');
        }

        const { uploadUrl, key, publicUrl } = await prepareRes.json();

        // 2. íŒŒì¼ ì—…ë¡œë“œ
        const uploadRes = await fetch(`${R2_WORKER_URL}/upload`, {
          method: 'PUT',
          headers: {
            'Content-Type': file.type,
            'X-Upload-Key': key
          },
          body: file
        });

        if (!uploadRes.ok) {
          const error = await uploadRes.json();
          throw new Error(error.error || 'íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨');
        }

        const result = await uploadRes.json();
        console.log('Image uploaded to R2:', result.url);
        return result.url;

      } catch (error) {
        console.error('R2 upload error:', error);
        throw error;
      }
    }

    // R2 ì´ë¯¸ì§€ ì‚­ì œ í•¨ìˆ˜
    async function deleteImageFromR2(imageUrl) {
      try {
        // URLì—ì„œ key ì¶”ì¶œ
        const urlParts = imageUrl.split('/');
        const key = urlParts.slice(-2).join('/'); // uploads/timestamp-random.ext

        const response = await fetch(R2_WORKER_URL, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ key })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'ì´ë¯¸ì§€ ì‚­ì œ ì‹¤íŒ¨');
        }

        console.log('Image deleted from R2:', key);
        return true;
      } catch (error) {
        console.error('R2 delete error:', error);
        return false;
      }
    }

    // =========================================
    // ì•± ì„¤ì • ìƒìˆ˜ (ë§¤ì§ ë„˜ë²„ í†µí•© ê´€ë¦¬)
    // =========================================
    const CONFIG = {
      // í•™ìŠµ ê´€ë ¨
      STEP_TIME_LIMIT: 40,          // ë¶„ (í•œ ìŠ¤í…ë‹¹ ìµœëŒ€ í•™ìŠµ ì‹œê°„)
      CHARS_PER_MINUTE: 500,        // ë¶„ë‹¹ ì½ê¸° ì†ë„ (í•œêµ­ì–´ ê¸°ì¤€)
      MAX_URL_EXTRACT_CHARS: 15000, // URL í…ìŠ¤íŠ¸ ì¶”ì¶œ ìµœëŒ€ ë¬¸ì
      QUIZ_PASS_THRESHOLD: 3,       // í€´ì¦ˆ í†µê³¼ ê¸°ì¤€ (4ë¬¸ì œ ì¤‘)
      QUIZ_QUESTIONS_PER_TEST: 4,   // í…ŒìŠ¤íŠ¸ë‹¹ í€´ì¦ˆ ë¬¸ì œ ìˆ˜
      QUIZ_TOTAL_POOL: 20,          // í€´ì¦ˆ í’€ ì „ì²´ ë¬¸ì œ ìˆ˜
      // AI ì„¤ì •
      AI_RETRY_TIMEOUT: 30000,      // AI ìƒíƒœ ì²´í¬ ê°„ê²© (ms)
      AI_TEMPERATURE: 0.3,          // Gemini ì˜¨ë„ ì„¤ì •
      AI_MAX_TOKENS: 8192,          // Gemini ìµœëŒ€ í† í°
      // ë³´ì•ˆ: í—ˆìš©ëœ OAuth Redirect ë„ë©”ì¸
      ALLOWED_ORIGINS: [
        'https://ggp-ojt-v2.vercel.app',
        'http://localhost:3000',
        'http://localhost:51544',
        'http://127.0.0.1:3000',
      ],
    };
    // ê³„ì‚°ëœ ìƒìˆ˜
    CONFIG.MAX_CHARS_PER_STEP = CONFIG.STEP_TIME_LIMIT * CONFIG.CHARS_PER_MINUTE; // 20,000ì

    // =========================================
    // ìŠ¤í… ë¶„í•  ì„¤ì • (CONFIG ì°¸ì¡°)
    // =========================================
    // í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•œ ë³„ì¹­
    const STEP_TIME_LIMIT = CONFIG.STEP_TIME_LIMIT;
    const CHARS_PER_MINUTE = CONFIG.CHARS_PER_MINUTE;
    const MAX_CHARS_PER_STEP = CONFIG.MAX_CHARS_PER_STEP;

    // ì½˜í…ì¸  ë¶„ëŸ‰ ì¶”ì • í•¨ìˆ˜
    function estimateReadingTime(text) {
      if (!text) return 0;
      const charCount = text.length;
      return Math.ceil(charCount / CONFIG.CHARS_PER_MINUTE);
    }

    // í•„ìš”í•œ ìŠ¤í… ìˆ˜ ê³„ì‚°
    function calculateRequiredSteps(text) {
      if (!text) return 1;
      const charCount = text.length;
      return Math.max(1, Math.ceil(charCount / CONFIG.MAX_CHARS_PER_STEP));
    }

    // í…ìŠ¤íŠ¸ë¥¼ ìŠ¤í…ë³„ë¡œ ë¶„í•  (ì˜ë¯¸ ë‹¨ìœ„ë¡œ ë¶„í•  ì‹œë„)
    function splitContentForSteps(text, numSteps) {
      if (!text || numSteps <= 1) return [text || ''];

      const segments = [];
      const avgLength = Math.ceil(text.length / numSteps);

      // ì¤„ë°”ê¿ˆ, ë¬¸ë‹¨, ë˜ëŠ” ë¬¸ì¥ ë‹¨ìœ„ë¡œ ë¶„í•  ì‹œë„
      const paragraphs = text.split(/\n\n+/).filter(p => p.trim().length > 0);

      if (paragraphs.length >= numSteps) {
        // ë¬¸ë‹¨ì´ ì¶©ë¶„í•˜ë©´ ë¬¸ë‹¨ ë‹¨ìœ„ë¡œ ë¶„ë°°
        const perStep = Math.ceil(paragraphs.length / numSteps);
        for (let i = 0; i < numSteps; i++) {
          const start = i * perStep;
          const end = Math.min(start + perStep, paragraphs.length);
          segments.push(paragraphs.slice(start, end).join('\n\n'));
        }
      } else {
        // ë¬¸ë‹¨ì´ ë¶€ì¡±í•˜ë©´ ê¸€ì ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ë¶„í• 
        let currentPos = 0;
        for (let i = 0; i < numSteps; i++) {
          const targetEnd = currentPos + avgLength;
          let actualEnd = targetEnd;

          // ë¬¸ì¥ ë(.!?)ì„ ì°¾ì•„ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ë¶„í• 
          if (i < numSteps - 1 && targetEnd < text.length) {
            const searchRange = text.substring(targetEnd - 100, targetEnd + 100);
            const sentenceEnd = searchRange.search(/[.!?ã€‚]\s/);
            if (sentenceEnd !== -1) {
              actualEnd = targetEnd - 100 + sentenceEnd + 2;
            }
          } else {
            actualEnd = text.length;
          }

          segments.push(text.substring(currentPos, actualEnd).trim());
          currentPos = actualEnd;
        }
      }

      // ë¹ˆ ì„¸ê·¸ë¨¼íŠ¸ í•„í„°ë§ í›„ ê°œìˆ˜ ì¬ê²€ì¦
      let validSegments = segments.filter(s => s.length > 0);

      // ì„¸ê·¸ë¨¼íŠ¸ ìˆ˜ê°€ ìš”ì²­ëœ ìŠ¤í… ìˆ˜ë³´ë‹¤ ì ìœ¼ë©´ ë³‘í•©/ê²½ê³ 
      if (validSegments.length < numSteps) {
        console.warn(`ìŠ¤í… ë¶„í•  ê²½ê³ : ìš”ì²­ ${numSteps}ê°œ, ì‹¤ì œ ${validSegments.length}ê°œ`);
        // ìµœì†Œ 1ê°œëŠ” ë³´ì¥
        if (validSegments.length === 0) {
          validSegments = [text];
        }
      }

      // ì„¸ê·¸ë¨¼íŠ¸ ìˆ˜ê°€ ìš”ì²­ëœ ìŠ¤í… ìˆ˜ë³´ë‹¤ ë§ìœ¼ë©´ ë§ˆì§€ë§‰ ì„¸ê·¸ë¨¼íŠ¸ì— ë³‘í•©
      while (validSegments.length > numSteps && validSegments.length > 1) {
        const last = validSegments.pop();
        validSegments[validSegments.length - 1] += '\n\n' + last;
      }

      return validSegments;
    }

    // =========================================
    // DB í—¬í¼ (Dexie ìºì‹œ + Supabase ë™ê¸°í™”)
    // =========================================

    // Sync Queue ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜
    const MAX_SYNC_RETRIES = 3;

    // ë™ê¸°í™” ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ í”Œë˜ê·¸
    let isSyncQueueProcessing = false;

    // ì˜¤í”„ë¼ì¸ íì— ì‘ì—… ì¶”ê°€
    const addToSyncQueue = async (table, action, data) => {
      await localDb.sync_queue.add({
        table,
        action,
        data,
        retryCount: 0,
        created_at: new Date().toISOString()
      });
    };

    // ì˜¤í”„ë¼ì¸ í ì²˜ë¦¬ (ì˜¨ë¼ì¸ ë³µê·€ ì‹œ)
    const processSyncQueue = async () => {
      // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
      if (isSyncQueueProcessing) {
        console.log('Sync queue already processing, skipping...');
        return;
      }

      isSyncQueueProcessing = true;

      try {
        const queue = await localDb.sync_queue.toArray();

        for (const item of queue) {
          try {
            if (item.action === 'upsert') {
              await supabase.from(item.table).upsert(item.data);
            } else if (item.action === 'insert') {
              await supabase.from(item.table).insert(item.data);
            } else if (item.action === 'delete') {
              await supabase.from(item.table).delete().eq('id', item.data.id);
            }
            // ì„±ê³µí•˜ë©´ íì—ì„œ ì œê±°
            await localDb.sync_queue.delete(item.id);
          } catch (e) {
            console.error('Sync queue processing failed:', e);
            // ì¬ì‹œë„ íšŸìˆ˜ ì¦ê°€
            const retryCount = (item.retryCount || 0) + 1;
            if (retryCount >= MAX_SYNC_RETRIES) {
              // ìµœëŒ€ ì¬ì‹œë„ ì´ˆê³¼ ì‹œ íì—ì„œ ì œê±° (ë°ì´í„° ì†ì‹¤ ë°©ì§€ ë¡œê·¸)
              console.error(`Sync item permanently failed after ${MAX_SYNC_RETRIES} retries:`, item);
              await localDb.sync_queue.delete(item.id);
            } else {
              // ì¬ì‹œë„ íšŸìˆ˜ ì—…ë°ì´íŠ¸
              await localDb.sync_queue.update(item.id, { retryCount });
            }
          }
        }
      } finally {
        isSyncQueueProcessing = false;
      }
    };

    // ì˜¨ë¼ì¸ ìƒíƒœ ë³€ê²½ ê°ì§€
    window.addEventListener('online', () => {
      console.log('Online - Processing sync queue...');
      processSyncQueue();
    });

    // ë‹¨ì¼ ì¡°íšŒ (ìºì‹œ ìš°ì„ , ì˜¨ë¼ì¸ ì‹œ ë™ê¸°í™”)
    // íƒ€ì„ì•„ì›ƒ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    const withTimeout = (promise, ms) => {
      const timeout = new Promise((_, reject) =>
        setTimeout(() => reject(new Error(`Timeout after ${ms}ms`)), ms)
      );
      return Promise.race([promise, timeout]);
    };

    const SUPABASE_QUERY_TIMEOUT = 10000; // 10ì´ˆ íƒ€ì„ì•„ì›ƒ

    const dbGet = async (storeName, key) => {
      // 1. ë¡œì»¬ ìºì‹œ ë¨¼ì € í™•ì¸
      let cached = await localDb[storeName].get(key);
      console.log(`dbGet(${storeName}, ${key}): cached =`, cached);

      // 2. ì˜¨ë¼ì¸ì´ë©´ Supabaseì—ì„œ ìµœì‹  ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (íƒ€ì„ì•„ì›ƒ ì ìš©)
      if (isOnline()) {
        try {
          const { data, error } = await withTimeout(
            supabase
              .from(storeName)
              .select("*")
              .eq("id", key)
              .maybeSingle(),
            SUPABASE_QUERY_TIMEOUT
          );

          console.log(`dbGet(${storeName}, ${key}): supabase response`, { data, error });

          if (error) {
            console.error(`dbGet Supabase error for ${storeName}:`, error.message, error.code);
            // Supabase ì—ëŸ¬ ë°œìƒ ì‹œ ìºì‹œ ë°ì´í„° ë°˜í™˜ (ìºì‹œ ìˆìœ¼ë©´ ì‚¬ìš©)
            return cached;
          }

          if (data) {
            // ìºì‹œ ì—…ë°ì´íŠ¸
            await localDb[storeName].put(data);
            cached = data;
          }
        } catch (e) {
          console.error("dbGet sync error:", e.message);
          // íƒ€ì„ì•„ì›ƒ ë˜ëŠ” ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ìºì‹œ ë°ì´í„° ë°˜í™˜
        }
      }

      return cached;
    };

    // ì „ì²´ ì¡°íšŒ (ìºì‹œ ë¨¼ì € ë°˜í™˜, ë°±ê·¸ë¼ìš´ë“œ ë™ê¸°í™”)
    const dbGetAll = async (storeName, filters = {}) => {
      // 1. ë¡œì»¬ ìºì‹œì—ì„œ ë¨¼ì € ì¡°íšŒ
      let cached = [];

      try {
        if (storeName === "ojt_docs") {
          let collection = localDb.ojt_docs.toCollection();
          if (filters.team) {
            collection = localDb.ojt_docs.where('team').equals(filters.team);
          }
          cached = await collection.reverse().sortBy('updated_at');
          if (filters.authorId) {
            cached = cached.filter(doc => doc.author_id === filters.authorId);
          }
        } else if (storeName === "learning_records") {
          if (filters.userId) {
            cached = await localDb.learning_records.where('user_id').equals(filters.userId).toArray();
          } else {
            cached = await localDb.learning_records.toArray();
          }
        } else {
          cached = await localDb[storeName].toArray();
        }
      } catch (e) {
        console.error("Local cache read error:", e);
      }

      // 2. ìºì‹œê°€ ë¹„ì–´ìˆê³  ì˜¨ë¼ì¸ì´ë©´ Supabaseì—ì„œ ë¨¼ì € ë™ê¸°í™” (ë™ê¸°ì  ëŒ€ê¸°)
      const cacheEmpty = cached.length === 0;

      if (isOnline()) {
        const syncToCache = async () => {
          try {
            let query = supabase.from(storeName).select("*");

            if (storeName === "ojt_docs") {
              query = query.order("created_at", { ascending: false });
              if (filters.team) query = query.eq("team", filters.team);
              if (filters.authorId) query = query.eq("author_id", filters.authorId);
            } else if (storeName === "learning_records") {
              if (filters.userId) query = query.eq("user_id", filters.userId);
            }

            const { data, error } = await query;

            if (data && !error) {
              // ìºì‹œ ë™ê¸°í™” (ì‚­ì œëœ ë°ì´í„° ì •ë¦¬)
              const remoteIds = new Set(data.map(item => item.id));

              if (!filters.team && !filters.authorId && !filters.userId) {
                // í•„í„° ì—†ëŠ” ì „ì²´ ì¡°íšŒ: ìºì‹œ ì™„ì „ êµì²´
                await localDb[storeName].clear();
              } else {
                // í•„í„° ìˆëŠ” ì¡°íšŒ: í•´ë‹¹ ì¡°ê±´ì˜ ìºì‹œ í•­ëª© ì¤‘ ì›ê²©ì— ì—†ëŠ” ê²ƒë§Œ ì‚­ì œ
                const localItems = await localDb[storeName].toArray();
                const itemsToDelete = localItems.filter(item => {
                  // í•„í„° ì¡°ê±´ì— ë§ëŠ” í•­ëª© ì¤‘ ì›ê²©ì— ì—†ëŠ” ê²ƒ
                  let matchesFilter = true;
                  if (filters.team && item.team !== filters.team) matchesFilter = false;
                  if (filters.authorId && item.author_id !== filters.authorId) matchesFilter = false;
                  if (filters.userId && item.user_id !== filters.userId) matchesFilter = false;
                  return matchesFilter && !remoteIds.has(item.id);
                });

                // ì‚­ì œëœ í•­ëª©ë“¤ ì œê±°
                if (itemsToDelete.length > 0) {
                  console.log(`Removing ${itemsToDelete.length} deleted items from cache`);
                  await Promise.all(itemsToDelete.map(item => localDb[storeName].delete(item.id)));
                }
              }

              // ì›ê²© ë°ì´í„°ë¡œ ìºì‹œ ì—…ë°ì´íŠ¸
              await localDb[storeName].bulkPut(data);
              return data;
            }
            return null;
          } catch (e) {
            console.error("Sync error:", e);
            return null;
          }
        };

        if (cacheEmpty) {
          // ìºì‹œê°€ ë¹„ì–´ìˆìœ¼ë©´ ë™ê¸°ì ìœ¼ë¡œ Supabaseì—ì„œ ê°€ì ¸ì˜¤ê¸°
          console.log(`[dbGetAll] Cache empty for ${storeName}, fetching from Supabase...`);
          const remoteData = await syncToCache();
          if (remoteData) {
            cached = remoteData;
          }
        } else {
          // ìºì‹œê°€ ìˆìœ¼ë©´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë™ê¸°í™”
          syncToCache();
        }
      }

      // ojt_docsì¸ ê²½ìš° XSS ë°©ì–´ë§Œ ì ìš© (snake_case ìœ ì§€)
      if (storeName === "ojt_docs") {
        // ğŸ” DEBUG: dbGetAll ê²°ê³¼ ê²€ì¦
        DEBUG.trackDataFlow('dbGetAll â†’ ojt_docs ë°˜í™˜', cached, {
          source: cacheEmpty ? 'Supabase' : 'LocalCache',
          filters
        });
        if (cached.length > 0) {
          DEBUG.checkFieldMapping('dbGetAll ê²°ê³¼ (ì²« ë²ˆì§¸ ë¬¸ì„œ)', cached[0], DEBUG.OJT_DOC_FIELDS);
        }
        // XSS ë°©ì–´ë§Œ ì ìš©, í•„ë“œëª… ë§¤í•‘ ì—†ìŒ (snake_case ê·¸ëŒ€ë¡œ ì‚¬ìš©)
        return cached.map(doc => sanitizeDocData(doc));
      }

      return cached;
    };

    // ìƒì„±/ìˆ˜ì • (ë¡œì»¬ ë¨¼ì €, ì˜¨ë¼ì¸ ì‹œ ë™ê¸°í™”)
    const dbPut = async (storeName, data) => {
      const now = new Date().toISOString();
      let localData = { ...data, updated_at: now };

      // Supabase í•„ë“œëª…ìœ¼ë¡œ ë³€í™˜
      if (storeName === "users") {
        localData = {
          id: data.id,
          name: data.name,
          role: data.role,
          department: data.department || null,
          updated_at: now
        };
      } else if (storeName === "ojt_docs") {
        localData = {
          id: data.id,
          title: data.title,
          team: data.team,
          step: data.step,
          sections: data.sections,
          quiz: data.quiz,
          // snake_case ìš°ì„ , camelCase fallback (í•˜ìœ„ í˜¸í™˜)
          author_id: data.author_id ?? data.authorId,
          author_name: data.author_name ?? data.author,
          estimated_minutes: data.estimated_minutes ?? data.estimatedMinutes ?? 30,
          // Source tracking fields
          source_type: data.source_type || 'manual',
          source_url: data.source_url || null,
          source_file: data.source_file || null,
          created_at: data.created_at ?? data.createdAt ?? now,
          updated_at: now
        };
      }

      // 1. ë¡œì»¬ ìºì‹œì— ì¦‰ì‹œ ì €ì¥
      await localDb[storeName].put(localData);

      // 2. ì˜¨ë¼ì¸ì´ë©´ Supabaseì— ë™ê¸°í™”
      if (isOnline()) {
        try {
          if (storeName === "users") {
            // usersëŠ” insert/update ë¶„ë¦¬
            let { error } = await supabase.from("users").insert(localData).select().single();
            if (error && error.code === "23505") {
              await supabase.from("users")
                .update({ name: localData.name, role: localData.role, department: localData.department })
                .eq("id", localData.id);
            }
          } else {
            await supabase.from(storeName).upsert(localData);
          }
        } catch (e) {
          console.error("dbPut sync error:", e);
          await addToSyncQueue(storeName, 'upsert', localData);
        }
      } else {
        await addToSyncQueue(storeName, 'upsert', localData);
      }

      return localData;
    };

    // ìƒˆ ë°ì´í„° ì¶”ê°€ (ë¡œì»¬ ë¨¼ì €, ì˜¨ë¼ì¸ ì‹œ ë™ê¸°í™”)
    const dbAdd = async (storeName, data) => {
      const now = new Date().toISOString();
      const newId = crypto.randomUUID();
      let localData = { ...data, id: newId, created_at: now, updated_at: now };

      // Supabase í•„ë“œëª…ìœ¼ë¡œ ë³€í™˜ (snake_case ìš°ì„ , camelCase fallback)
      if (storeName === "ojt_docs") {
        localData = {
          id: newId,
          title: data.title,
          team: data.team,
          step: data.step,
          sections: data.sections,
          quiz: data.quiz,
          // snake_case ìš°ì„ , camelCase fallback (í•˜ìœ„ í˜¸í™˜)
          author_id: data.author_id ?? data.authorId,
          author_name: data.author_name ?? data.author,
          estimated_minutes: data.estimated_minutes ?? data.estimatedMinutes ?? 30,
          // Source tracking fields
          source_type: data.source_type || 'manual',
          source_url: data.source_url || null,
          source_file: data.source_file || null,
          created_at: now,
          updated_at: now
        };
      } else if (storeName === "learning_records") {
        localData = {
          id: newId,
          user_id: data.userId,
          doc_id: data.docId,
          score: data.score,
          total_questions: data.totalQuestions || 4,
          passed: data.passed,
          completed_at: now
        };
      }

      // 1. ë¡œì»¬ ìºì‹œì— ì¦‰ì‹œ ì €ì¥
      await localDb[storeName].add(localData);

      // 2. ì˜¨ë¼ì¸ì´ë©´ Supabaseì— ë™ê¸°í™”
      if (isOnline()) {
        try {
          await supabase.from(storeName).insert(localData);
        } catch (e) {
          console.error("dbAdd sync error:", e);
          await addToSyncQueue(storeName, 'insert', localData);
        }
      } else {
        await addToSyncQueue(storeName, 'insert', localData);
      }

      return newId;
    };

    // ì‚­ì œ (ë¡œì»¬ ë¨¼ì €, ì˜¨ë¼ì¸ ì‹œ ë™ê¸°í™”)
    const dbDelete = async (storeName, key) => {
      // 1. ë¡œì»¬ ìºì‹œì—ì„œ ì‚­ì œ
      await localDb[storeName].delete(key);

      // 2. ì˜¨ë¼ì¸ì´ë©´ Supabaseì—ì„œ ì‚­ì œ
      if (isOnline()) {
        try {
          await supabase.from(storeName).delete().eq("id", key);
        } catch (e) {
          console.error("dbDelete sync error:", e);
          await addToSyncQueue(storeName, 'delete', { id: key });
        }
      } else {
        await addToSyncQueue(storeName, 'delete', { id: key });
      }

      return true;
    };

    // =========================================
    // Constants (íŒ€, ìŠ¤í…, ì…ë ¥ íƒ€ì…)
    // =========================================
    const TEAMS = ["ê³µí†µ (Common)", "ê°œë°œíŒ€ (Dev)", "ë””ìì¸íŒ€ (Design)", "ê¸°íšíŒ€ (PM)", "ì¸ì‚¬íŒ€ (HR)", "ì˜ì—…íŒ€ (Sales)"];
    const STEPS = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
    const QUIZ_PASS_THRESHOLD = CONFIG.QUIZ_PASS_THRESHOLD; // í•˜ìœ„ í˜¸í™˜ì„±
    const INPUT_TYPES = [
      { id: 'text', label: 'ì§ì ‘ ì…ë ¥', icon: 'text', desc: 'í…ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ì‘ì„±' },
      { id: 'url', label: 'URL', icon: 'globe', desc: 'ì›¹í˜ì´ì§€ í…ìŠ¤íŠ¸ ì¶”ì¶œ' },
      { id: 'pdf', label: 'PDF', icon: 'file', desc: 'PDF íŒŒì¼ì—ì„œ ì¶”ì¶œ' },
    ];

    // =========================================
    // Content Extraction Functions
    // =========================================

    // PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ
    async function extractPdfText(file, setProgress) {
      setProgress && setProgress("PDF ë¡œë”© ì¤‘...");
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

      let fullText = '';
      const numPages = pdf.numPages;

      for (let i = 1; i <= numPages; i++) {
        setProgress && setProgress(`PDF í˜ì´ì§€ ${i}/${numPages} ì²˜ë¦¬ ì¤‘...`);
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join(' ');
        fullText += pageText + '\n\n';
      }

      return fullText.trim();
    }

    // SSRF ë°©ì–´: URL ê²€ì¦ í•¨ìˆ˜
    function validateUrlForSSRF(urlString) {
      const BLOCKED_HOSTS = [
        'localhost', '127.0.0.1', '0.0.0.0', '::1',
        '169.254.169.254', // AWS metadata
        'metadata.google.internal', // GCP metadata
        '100.100.100.200' // Alibaba Cloud metadata
      ];

      try {
        const url = new URL(urlString);

        // í”„ë¡œí† ì½œ ê²€ì¦ (http/httpsë§Œ í—ˆìš©)
        if (!['http:', 'https:'].includes(url.protocol)) {
          throw new Error('http ë˜ëŠ” https í”„ë¡œí† ì½œë§Œ í—ˆìš©ë©ë‹ˆë‹¤.');
        }

        // ë‚´ë¶€ í˜¸ìŠ¤íŠ¸ ì°¨ë‹¨
        const hostname = url.hostname.toLowerCase();
        if (BLOCKED_HOSTS.some(blocked => hostname === blocked || hostname.endsWith('.' + blocked))) {
          throw new Error('ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ ì£¼ì†ŒëŠ” í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }

        // Private IP ë²”ìœ„ ì°¨ë‹¨ (10.x.x.x, 172.16-31.x.x, 192.168.x.x)
        const ipMatch = hostname.match(/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/);
        if (ipMatch) {
          const [_, a, b] = ipMatch.map(Number);
          if (a === 10 || (a === 172 && b >= 16 && b <= 31) || (a === 192 && b === 168) || a === 127) {
            throw new Error('Private IP ì£¼ì†ŒëŠ” í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          }
        }

        return true;
      } catch (e) {
        if (e.message.includes('Invalid URL')) {
          throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ URL í˜•ì‹ì…ë‹ˆë‹¤.');
        }
        throw e;
      }
    }

    // URL í…ìŠ¤íŠ¸ ì¶”ì¶œ (CORS í”„ë¡ì‹œ ì‚¬ìš©)
    async function extractUrlText(url, setProgress) {
      setProgress && setProgress("URL ê²€ì¦ ì¤‘...");

      // SSRF ë°©ì–´: URL ê²€ì¦
      validateUrlForSSRF(url);

      setProgress && setProgress("ì›¹í˜ì´ì§€ ê°€ì ¸ì˜¤ëŠ” ì¤‘...");

      // ì—¬ëŸ¬ CORS í”„ë¡ì‹œ ì‹œë„
      const corsProxies = [
        `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
        `https://corsproxy.io/?${encodeURIComponent(url)}`,
      ];

      let html = null;
      for (const proxyUrl of corsProxies) {
        try {
          const response = await fetch(proxyUrl);
          if (response.ok) {
            html = await response.text();
            break;
          }
        } catch (e) {
          console.log("Proxy failed:", proxyUrl);
        }
      }

      if (!html) {
        throw new Error("ì›¹í˜ì´ì§€ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. URLì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
      }

      setProgress && setProgress("í…ìŠ¤íŠ¸ ì¶”ì¶œ ì¤‘...");

      // HTMLì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ (ê°„ë‹¨í•œ íŒŒì‹±)
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');

      // ìŠ¤í¬ë¦½íŠ¸, ìŠ¤íƒ€ì¼ íƒœê·¸ ì œê±°
      const removeElements = doc.querySelectorAll('script, style, nav, footer, header, aside, noscript');
      removeElements.forEach(el => el.remove());

      // ë³¸ë¬¸ í…ìŠ¤íŠ¸ ì¶”ì¶œ (ìš°ì„ ìˆœìœ„: article > main > body)
      const article = doc.querySelector('article');
      const main = doc.querySelector('main');
      const body = doc.body;

      const targetElement = article || main || body;
      let text = targetElement ? targetElement.innerText : '';

      // ì¤‘ë³µ ê³µë°±/ì¤„ë°”ê¿ˆ ì •ë¦¬
      text = text.replace(/\s+/g, ' ').replace(/\n\s*\n/g, '\n\n').trim();

      // ìµœëŒ€ 15000ìë¡œ ì œí•œ (truncation ì •ë³´ í¬í•¨)
      const originalLength = text.length;
      const wasTruncated = text.length > CONFIG.MAX_URL_EXTRACT_CHARS;
      if (wasTruncated) {
        text = text.substring(0, CONFIG.MAX_URL_EXTRACT_CHARS) + '...\n\n[ë‚´ìš©ì´ ë„ˆë¬´ ê¸¸ì–´ ì¼ë¶€ë§Œ ì¶”ì¶œë˜ì—ˆìŠµë‹ˆë‹¤]';
      }

      // ê°ì²´ë¡œ ë°˜í™˜ (truncation ì •ë³´ í¬í•¨)
      return {
        text,
        wasTruncated,
        originalLength,
        extractedLength: wasTruncated ? CONFIG.MAX_URL_EXTRACT_CHARS : originalLength
      };
    }

    // =========================================
    // AI Logic (Google Gemini API)
    // =========================================

    // Gemini API ìƒíƒœ ì²´í¬
    async function checkAIStatus() {
      // API í‚¤ê°€ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ ì˜¨ë¼ì¸ìœ¼ë¡œ ê°„ì£¼ (ì‹¤ì œ í˜¸ì¶œ ì‹œ ê²€ì¦ë¨)
      if (GEMINI_API_KEY) {
        return {
          online: true,
          provider: 'gemini',
          model: GEMINI_MODEL
        };
      }

      return {
        online: false,
        provider: null,
        model: null
      };
    }

    // Gemini AI ìƒíƒœ ì²´í¬ í•¨ìˆ˜ ë³„ì¹­ (ê¸°ì¡´ ì½”ë“œ í˜¸í™˜ì„±)
    const checkGeminiStatus = checkAIStatus;

    // =========================================
    // AI ì‘ë‹µ íŒŒì‹± í—¬í¼ í•¨ìˆ˜ë“¤
    // =========================================

    // JSON ë¬¸ìì—´ ì •ë¦¬ (AI ì‘ë‹µì˜ ë¶ˆì™„ì „í•œ JSON ì²˜ë¦¬)
    function cleanJsonString(str) {
      // 1. ì œì–´ ë¬¸ì ì œê±° (íƒ­ê³¼ ì¤„ë°”ê¿ˆì€ ìœ ì§€)
      str = str.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '');

      // 2. JSON ë¬¸ìì—´ ë‚´ë¶€ì˜ ì‹¤ì œ ì¤„ë°”ê¿ˆì„ \\nìœ¼ë¡œ ë³€í™˜
      str = str.replace(/"([^"\\]*(\\.[^"\\]*)*)"/g, (match) => {
        return match
          .replace(/\n/g, '\\n')
          .replace(/\r/g, '\\r')
          .replace(/\t/g, '\\t');
      });

      // 3. JSON êµ¬ì¡° ë°–ì˜ ì¤„ë°”ê¿ˆ ì œê±°
      str = str.replace(/\n/g, ' ').replace(/\r/g, '');

      // 4. ì˜ëª»ëœ ìœ ë‹ˆì½”ë“œ ì´ìŠ¤ì¼€ì´í”„ ìˆ˜ì •
      str = str.replace(/\\u(?![0-9a-fA-F]{4})/g, '\\\\u');

      return str;
    }

    // AI ì‘ë‹µì—ì„œ JSON ì¶”ì¶œ (ì •ê·œì‹ í´ë°± í¬í•¨)
    function parseAIResponseToJSON(responseText) {
      // ë§ˆí¬ë‹¤ìš´ ì½”ë“œë¸”ë¡ ì œê±°
      let cleanedResponse = responseText
        .replace(/```json\s*/gi, '')
        .replace(/```\s*/g, '')
        .trim();

      // JSON ë¶€ë¶„ ì¶”ì¶œ
      const jsonMatch = cleanedResponse.match(/\{[\s\S]*\}/);
      if (!jsonMatch) {
        throw new Error("JSON í˜•ì‹ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
      }

      const jsonStr = jsonMatch[0];

      // 1ì°¨ ì‹œë„: ì •ë¦¬ í›„ íŒŒì‹±
      try {
        return JSON.parse(cleanJsonString(jsonStr));
      } catch (parseError) {
        console.warn("JSON íŒŒì‹± ì‹¤íŒ¨, regex fallback ì‹œë„:", parseError.message);
      }

      // 2ì°¨ ì‹œë„: ì •ê·œì‹ìœ¼ë¡œ í•„ë“œ ì¶”ì¶œ
      const titleMatch = cleanedResponse.match(/"title"\s*:\s*"([^"]+)"/);
      const title = titleMatch ? titleMatch[1] : "ìƒì„±ëœ ë¬¸ì„œ";

      const sections = [];
      const sectionRegex = /\{\s*"title"\s*:\s*"([^"]+)"\s*,\s*"content"\s*:\s*"([^"]+)"\s*\}/g;
      const sectionsArrayMatch = cleanedResponse.match(/"sections"\s*:\s*\[([\s\S]*?)\]/);
      if (sectionsArrayMatch) {
        let sectionMatch;
        while ((sectionMatch = sectionRegex.exec(sectionsArrayMatch[1])) !== null) {
          sections.push({ title: sectionMatch[1], content: sectionMatch[2] });
        }
      }

      const quiz = [];
      const quizArrayMatch = cleanedResponse.match(/"quiz"\s*:\s*\[([\s\S]*?)\]/);
      if (quizArrayMatch) {
        const quizRegex = /\{\s*"id"\s*:\s*(\d+)\s*,\s*"question"\s*:\s*"([^"]+)"\s*,\s*"options"\s*:\s*\[([^\]]+)\]\s*,\s*"answer"\s*:\s*(\d+)\s*\}/g;
        let quizMatch;
        while ((quizMatch = quizRegex.exec(quizArrayMatch[1])) !== null) {
          const options = quizMatch[3].match(/"([^"]+)"/g)?.map(o => o.replace(/"/g, '')) || [];
          quiz.push({
            id: parseInt(quizMatch[1]),
            question: quizMatch[2],
            options,
            answer: parseInt(quizMatch[4])
          });
        }
      }

      if (sections.length === 0 && quiz.length === 0) {
        throw new Error('AI ì‘ë‹µì„ íŒŒì‹±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }

      console.warn("regex fallbackìœ¼ë¡œ íŒŒì‹± ì™„ë£Œ");
      return {
        title,
        sections: sections.length > 0 ? sections : [{ title: "ë‚´ìš©", content: "AI ì‘ë‹µì—ì„œ ì„¹ì…˜ì„ íŒŒì‹±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤." }],
        quiz
      };
    }

    // OJT ê²°ê³¼ ê²€ì¦ ë° í€´ì¦ˆ ë³´ì¶©
    function validateAndFillOJTResult(result, docTitle) {
      const validationErrors = [];

      // ì„¹ì…˜ ê²€ì¦
      if (!Array.isArray(result.sections) || result.sections.length === 0) {
        validationErrors.push('ì„¹ì…˜ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
        result.sections = [{ title: "ë‚´ìš© ì—†ìŒ", content: "AIê°€ ì„¹ì…˜ì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤." }];
      }

      // í€´ì¦ˆ ë°°ì—´ ê²€ì¦
      if (!Array.isArray(result.quiz)) {
        result.quiz = [];
      }

      const originalQuizCount = result.quiz.length;

      // í€´ì¦ˆ ìˆ˜ í™•ì¸
      if (originalQuizCount < CONFIG.QUIZ_QUESTIONS_PER_TEST) {
        validationErrors.push(`í€´ì¦ˆê°€ ${originalQuizCount}ê°œë§Œ ìƒì„±ë¨ (ìµœì†Œ ${CONFIG.QUIZ_QUESTIONS_PER_TEST}ê°œ í•„ìš”)`);
      }

      // 20ê°œ ë¯¸ë§Œì´ë©´ ë”ë¯¸ë¡œ ì±„ìš°ê¸°
      while (result.quiz.length < CONFIG.QUIZ_TOTAL_POOL) {
        const quizNum = result.quiz.length + 1;
        result.quiz.push({
          id: quizNum,
          question: `[ìë™ ìƒì„±] ${docTitle || 'ë¬¸ì„œ'} ë³µìŠµ ë¬¸ì œ ${quizNum}`,
          options: [
            "ë³¸ë¬¸ì—ì„œ ì„¤ëª…í•œ í•µì‹¬ ë‚´ìš©ì„ ì„ íƒí•˜ì„¸ìš”",
            "ì´ ì„ ì§€ëŠ” ì˜¤ë‹µì…ë‹ˆë‹¤ (A)",
            "ì´ ì„ ì§€ëŠ” ì˜¤ë‹µì…ë‹ˆë‹¤ (B)",
            "ì´ ì„ ì§€ëŠ” ì˜¤ë‹µì…ë‹ˆë‹¤ (C)"
          ],
          answer: 0,
          isAutoGenerated: true
        });
      }

      // ë©”íƒ€ë°ì´í„° ì¶”ê°€
      result._parseInfo = {
        originalQuizCount,
        autoGeneratedQuizCount: CONFIG.QUIZ_TOTAL_POOL - originalQuizCount,
        validationErrors,
        parsedAt: new Date().toISOString()
      };

      if (validationErrors.length > 0) {
        console.warn('AI íŒŒì‹± ê²½ê³ :', validationErrors.join(', '));
      }

      return result;
    }

    // =========================================
    // AI ì½˜í…ì¸  ìƒì„± ë©”ì¸ í•¨ìˆ˜
    // =========================================
    async function generateOJTContent(rawText, team, step, setProgress, totalSteps = 1) {
      const stepInfo = totalSteps > 1 ? ` (ì´ ${totalSteps}ê°œ ìŠ¤í… ì¤‘ ${step}ë²ˆì§¸ ìŠ¤í…)` : '';
      const prompt = `/no_think
ë‹¹ì‹ ì€ 10ë…„ ê²½ë ¥ì˜ ê¸°ì—… êµìœ¡ ì„¤ê³„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë¹„ì •í˜• ì—…ë¬´ ë©”ëª¨ë¥¼ ì²´ê³„ì ì¸ ì‹ ì…ì‚¬ì› OJT ìë£Œë¡œ ë³€í™˜í•˜ëŠ” ê²ƒì´ ì „ë¬¸ ë¶„ì•¼ì…ë‹ˆë‹¤.

## ì‘ì—… ìš”ì²­
ì•„ë˜ [ì…ë ¥ í…ìŠ¤íŠ¸]ë¥¼ ${team} ë¶€ì„œ ì‹ ì…ì‚¬ì›ì„ ìœ„í•œ Step ${step}${stepInfo} OJT êµìœ¡ ìë£Œë¡œ ë³€í™˜í•´ì£¼ì„¸ìš”.

## ì½˜í…ì¸  ì‘ì„± ê°€ì´ë“œë¼ì¸

### 1. ì„¹ì…˜ êµ¬ì„± ì›ì¹™ (3-5ê°œ ì„¹ì…˜)
ê° ì„¹ì…˜ì€ ë‹¤ìŒ êµ¬ì¡°ë¥¼ ë”°ë¥´ì„¸ìš”:
- **í•™ìŠµ ëª©í‘œ**: ì´ ì„¹ì…˜ì„ í†µí•´ ë¬´ì—‡ì„ ë°°ìš¸ ìˆ˜ ìˆëŠ”ì§€ í•œ ë¬¸ì¥ìœ¼ë¡œ
- **í•µì‹¬ ë‚´ìš©**: ì‹ ì…ì‚¬ì›ì´ ë°˜ë“œì‹œ ì•Œì•„ì•¼ í•  ë‚´ìš© (êµ¬ì²´ì  ì ˆì°¨, ê·œì¹™, ìš©ì–´ ì„¤ëª…)
- **ì‹¤ë¬´ ì˜ˆì‹œ**: ì‹¤ì œ ì—…ë¬´ì—ì„œ ì–´ë–»ê²Œ ì ìš©ë˜ëŠ”ì§€ êµ¬ì²´ì  ìƒí™© ì˜ˆì‹œ
- **ì£¼ì˜ì‚¬í•­**: ì‹ ì…ì‚¬ì›ì´ ìì£¼ ì‹¤ìˆ˜í•˜ëŠ” ë¶€ë¶„, ì£¼ì˜í•  ì 

### 2. ê¸€ì“°ê¸° í’ˆì§ˆ ê¸°ì¤€
- ëª¨í˜¸í•œ í‘œí˜„ ê¸ˆì§€: "ì ì ˆíˆ", "í•„ìš”ì— ë”°ë¼" ëŒ€ì‹  êµ¬ì²´ì  ê¸°ì¤€ ì œì‹œ
- ì „ë¬¸ ìš©ì–´ëŠ” ì²« ë“±ì¥ ì‹œ ê´„í˜¸ ì•ˆì— ì„¤ëª… ì¶”ê°€
- ìˆœì„œê°€ ìˆëŠ” ì‘ì—…ì€ ë²ˆí˜¸ ë§¤ê¸°ê¸° ì‚¬ìš©
- í•œ ë¬¸ë‹¨ì€ 3-4ë¬¸ì¥, í•œ ì„¹ì…˜ì€ 400-800ì

### 3. í€´ì¦ˆ ì„¤ê³„ ì›ì¹™ (ì •í™•íˆ 20ë¬¸ì œ)
ë¬¸ì œ ìœ í˜• ë°°ë¶„:
- ê¸°ì–µí˜• (40%): ìš©ì–´, ì ˆì°¨, ê·œì¹™ì„ ì •í™•íˆ ê¸°ì–µí•˜ëŠ”ì§€ í™•ì¸
- ì´í•´í˜• (35%): ì™œ ê·¸ë ‡ê²Œ í•˜ëŠ”ì§€ ì´ìœ ë¥¼ ì´í•´í–ˆëŠ”ì§€ í™•ì¸
- ì ìš©í˜• (25%): ì‹¤ì œ ìƒí™©ì—ì„œ ì–´ë–»ê²Œ ì ìš©í• ì§€ íŒë‹¨

í€´ì¦ˆ í’ˆì§ˆ ê¸°ì¤€:
- ì§ˆë¬¸ì€ ëª…í™•í•˜ê³  êµ¬ì²´ì ìœ¼ë¡œ (ë¬´ì—‡ì„, ì–¸ì œ, ì–´ë–»ê²Œ)
- ì •ë‹µì€ ë³¸ë¬¸ ë‚´ìš©ì— ê·¼ê±°í•´ì•¼ í•¨
- ì˜¤ë‹µ ì„ ì§€ëŠ” ê·¸ëŸ´ë“¯í•˜ì§€ë§Œ ëª…í™•íˆ í‹€ë¦° ë‚´ìš© (í”í•œ ì˜¤í•´ ë°˜ì˜)
- ëª¨ë“  ì„ ì§€ ê¸¸ì´ëŠ” ë¹„ìŠ·í•˜ê²Œ ìœ ì§€

## ì…ë ¥ í…ìŠ¤íŠ¸
${rawText}

## ì¶œë ¥ í˜•ì‹
ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. JSON ì™¸ ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì—†ì´ ì¶œë ¥í•˜ì„¸ìš”:

{
  "title": "ëª…í™•í•˜ê³  êµ¬ì²´ì ì¸ ë¬¸ì„œ ì œëª©",
  "estimatedMinutes": 25,
  "sections": [
    {
      "title": "1. ì„¹ì…˜ ì œëª©",
      "content": "**í•™ìŠµ ëª©í‘œ**: ...\\n\\n**í•µì‹¬ ë‚´ìš©**:\\n...\\n\\n**ì‹¤ë¬´ ì˜ˆì‹œ**:\\n...\\n\\n**ì£¼ì˜ì‚¬í•­**:\\n..."
    }
  ],
  "quiz": [
    {
      "id": 1,
      "question": "êµ¬ì²´ì ì¸ ì§ˆë¬¸ ë‚´ìš©?",
      "options": ["ì„ ì§€A (20ì ë‚´ì™¸)", "ì„ ì§€B (20ì ë‚´ì™¸)", "ì„ ì§€C (20ì ë‚´ì™¸)", "ì„ ì§€D (20ì ë‚´ì™¸)"],
      "answer": 0
    }
  ]
}

## ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ì„¹ì…˜ 3-5ê°œ, ê° ì„¹ì…˜ 400-800ì
- [ ] í€´ì¦ˆ ì •í™•íˆ 20ê°œ
- [ ] answerëŠ” ì •ë‹µ ì¸ë±ìŠ¤ (0, 1, 2, 3 ì¤‘ í•˜ë‚˜)
- [ ] estimatedMinutesëŠ” 40 ì´í•˜
- [ ] JSON ë¬¸ë²• ì˜¤ë¥˜ ì—†ìŒ`;

      try {
        // Gemini API í˜¸ì¶œ
        setProgress && setProgress("Gemini AI ì—°ê²° ì¤‘...");

        const geminiPrompt = prompt.replace('/no_think\n', ''); // GeminiëŠ” /no_think ë¶ˆí•„ìš”

        const response = await fetch(
          `${GEMINI_API_URL}/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{
                parts: [{ text: geminiPrompt }]
              }],
              generationConfig: {
                temperature: 0.3,
                maxOutputTokens: 8192
              }
            })
          }
        );

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(`Gemini API ì˜¤ë¥˜: ${response.status} - ${errorData.error?.message || ''}`);
        }

        setProgress && setProgress("Gemini AI ì‘ë‹µ ì²˜ë¦¬ ì¤‘...");
        const data = await response.json();

        // Gemini ì‘ë‹µ êµ¬ì¡°ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
        const responseText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
        console.log("Gemini raw response:", responseText.substring(0, 500));

        // AI ì‘ë‹µ íŒŒì‹± (í—¬í¼ í•¨ìˆ˜ ì‚¬ìš©)
        let result = parseAIResponseToJSON(responseText);

        // ê²°ê³¼ ê²€ì¦ ë° í€´ì¦ˆ ë³´ì¶© (í—¬í¼ í•¨ìˆ˜ ì‚¬ìš©)
        result = validateAndFillOJTResult(result, result.title);

        return result;

      } catch (error) {
        console.error("AI Generation Error:", error);

        // Graceful Degradation: AI ì‹¤íŒ¨ ì‹œ ì›ë¬¸ ê¸°ë°˜ fallback
        setProgress && setProgress("AI ë¶„ì„ ì‹¤íŒ¨ - ì›ë¬¸ìœ¼ë¡œ ë“±ë¡ ì¤‘...");

        // HTML íƒœê·¸ ê²€ì‚¬
        const isHtml = /<[a-z][\s\S]*>/i.test(rawText);
        let formattedContent = rawText;

        if (!isHtml) {
          // í”Œë ˆì¸ í…ìŠ¤íŠ¸ë¥¼ HTML ë¬¸ë‹¨ìœ¼ë¡œ ë³€í™˜
          formattedContent = rawText
            .split(/\n\n+/)
            .filter(p => p.trim())
            .map(p => `<p>${p.trim().replace(/\n/g, '<br>')}</p>`)
            .join('\n');
        }

        // DOMPurifyë¡œ XSS ë°©ì–´
        const sanitizedContent = DOMPurify.sanitize(formattedContent, {
          ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'ul', 'ol', 'li', 'h1', 'h2', 'h3', 'h4', 'a', 'pre', 'code'],
          ALLOWED_ATTR: ['href', 'target']
        });

        return {
          title: "í•™ìŠµ ìë£Œ",
          estimatedMinutes: 15,
          sections: [{
            title: 'ì›ë¬¸ ë‚´ìš©',
            content: sanitizedContent
          }],
          quiz: [],
          ai_processed: false,
          ai_error: error.message
        };
      }
    }

    // =========================================
    // AI í€´ì¦ˆ ìƒì„± (URL Context Tool ì‚¬ìš©)
    // URL ë˜ëŠ” PDFì—ì„œ ì§ì ‘ í€´ì¦ˆë§Œ ìƒì„±
    // =========================================
    async function generateQuizWithUrlContext(sourceUrl, sourceType, setProgress) {
      const contentTypeLabel = sourceType === 'pdf' ? 'PDF ë¬¸ì„œ' : 'ì›¹í˜ì´ì§€';

      const prompt = `ë‹¹ì‹ ì€ 10ë…„ ê²½ë ¥ì˜ ê¸°ì—… êµìœ¡ ì„¤ê³„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

## ì‘ì—… ìš”ì²­
ë‹¤ìŒ ${contentTypeLabel}ë¥¼ ë¶„ì„í•˜ê³  ì‹ ì…ì‚¬ì› í•™ìŠµìš© í€´ì¦ˆë¥¼ ìƒì„±í•˜ì„¸ìš”.

URL: ${sourceUrl}

## í€´ì¦ˆ ì„¤ê³„ ì›ì¹™ (ì •í™•íˆ 20ë¬¸ì œ)
ë¬¸ì œ ìœ í˜• ë°°ë¶„:
- ê¸°ì–µí˜• (40%): ìš©ì–´, ì ˆì°¨, ê·œì¹™ì„ ì •í™•íˆ ê¸°ì–µí•˜ëŠ”ì§€ í™•ì¸
- ì´í•´í˜• (35%): ì™œ ê·¸ë ‡ê²Œ í•˜ëŠ”ì§€ ì´ìœ ë¥¼ ì´í•´í–ˆëŠ”ì§€ í™•ì¸
- ì ìš©í˜• (25%): ì‹¤ì œ ìƒí™©ì—ì„œ ì–´ë–»ê²Œ ì ìš©í• ì§€ íŒë‹¨

í€´ì¦ˆ í’ˆì§ˆ ê¸°ì¤€:
- ì§ˆë¬¸ì€ ëª…í™•í•˜ê³  êµ¬ì²´ì ìœ¼ë¡œ (ë¬´ì—‡ì„, ì–¸ì œ, ì–´ë–»ê²Œ)
- ì •ë‹µì€ ë¬¸ì„œ ë‚´ìš©ì— ê·¼ê±°í•´ì•¼ í•¨
- ì˜¤ë‹µ ì„ ì§€ëŠ” ê·¸ëŸ´ë“¯í•˜ì§€ë§Œ ëª…í™•íˆ í‹€ë¦° ë‚´ìš© (í”í•œ ì˜¤í•´ ë°˜ì˜)
- ëª¨ë“  ì„ ì§€ ê¸¸ì´ëŠ” ë¹„ìŠ·í•˜ê²Œ ìœ ì§€

## ì¶œë ¥ í˜•ì‹
ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. JSON ì™¸ ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì—†ì´ ì¶œë ¥í•˜ì„¸ìš”:

{
  "title": "ë¬¸ì„œ ì œëª© (ìë™ ì¶”ì¶œ)",
  "estimatedMinutes": 15,
  "quiz": [
    {
      "id": 1,
      "question": "êµ¬ì²´ì ì¸ ì§ˆë¬¸ ë‚´ìš©?",
      "options": ["ì„ ì§€A (20ì ë‚´ì™¸)", "ì„ ì§€B (20ì ë‚´ì™¸)", "ì„ ì§€C (20ì ë‚´ì™¸)", "ì„ ì§€D (20ì ë‚´ì™¸)"],
      "answer": 0
    }
  ]
}

## ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] í€´ì¦ˆ ì •í™•íˆ 20ê°œ
- [ ] answerëŠ” ì •ë‹µ ì¸ë±ìŠ¤ (0, 1, 2, 3 ì¤‘ í•˜ë‚˜)
- [ ] estimatedMinutesëŠ” 40 ì´í•˜
- [ ] JSON ë¬¸ë²• ì˜¤ë¥˜ ì—†ìŒ`;

      try {
        setProgress && setProgress("Gemini AIê°€ ì›ë¬¸ì„ ë¶„ì„ ì¤‘...");

        const response = await fetch(
          `${GEMINI_API_URL}/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{
                parts: [{ text: prompt }]
              }],
              tools: [{ urlContext: {} }],  // URL Context Tool í™œì„±í™”
              generationConfig: {
                temperature: 0.3,
                maxOutputTokens: 8192
              }
            })
          }
        );

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(`Gemini API ì˜¤ë¥˜: ${response.status} - ${errorData.error?.message || ''}`);
        }

        setProgress && setProgress("í€´ì¦ˆ ì‘ë‹µ ì²˜ë¦¬ ì¤‘...");
        const data = await response.json();

        // Gemini ì‘ë‹µ êµ¬ì¡°ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
        const responseText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
        console.log("Gemini URL Context response:", responseText.substring(0, 500));

        // AI ì‘ë‹µ íŒŒì‹± (í—¬í¼ í•¨ìˆ˜ ì‚¬ìš©)
        let result = parseAIResponseToJSON(responseText);

        // ê²°ê³¼ ê²€ì¦ ë° í€´ì¦ˆ ë³´ì¶© (í—¬í¼ í•¨ìˆ˜ ì‚¬ìš©)
        result = validateAndFillOJTResult(result, result.title);

        return result;

      } catch (error) {
        console.error("URL Context AI Error:", error);

        // Graceful Degradation: AI ì‹¤íŒ¨ ì‹œ fallback ë°˜í™˜
        setProgress && setProgress("AI ë¶„ì„ ì‹¤íŒ¨ - ì›ë¬¸ìœ¼ë¡œ ë“±ë¡ ì¤‘...");

        return {
          title: `${contentTypeLabel} í•™ìŠµ ìë£Œ`,
          estimatedMinutes: 15,
          quiz: [],
          ai_processed: false,
          ai_error: error.message
        };
      }
    }

    // =========================================
    // PDF R2 ì—…ë¡œë“œ í•¨ìˆ˜
    // =========================================
    async function uploadPdfToR2(file) {
      // íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬
      if (!file) {
        throw new Error('íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
      }

      if (file.type !== 'application/pdf') {
        throw new Error('PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤');
      }

      if (file.size > R2_MAX_FILE_SIZE) {
        throw new Error('íŒŒì¼ í¬ê¸°ëŠ” 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      }

      try {
        // 1. Workerì— ì—…ë¡œë“œ URL ìš”ì²­
        const prepareRes = await fetch(R2_WORKER_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            filename: file.name,
            contentType: 'application/pdf',
            fileSize: file.size
          })
        });

        if (!prepareRes.ok) {
          const error = await prepareRes.json();
          throw new Error(error.error || 'PDF ì—…ë¡œë“œ ì¤€ë¹„ ì‹¤íŒ¨');
        }

        const { key, publicUrl } = await prepareRes.json();

        // 2. ì‹¤ì œ íŒŒì¼ ì—…ë¡œë“œ
        const uploadRes = await fetch(`${R2_WORKER_URL}/upload`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/pdf',
            'X-Upload-Key': key
          },
          body: file
        });

        if (!uploadRes.ok) {
          const error = await uploadRes.json();
          throw new Error(error.error || 'PDF ì—…ë¡œë“œ ì‹¤íŒ¨');
        }

        const result = await uploadRes.json();
        console.log('PDF uploaded to R2:', result.url);

        return result.url;

      } catch (error) {
        console.error('PDF R2 upload error:', error);
        throw error;
      }
    }

    // =========================================
    // Main App
    // =========================================
    function App() {
      // User State
      const [user, setUser] = useState(null);
      const [isLoadingAuth, setIsLoadingAuth] = useState(true);

      // AI Status (Gemini)
      const [aiStatus, setAiStatus] = useState({ online: false, provider: null, model: null });
      const [showSettings, setShowSettings] = useState(false);

      // App State
      const [viewState, _setViewState] = useState('loading');

      // ğŸ” DEBUG: viewState ë³€ê²½ ì¶”ì  ë˜í¼
      const setViewState = (newState) => {
        DEBUG.trackStateChange('viewState', viewState, newState, new Error().stack?.split('\n')[2]?.trim());
        _setViewState(newState);
      };

      // Admin Mode Switch (ì„ì‹œ ëª¨ë“œ ì „í™˜)
      const [sessionMode, setSessionMode] = useState(null); // 'admin' | 'mentor' | null
      const [showModeMenu, setShowModeMenu] = useState(false);
      // ì„±ëŠ¥ ìµœì í™”: displayRoleì„ useMemoë¡œ ìºì‹±
      const displayRole = useMemo(() => sessionMode || user?.role, [sessionMode, user?.role]);

      // Mentor State
      const [inputType, setInputType] = useState('text'); // 'text', 'url', 'pdf'
      const [inputTitle, setInputTitle] = useState('');
      const [rawInput, setRawInput] = useState('');
      const [urlInput, setUrlInput] = useState('');
      const [pdfFile, setPdfFile] = useState(null);
      // Quill Editor
      const quillRef = useRef(null);
      const quillInstanceRef = useRef(null);
      const [inputTeam, setInputTeam] = useState(TEAMS[0]);
      const [inputStep, setInputStep] = useState(1);
      const [isCustomTeam, setIsCustomTeam] = useState(false);
      const [isCustomStep, setIsCustomStep] = useState(false);
      const [isProcessing, setIsProcessing] = useState(false);
      const [processingStatus, setProcessingStatus] = useState('');
      const [generatedDoc, setGeneratedDoc] = useState(null);
      const [generatedDocs, setGeneratedDocs] = useState([]); // ë¶„í• ëœ ì—¬ëŸ¬ ë¬¸ì„œ
      const [myDocs, setMyDocs] = useState([]);
      const [editingDoc, setEditingDoc] = useState(null); // í¸ì§‘ ì¤‘ì¸ ë¬¸ì„œ
      const [autoSplit, setAutoSplit] = useState(true); // ìë™ ìŠ¤í… ë¶„í•  ì˜µì…˜
      // ì„±ëŠ¥ ìµœì í™”: ì˜ˆìƒ í•™ìŠµ ì‹œê°„/ìŠ¤í… ìˆ˜ë¥¼ useMemoë¡œ ê³„ì‚° (ë¶ˆí•„ìš”í•œ state ì—…ë°ì´íŠ¸ ë°©ì§€)
      const estimatedTime = useMemo(() => rawInput ? estimateReadingTime(rawInput) : 0, [rawInput]);
      const requiredSteps = useMemo(() => rawInput ? calculateRequiredSteps(rawInput) : 1, [rawInput]);
      const [editorTab, setEditorTab] = useState('edit'); // 'edit' | 'preview' - íƒ­ ê¸°ë°˜ ë ˆì´ì•„ì›ƒ
      const [showQuizPreview, setShowQuizPreview] = useState(false); // í€´ì¦ˆ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬
      const [quizEditMode, setQuizEditMode] = useState(false); // í€´ì¦ˆ í¸ì§‘ ëª¨ë“œ
      const [editingQuizIndex, setEditingQuizIndex] = useState(null); // í¸ì§‘ ì¤‘ì¸ í€´ì¦ˆ ì¸ë±ìŠ¤

      // Mentee State
      const [publicDocs, setPublicDocs] = useState([]);
      const [selectedTeam, setSelectedTeam] = useState(null);
      const [selectedDoc, setSelectedDoc] = useState(null);

      // Quiz State
      const [quizMode, setQuizMode] = useState(false);
      const [activeQuizSet, setActiveQuizSet] = useState([]);
      const [currentQuizIndex, setCurrentQuizIndex] = useState(0);
      const [selectedAnswers, setSelectedAnswers] = useState({});
      const [quizSubmitted, setQuizSubmitted] = useState(false);
      const [score, setScore] = useState(0);
      const [passed, setPassed] = useState(false);

      // =========================================
      // Effects
      // =========================================

      // AI ìƒíƒœ ì²´í¬ (Gemini) - ì•± ì‹œì‘ ì‹œ 1íšŒë§Œ
      useEffect(() => {
        const checkStatus = async () => {
          const status = await checkGeminiStatus();
          setAiStatus(status);
        };
        checkStatus();
      }, []);

      // Admin ëª¨ë“œ ì „í™˜ ìƒíƒœ ë³µì› (sessionStorage)
      useEffect(() => {
        const stored = SecureSession.get('ojt_sessionMode');
        if (stored && ['admin', 'mentor'].includes(stored)) {
          setSessionMode(stored);
        }
      }, []);

      // ëª¨ë“œ ë©”ë‰´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
      useEffect(() => {
        const handleClickOutside = (e) => {
          if (showModeMenu && !e.target.closest('.mode-menu-container')) {
            setShowModeMenu(false);
          }
        };
        document.addEventListener('click', handleClickOutside);
        return () => document.removeEventListener('click', handleClickOutside);
      }, [showModeMenu]);

      // ì…ë ¥ ë‚´ìš© ë³€ê²½ ì‹œ ì˜ˆìƒ í•™ìŠµ ì‹œê°„/ìŠ¤í… ìˆ˜ëŠ” useMemoë¡œ ê³„ì‚°ë¨ (ìœ„ì˜ estimatedTime, requiredSteps)

      // ì´ë¯¸ì§€ ì—…ë¡œë“œ ìƒíƒœ
      const [isUploadingImage, setIsUploadingImage] = useState(false);

      // Quill ì»¤ìŠ¤í…€ ì´ë¯¸ì§€ í•¸ë“¤ëŸ¬
      const handleQuillImageUpload = async () => {
        const input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.setAttribute('accept', 'image/jpeg,image/png,image/gif,image/webp');
        input.click();

        input.onchange = async () => {
          const file = input.files[0];
          if (!file) return;

          setIsUploadingImage(true);
          try {
            const imageUrl = await uploadImageToR2(file);

            // Quillì— ì´ë¯¸ì§€ ì‚½ì…
            const quill = quillInstanceRef.current;
            if (quill) {
              const range = quill.getSelection(true);
              quill.insertEmbed(range.index, 'image', imageUrl);
              quill.setSelection(range.index + 1);
            }
          } catch (error) {
            Toast.error(`ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
          } finally {
            setIsUploadingImage(false);
          }
        };
      };

      // Quill ë“œë˜ê·¸&ë“œë¡­/ë¶™ì—¬ë„£ê¸° ì´ë¯¸ì§€ ì²˜ë¦¬
      const handleQuillImageDrop = async (file) => {
        if (!R2_ALLOWED_TYPES.includes(file.type)) {
          Toast.error('í—ˆìš©ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. (JPG, PNG, GIF, WebPë§Œ ì§€ì›)');
          return;
        }

        setIsUploadingImage(true);
        try {
          const imageUrl = await uploadImageToR2(file);

          const quill = quillInstanceRef.current;
          if (quill) {
            const range = quill.getSelection(true);
            quill.insertEmbed(range.index, 'image', imageUrl);
            quill.setSelection(range.index + 1);
          }
        } catch (error) {
          Toast.error(`ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
        } finally {
          setIsUploadingImage(false);
        }
      };

      // Quill ì—ë””í„° ì´ˆê¸°í™”
      useEffect(() => {
        if (inputType === 'text' && quillRef.current && !quillInstanceRef.current) {
          // Quill ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
          quillInstanceRef.current = new Quill(quillRef.current, {
            theme: 'snow',
            placeholder: 'êµìœ¡ ë‚´ìš©ì„ ììœ ë¡­ê²Œ ì…ë ¥í•˜ì„¸ìš”...\n\nâ€¢ ì„œì‹ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì œëª©, ëª©ë¡, ê°•ì¡° ë“±ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤\nâ€¢ Ctrl+B: êµµê²Œ, Ctrl+I: ê¸°ìš¸ì„, Ctrl+U: ë°‘ì¤„\nâ€¢ ì´ë¯¸ì§€: íˆ´ë°” ë²„íŠ¼ ë˜ëŠ” ë“œë˜ê·¸&ë“œë¡­/ë¶™ì—¬ë„£ê¸°',
            modules: {
              toolbar: {
                container: [
                  [{ 'header': [1, 2, 3, false] }],
                  ['bold', 'italic', 'underline', 'strike'],
                  [{ 'color': [] }, { 'background': [] }],
                  [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                  [{ 'indent': '-1'}, { 'indent': '+1' }],
                  ['blockquote', 'code-block'],
                  ['link', 'image'],
                  ['clean']
                ],
                handlers: {
                  image: handleQuillImageUpload
                }
              }
            }
          });

          // í…ìŠ¤íŠ¸ ë³€ê²½ ì‹œ rawInput ì—…ë°ì´íŠ¸
          quillInstanceRef.current.on('text-change', () => {
            const text = quillInstanceRef.current.getText().trim();
            setRawInput(text);
          });

          // ë“œë˜ê·¸&ë“œë¡­ ì´ë¯¸ì§€ ì²˜ë¦¬
          const editorContainer = quillRef.current.querySelector('.ql-editor');
          if (editorContainer) {
            editorContainer.addEventListener('drop', async (e) => {
              e.preventDefault();
              editorContainer.classList.remove('drag-over');
              const files = e.dataTransfer?.files;
              if (files && files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                  await handleQuillImageDrop(file);
                }
              }
            });

            editorContainer.addEventListener('dragover', (e) => {
              e.preventDefault();
              editorContainer.classList.add('drag-over');
            });

            editorContainer.addEventListener('dragleave', (e) => {
              e.preventDefault();
              editorContainer.classList.remove('drag-over');
            });

            // ë¶™ì—¬ë„£ê¸° ì´ë¯¸ì§€ ì²˜ë¦¬
            editorContainer.addEventListener('paste', async (e) => {
              const items = e.clipboardData?.items;
              if (items) {
                for (let i = 0; i < items.length; i++) {
                  if (items[i].type.startsWith('image/')) {
                    e.preventDefault();
                    const file = items[i].getAsFile();
                    if (file) {
                      await handleQuillImageDrop(file);
                    }
                    break;
                  }
                }
              }
            });
          }

          // í¸ì§‘ ëª¨ë“œì¸ ê²½ìš° ê¸°ì¡´ ë‚´ìš© ë¡œë“œ (Quill ë§ˆìš´íŠ¸ í›„)
          if (editingDoc && editingDoc.sections && editingDoc.sections.length > 0) {
            const contentText = editingDoc.sections.map(section => {
              let text = `## ${section.title}\n\n`;
              if (section.content) {
                text += section.content + '\n\n';
              }
              return text;
            }).join('');
            quillInstanceRef.current.setText(contentText);
            console.log('Quill: loaded editingDoc content on mount');
          }
        }

        // ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€: Quill ì¸ìŠ¤í„´ìŠ¤ ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
        return () => {
          if (quillInstanceRef.current) {
            // Quill ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í•´ì œ
            quillInstanceRef.current.off('text-change');

            // ì—ë””í„° DOM ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” ìš”ì†Œ ì œê±° ì‹œ ìë™ ì •ë¦¬ë¨
            // ë‹¨, ì¸ìŠ¤í„´ìŠ¤ ì°¸ì¡°ëŠ” ëª…ì‹œì ìœ¼ë¡œ í•´ì œ
            if (inputType !== 'text') {
              quillInstanceRef.current = null;
            }
          }
        };
      }, [inputType, viewState, editingDoc]);

      // ì—­í•  ê¸°ë°˜ ë·° ìƒíƒœ ê²°ì • í—¬í¼
      const getViewStateByRole = (role, tempMode = null) => {
        const roleViewMap = {
          admin: 'admin_dashboard',
          mentor: 'mentor_dashboard',
          mentee: 'mentee_list'
        };

        // Adminì´ Mentor ëª¨ë“œë¡œ ì „í™˜ëœ ê²½ìš°
        if (role === 'admin' && tempMode === 'mentor') {
          return 'mentor_dashboard';
        }

        return roleViewMap[role] || 'role_select';
      };

      // ì„¸ì…˜ì—ì„œ ê¸°ë³¸ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ í—¬í¼
      const extractUserFromSession = (session) => ({
        id: session.user.id,
        name: session.user.user_metadata?.full_name || session.user.email?.split('@')[0] || 'User',
        email: session.user.email,
        role: null
      });

      // ì‚¬ìš©ì í”„ë¡œí•„ ë¡œë“œ ë° ë·° ìƒíƒœ ì„¤ì • (ê³µí†µ í•¨ìˆ˜)
      const loadUserProfile = async (session) => {
        console.log("loadUserProfile called, session:", session?.user?.email);

        // ì„¸ì…˜ ì—†ìŒ: ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ
        if (!session?.user) {
          console.log("No session user, redirecting to login");
          setUser(null);
          setViewState('login');
          setIsLoadingAuth(false);
          return;
        }

        try {
          console.log("Fetching profile for user:", session.user.id);
          const profile = await dbGet("users", session.user.id);
          console.log("Profile fetched:", profile);

          // í”„ë¡œí•„ê³¼ ì—­í• ì´ ìˆëŠ” ê²½ìš°
          if (profile?.role) {
            setUser(profile);
            const tempMode = SecureSession.get('ojt_sessionMode');
            const viewState = getViewStateByRole(profile.role, tempMode);

            // Adminì˜ Mentor ëª¨ë“œ ì „í™˜ ì‹œ sessionModeë„ ì„¤ì •
            if (profile.role === 'admin' && tempMode === 'mentor') {
              setSessionMode('mentor');
            }

            console.log("Setting viewState to:", viewState);
            setViewState(viewState);
            setIsLoadingAuth(false);
            return;
          }

          // í”„ë¡œí•„ ì—†ê±°ë‚˜ ì—­í•  ì—†ìŒ: ì—­í•  ì„ íƒ í™”ë©´ìœ¼ë¡œ
          console.log("No profile or role, showing role select");
          setUser(extractUserFromSession(session));
          setViewState('role_select');
          setIsLoadingAuth(false);

        } catch (e) {
          console.error("Load user profile error:", e);
          // ì—ëŸ¬ ì‹œì—ë„ ì—­í•  ì„ íƒ í™”ë©´ìœ¼ë¡œ (ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€)
          setUser(extractUserFromSession(session));
          setViewState('role_select');
          setIsLoadingAuth(false);
        }
      };

      // ì´ˆê¸° ë¡œë“œ: Supabase Auth ì„¸ì…˜ í™•ì¸ (onAuthStateChange ê¸°ë°˜)
      useEffect(() => {
        let isMounted = true;
        let profileLoaded = false; // ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€ í”Œë˜ê·¸

        console.log("Auth: subscribing to onAuthStateChange...");

        // 10ì´ˆ í›„ì—ë„ ì´ë²¤íŠ¸ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ (fallback)
        const fallbackTimer = setTimeout(() => {
          if (isMounted && !profileLoaded) {
            console.log("Auth: fallback timeout, showing login");
            setViewState('login');
            setIsLoadingAuth(false);
          }
        }, 10000);

        // ì¸ì¦ ìƒíƒœ ë³€ê²½ êµ¬ë… (Supabase ê¶Œì¥ íŒ¨í„´)
        const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {
          console.log('Auth event:', event, session?.user?.email);

          if (!isMounted) return;

          // í† í° ê°±ì‹ ì€ UI ë³€ê²½ ë¶ˆí•„ìš”
          if (event === 'TOKEN_REFRESHED') {
            console.log('Auth: token refreshed, no UI change');
            return;
          }

          // INITIAL_SESSION: ì•± ì‹œì‘ ì‹œ ê¸°ì¡´ ì„¸ì…˜ í™•ì¸
          if (event === 'INITIAL_SESSION') {
            clearTimeout(fallbackTimer);
            if (session?.user && !profileLoaded) {
              console.log('Auth: INITIAL_SESSION with user');
              profileLoaded = true;
              await loadUserProfile(session);
            } else if (session?.user && profileLoaded) {
              console.log('Auth: INITIAL_SESSION skipped (already loaded)');
            } else {
              console.log('Auth: INITIAL_SESSION no user, showing login');
              setViewState('login');
              setIsLoadingAuth(false);
            }
            return;
          }

          if (event === 'SIGNED_OUT') {
            profileLoaded = false;
            setUser(null);
            setViewState('login');
            setIsLoadingAuth(false);
            return;
          }

          // SIGNED_IN: OAuth ë¡œê·¸ì¸ ì™„ë£Œ
          if (event === 'SIGNED_IN') {
            clearTimeout(fallbackTimer);
            if (session?.user && !profileLoaded) {
              console.log('Auth: SIGNED_IN, loading profile');
              profileLoaded = true;
              await loadUserProfile(session);
            } else if (profileLoaded) {
              console.log('Auth: SIGNED_IN skipped (already loaded)');
            }
          }
        });

        return () => {
          isMounted = false;
          clearTimeout(fallbackTimer);
          subscription.unsubscribe();
        };
      }, []);

      // ë©˜í† /Admin(Mentorëª¨ë“œ): ë‚´ ë¬¸ì„œ ë¡œë“œ
      useEffect(() => {
        // ì‹¤ì œ mentorì´ê±°ë‚˜, adminì´ mentor ëª¨ë“œë¡œ ì „í™˜í•œ ê²½ìš°
        const shouldLoadMyDocs = user && (
          user.role === 'mentor' ||
          (user.role === 'admin' && sessionMode === 'mentor')
        );
        if (!shouldLoadMyDocs) return;

        const loadMyDocs = async () => {
          // ğŸ” DEBUG: ì´ˆê¸° ë¡œë“œ ì‹œì‘
          console.log('%cğŸ“¥ [ì´ˆê¸° ë¡œë“œ] loadMyDocs ì‹œì‘', DEBUG.colors.data);
          console.log('  user.id:', user.id);

          // snake_case í•„ë“œëª… ì‚¬ìš© (DB ìŠ¤í‚¤ë§ˆì™€ ì¼ì¹˜)
          const docs = await dbGetAll("ojt_docs", { authorId: user.id });

          // ğŸ” DEBUG: dbGetAll ê²°ê³¼ ê²€ì¦
          DEBUG.trackDataFlow('loadMyDocs â†’ dbGetAll ê²°ê³¼', docs, {
            stage: 'ì´ˆê¸° ë¡œë“œ',
            filter: { author_id: user.id }
          });
          if (docs.length > 0) {
            DEBUG.checkFieldMapping('loadMyDocs ê²°ê³¼', docs[0], DEBUG.OJT_DOC_FIELDS);
          }

          // snake_case ê·¸ëŒ€ë¡œ ì‚¬ìš©
          setMyDocs(docs);
          console.log('%câœ… myDocs loaded:', DEBUG.colors.state, docs.length, 'documents');
        };
        loadMyDocs();
      }, [user, sessionMode, generatedDoc]); // sessionMode ë³€ê²½ ì‹œì—ë„ ë¦¬ë¡œë“œ

      // ë©˜í‹°: ëª¨ë“  ë¬¸ì„œ ë¡œë“œ
      useEffect(() => {
        if (!user || user.role !== 'mentee') return;
        const loadPublicDocs = async () => {
          // snake_case ê·¸ëŒ€ë¡œ ì‚¬ìš©
          const docs = await dbGetAll("ojt_docs");
          setPublicDocs(docs);
        };
        loadPublicDocs();
      }, [user]);

      // =========================================
      // Auth Handlers
      // =========================================
      const handleGoogleLogin = async () => {
        try {
          // OAuth Redirect URI ê²€ì¦: í—ˆìš©ëœ ë„ë©”ì¸ë§Œ ë¦¬ë‹¤ì´ë ‰íŠ¸
          const currentOrigin = window.location.origin;
          const redirectOrigin = CONFIG.ALLOWED_ORIGINS.includes(currentOrigin)
            ? currentOrigin
            : CONFIG.ALLOWED_ORIGINS[0]; // ê¸°ë³¸ê°’: í”„ë¡œë•ì…˜ URL

          const { error } = await supabase.auth.signInWithOAuth({
            provider: 'google',
            options: {
              redirectTo: redirectOrigin
            }
          });
          if (error) throw error;
        } catch (e) {
          console.error("Google login error:", e);
          Toast.error("Google ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
        }
      };

      const handleRoleSelect = async (selectedRole) => {
        if (!user) return;
        try {
          const userData = {
            id: user.id,
            name: user.name,
            role: selectedRole,
            department: null
          };
          await dbPut("users", userData);
          setUser(userData);

          if (selectedRole === 'mentor') setViewState('mentor_dashboard');
          else setViewState('mentee_list');
        } catch (e) {
          console.error("Role save error:", e);
          Toast.error("ì—­í•  ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      };

      const handleLogout = async () => {
        try {
          // ìºì‹œ ë¨¼ì € í´ë¦¬ì–´ (ë‹¤ë¥¸ ì‚¬ìš©ì ë°ì´í„° ë…¸ì¶œ ë°©ì§€)
          await clearAllCache();
          // ëª¨ë“œ ì „í™˜ ìƒíƒœ ì´ˆê¸°í™”
          SecureSession.remove('ojt_sessionMode');
          setSessionMode(null);
          setShowModeMenu(false);
          await supabase.auth.signOut();
          setUser(null);
          setViewState('login');
        } catch (e) {
          console.error("Logout error:", e);
        }
      };

      // Admin ëª¨ë“œ ì „í™˜ í•¸ë“¤ëŸ¬
      const handleModeSwitch = (newMode) => {
        if (newMode === null) {
          // Admin ëª¨ë“œë¡œ ë³µê·€
          SecureSession.remove('ojt_sessionMode');
          setSessionMode(null);
          setViewState('admin_dashboard');
        } else {
          // Mentor ëª¨ë“œë¡œ ì „í™˜
          SecureSession.set('ojt_sessionMode', newMode);
          setSessionMode(newMode);
          setViewState('mentor_dashboard');
        }
        setShowModeMenu(false);
      };

      // =========================================
      // Mentor Handlers
      // =========================================
      const handleGenerate = async () => {
        // ì…ë ¥ íƒ€ì…ì— ë”°ë¥¸ ê²€ì¦
        if (inputType === 'text' && !rawInput.trim()) {
          Toast.warning("í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }
        if (inputType === 'url' && !urlInput.trim()) {
          Toast.warning("URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }
        if (inputType === 'pdf' && !pdfFile) {
          Toast.warning("PDF íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }
        if (!aiStatus.online) {
          Toast.error("Gemini AI ì„œë¹„ìŠ¤ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
          return;
        }

        setIsProcessing(true);
        setGeneratedDoc(null);
        setGeneratedDocs([]);

        try {
          // =========================================
          // URL/PDF: URL Context Toolë¡œ í€´ì¦ˆë§Œ ìƒì„± (ì›ë¬¸ ë³´ì¡´)
          // =========================================
          if (inputType === 'url') {
            setProcessingStatus("URL ìœ íš¨ì„± ê²€ì‚¬ ì¤‘...");

            // URL ìœ íš¨ì„± ê²€ì¦
            try {
              new URL(urlInput);
            } catch {
              throw new Error("ì˜¬ë°”ë¥¸ URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.");
            }

            setProcessingStatus("Gemini AIê°€ URLì„ ë¶„ì„ ì¤‘...");
            const aiResult = await generateQuizWithUrlContext(urlInput, 'url', setProcessingStatus);
            const finalTitle = inputTitle.trim() || aiResult.title || "URL í•™ìŠµ ìë£Œ";

            const finalDoc = {
              ...aiResult,
              title: finalTitle,
              team: inputTeam,
              step: parseInt(inputStep),
              source_type: 'url',
              source_url: urlInput,
              sections: [] // URL ì›ë¬¸ì€ sections ì—†ìŒ (ì›ë¬¸ ë³´ê¸°ë¡œ ëŒ€ì²´)
            };

            setInputTitle(finalTitle);
            setGeneratedDoc(finalDoc);
            setGeneratedDocs([finalDoc]);
            setProcessingStatus("");
            setEditorTab('preview');

            // AI ì²˜ë¦¬ ê²°ê³¼ì— ë”°ë¥¸ ë©”ì‹œì§€
            if (aiResult.ai_processed === false) {
              Toast.warning(`AI ë¶„ì„ ì‹¤íŒ¨: ${aiResult.ai_error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}. í€´ì¦ˆ ì—†ì´ ì›ë¬¸ìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤.`);
            } else {
              Toast.success("URL ë¶„ì„ ì™„ë£Œ! í€´ì¦ˆê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
            return;
          }

          if (inputType === 'pdf') {
            setProcessingStatus("PDF íŒŒì¼ ì—…ë¡œë“œ ì¤‘...");

            // PDFë¥¼ R2ì— ì—…ë¡œë“œ
            const pdfUrl = await uploadPdfToR2(pdfFile);

            setProcessingStatus("Gemini AIê°€ PDFë¥¼ ë¶„ì„ ì¤‘...");
            const aiResult = await generateQuizWithUrlContext(pdfUrl, 'pdf', setProcessingStatus);
            const finalTitle = inputTitle.trim() || aiResult.title || pdfFile.name.replace('.pdf', '');

            const finalDoc = {
              ...aiResult,
              title: finalTitle,
              team: inputTeam,
              step: parseInt(inputStep),
              source_type: 'pdf',
              source_file: pdfUrl,
              sections: [] // PDF ì›ë¬¸ì€ sections ì—†ìŒ (PDF ë·°ì–´ë¡œ ëŒ€ì²´)
            };

            setInputTitle(finalTitle);
            setGeneratedDoc(finalDoc);
            setGeneratedDocs([finalDoc]);
            setProcessingStatus("");
            setEditorTab('preview');

            // AI ì²˜ë¦¬ ê²°ê³¼ì— ë”°ë¥¸ ë©”ì‹œì§€
            if (aiResult.ai_processed === false) {
              Toast.warning(`AI ë¶„ì„ ì‹¤íŒ¨: ${aiResult.ai_error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}. í€´ì¦ˆ ì—†ì´ ì›ë¬¸ìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤.`);
            } else {
              Toast.success("PDF ë¶„ì„ ì™„ë£Œ! í€´ì¦ˆê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
            return;
          }

          // =========================================
          // í…ìŠ¤íŠ¸: ê¸°ì¡´ ë°©ì‹ (ì„¹ì…˜ + í€´ì¦ˆ ìƒì„±)
          // =========================================
          setProcessingStatus("ì½˜í…ì¸  ì¶”ì¶œ ì¤‘...");
          let contentText = '';

          // Quillì—ì„œ ì„œì‹ ìˆëŠ” HTMLê³¼ í”Œë ˆì¸ í…ìŠ¤íŠ¸ ëª¨ë‘ ê°€ì ¸ì˜¤ê¸°
          if (quillInstanceRef.current) {
            const rawHtml = quillInstanceRef.current.root.innerHTML;
            const plainText = quillInstanceRef.current.getText().trim();
            // XSS ë°©ì–´: DOMPurifyë¡œ HTML sanitize
            const html = DOMPurify.sanitize(rawHtml, {
              ALLOWED_TAGS: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'br', 'strong', 'em', 'u', 'ol', 'ul', 'li', 'blockquote', 'pre', 'code', 'a', 'img', 'span', 's'],
              ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class', 'style'],
              ALLOW_DATA_ATTR: false
            });
            // HTMLì´ ì˜ë¯¸ ìˆëŠ” ì„œì‹ì„ í¬í•¨í•˜ë©´ HTML ì‚¬ìš©, ì•„ë‹ˆë©´ í”Œë ˆì¸ í…ìŠ¤íŠ¸ ì‚¬ìš©
            const hasFormatting = /<(h[1-6]|strong|em|u|ol|ul|li|blockquote|pre)/.test(html);
            contentText = hasFormatting ? html : plainText;
          } else {
            contentText = rawInput;
          }

          if (!contentText.trim()) {
            throw new Error("í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          }

          // ìë™ ë¶„í•  ì—¬ë¶€ í™•ì¸
          const numSteps = autoSplit ? calculateRequiredSteps(contentText) : 1;

          if (numSteps > 1) {
            // ì—¬ëŸ¬ ìŠ¤í…ìœ¼ë¡œ ë¶„í•  ìƒì„± (ë³‘ë ¬ ì²˜ë¦¬ë¡œ ì†ë„ í–¥ìƒ)
            const segments = splitContentForSteps(contentText, numSteps);
            const baseStep = parseInt(inputStep);
            const baseTitle = inputTitle.trim();

            setProcessingStatus(`AI ë³‘ë ¬ ìƒì„± ì¤‘... (${segments.length}ê°œ ìŠ¤í…)`);

            // ëª¨ë“  ìŠ¤í…ì„ ë³‘ë ¬ë¡œ ìƒì„± (Promise.all)
            const generatePromises = segments.map((segment, i) => {
              const stepNum = baseStep + i;
              return generateOJTContent(
                segment,
                inputTeam,
                stepNum,
                null, // ë³‘ë ¬ ì²˜ë¦¬ ì‹œ ê°œë³„ ì§„í–‰ ìƒíƒœ í‘œì‹œ ì–´ë ¤ì›€
                segments.length
              ).then(aiResult => {
                const stepTitle = baseTitle
                  ? `${baseTitle} - Step ${stepNum}`
                  : `${aiResult.title} - Step ${stepNum}`;

                return {
                  ...aiResult,
                  title: stepTitle,
                  team: inputTeam,
                  step: stepNum,
                  totalSteps: segments.length,
                  stepIndex: i + 1,
                  source_type: 'manual'
                };
              });
            });

            // ëª¨ë“  ìŠ¤í… ìƒì„± ì™„ë£Œ ëŒ€ê¸°
            const results = await Promise.all(generatePromises);

            // ìŠ¤í… ìˆœì„œëŒ€ë¡œ ì •ë ¬
            results.sort((a, b) => a.step - b.step);

            setGeneratedDocs(results);
            setGeneratedDoc(results[0]); // ì²« ë²ˆì§¸ ë¬¸ì„œë¥¼ ë¯¸ë¦¬ë³´ê¸°ì— í‘œì‹œ
            setProcessingStatus("");
            setEditorTab('preview'); // ë¯¸ë¦¬ë³´ê¸° íƒ­ìœ¼ë¡œ ìë™ ì „í™˜

            // AI ì²˜ë¦¬ ì‹¤íŒ¨ ë¬¸ì„œê°€ ìˆëŠ”ì§€ í™•ì¸
            const failedDocs = results.filter(r => r.ai_processed === false);
            if (failedDocs.length > 0) {
              Toast.warning(`AI ë¶„ì„ ì‹¤íŒ¨ ${failedDocs.length}ê°œ. í€´ì¦ˆ ì—†ì´ ì›ë¬¸ìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤.`);
            } else {
              Toast.success(`${results.length}ê°œì˜ êµìœ¡ ìë£Œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            }
          } else {
            // ë‹¨ì¼ ìŠ¤í… ìƒì„±
            setProcessingStatus("AI ìƒì„± ì‹œì‘...");
            const aiResult = await generateOJTContent(contentText, inputTeam, inputStep, setProcessingStatus);
            const finalTitle = inputTitle.trim() || aiResult.title;
            setInputTitle(finalTitle);
            const finalDoc = {
              ...aiResult,
              title: finalTitle,
              team: inputTeam,
              step: parseInt(inputStep),
              source_type: 'manual'
            };
            setGeneratedDoc(finalDoc);
            setGeneratedDocs([finalDoc]);
            setProcessingStatus("");
            setEditorTab('preview'); // ë¯¸ë¦¬ë³´ê¸° íƒ­ìœ¼ë¡œ ìë™ ì „í™˜

            // AI ì²˜ë¦¬ ê²°ê³¼ì— ë”°ë¥¸ ë©”ì‹œì§€
            if (aiResult.ai_processed === false) {
              Toast.warning(`AI ë¶„ì„ ì‹¤íŒ¨: ${aiResult.ai_error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}. í€´ì¦ˆ ì—†ì´ ì›ë¬¸ìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤.`);
            } else {
              Toast.success("êµìœ¡ ìë£Œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!");
            }
          }
        } catch (error) {
          Toast.error(`ì˜¤ë¥˜: ${error.message}`);
          setProcessingStatus("");
        }

        setIsProcessing(false);
      };

      const handleSaveToDB = async () => {
        if (!user || (!generatedDoc && generatedDocs.length === 0)) return;

        try {
          const docsToSave = generatedDocs.length > 0 ? generatedDocs : [generatedDoc];
          let savedCount = 0;

          for (const doc of docsToSave) {
            const docToSave = {
              ...doc,
              title: doc.title || inputTitle || "ì œëª© ì—†ìŒ",
              team: inputTeam,
              step: doc.step || parseInt(inputStep),
              // snake_case í•„ë“œëª… ì‚¬ìš© (DB ìŠ¤í‚¤ë§ˆì™€ ì¼ì¹˜)
              author_name: user.name,
              author_id: user.id
            };

            // í¸ì§‘ ëª¨ë“œ: ê¸°ì¡´ ë¬¸ì„œ ì—…ë°ì´íŠ¸
            if (editingDoc && savedCount === 0) {
              docToSave.id = editingDoc.id;
              docToSave.created_at = editingDoc.created_at;
              docToSave.updated_at = new Date().toISOString();
              // editingDocì˜ source í•„ë“œ ìœ ì§€ (docì— ì—†ì„ ê²½ìš° fallback)
              if (!docToSave.source_type && editingDoc.source_type) {
                docToSave.source_type = editingDoc.source_type;
                docToSave.source_url = editingDoc.source_url;
                docToSave.source_file = editingDoc.source_file;
              }
              await dbPut("ojt_docs", docToSave);
            } else {
              // ì‹ ê·œ ëª¨ë“œ: ìƒˆ ë¬¸ì„œ ì¶”ê°€ (snake_case í•„ë“œëª…)
              docToSave.created_at = new Date().toISOString();
              await dbAdd("ojt_docs", docToSave);
            }
            savedCount++;
          }

          const message = editingDoc
            ? `ë¬¸ì„œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`
            : `${savedCount}ê°œ ë¬¸ì„œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`;
          Toast.success(message);

          // ìƒíƒœ ì´ˆê¸°í™”
          setEditingDoc(null);
          setGeneratedDoc(null);
          setGeneratedDocs([]);
          setRawInput("");
          setUrlInput("");
          setPdfFile(null);
          setInputTitle("");
          // ì €ì¥ í›„ ìë™ ë¶„í•  ë³µì›
          setAutoSplit(true);
          // Quill ì—ë””í„° ì´ˆê¸°í™”
          if (quillInstanceRef.current) {
            quillInstanceRef.current.setText('');
          }
          // ëª©ë¡ ìƒˆë¡œê³ ì¹¨ - snake_case í•„ë“œëª… ì‚¬ìš©
          const allDocs = await dbGetAll("ojt_docs");

          // ğŸ” DEBUG: ì €ì¥ í›„ ìƒˆë¡œê³ ì¹¨ ë°ì´í„° ê²€ì¦
          DEBUG.trackDataFlow('handleSaveToDB â†’ ì €ì¥ í›„ dbGetAll ê²°ê³¼', allDocs, {
            stage: 'ì €ì¥ í›„ ìƒˆë¡œê³ ì¹¨',
            totalCount: allDocs.length
          });
          if (allDocs.length > 0) {
            DEBUG.checkFieldMapping('ì €ì¥ í›„ ë¬¸ì„œ ê²€ì¦', allDocs[0], DEBUG.OJT_DOC_FIELDS);
          }

          // snake_case í•„ë“œëª…ìœ¼ë¡œ í•„í„°ë§ (DB ìŠ¤í‚¤ë§ˆì™€ ì¼ì¹˜)
          const filtered = allDocs.filter(doc => doc.author_id === user.id);

          // ğŸ” DEBUG: í•„í„°ë§ ê²°ê³¼ ê²€ì¦
          DEBUG.trackDataFlow('handleSaveToDB â†’ í•„í„°ë§ í›„', filtered, {
            stage: 'í•„í„°ë§ ì™„ë£Œ',
            userId: user.id,
            beforeFilter: allDocs.length,
            afterFilter: filtered.length,
            filterCondition: 'doc.author_id === user.id'
          });

          filtered.sort((a, b) => {
            const aTime = a.created_at ? new Date(a.created_at).getTime() : 0;
            const bTime = b.created_at ? new Date(b.created_at).getTime() : 0;
            return bTime - aTime;
          });
          setMyDocs(filtered);
        } catch (e) {
          console.error("Save error:", e);
          Toast.error("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      };

      const handleDeleteDoc = async (docId) => {
        const doc = myDocs.find(d => d.id === docId);
        if (!doc) return;

        // CSRF ë°©ì–´: 2ë‹¨ê³„ í™•ì¸ (ê³µí†µ í—¬í¼ ì‚¬ìš©)
        if (!confirmDeleteWithCSRF(doc.title)) return;

        try {
          await dbDelete("ojt_docs", docId);
          setMyDocs(prev => prev.filter(d => d.id !== docId));
        } catch (e) {
          console.error("Delete error:", e);
        }
      };

      // í€´ì¦ˆ ìˆ˜ì • í•¸ë“¤ëŸ¬ë“¤ (generatedDoc ë˜ëŠ” editingDoc ì§€ì›)
      const handleQuizQuestionChange = (quizIndex, newQuestion) => {
        // editingDoc ìš°ì„ , ì—†ìœ¼ë©´ generatedDoc
        if (editingDoc?.quiz) {
          const updatedQuiz = [...editingDoc.quiz];
          updatedQuiz[quizIndex] = { ...updatedQuiz[quizIndex], question: newQuestion };
          setEditingDoc({ ...editingDoc, quiz: updatedQuiz });
        } else if (generatedDoc?.quiz) {
          const updatedQuiz = [...generatedDoc.quiz];
          updatedQuiz[quizIndex] = { ...updatedQuiz[quizIndex], question: newQuestion };
          setGeneratedDoc({ ...generatedDoc, quiz: updatedQuiz });
          if (generatedDocs.length > 0) {
            const docIndex = generatedDocs.findIndex(d => d === generatedDoc);
            if (docIndex !== -1) {
              const updatedDocs = [...generatedDocs];
              updatedDocs[docIndex] = { ...generatedDoc, quiz: updatedQuiz };
              setGeneratedDocs(updatedDocs);
            }
          }
        }
      };

      const handleQuizOptionChange = (quizIndex, optionIndex, newOption) => {
        const targetDoc = editingDoc?.quiz ? editingDoc : generatedDoc;
        if (!targetDoc?.quiz) return;
        const updatedQuiz = [...targetDoc.quiz];
        const updatedOptions = [...updatedQuiz[quizIndex].options];
        const wasAnswer = updatedQuiz[quizIndex].answer === updatedOptions[optionIndex];
        updatedOptions[optionIndex] = newOption;
        updatedQuiz[quizIndex] = { 
          ...updatedQuiz[quizIndex], 
          options: updatedOptions,
          answer: wasAnswer ? newOption : updatedQuiz[quizIndex].answer
        };
        if (editingDoc?.quiz) {
          setEditingDoc({ ...editingDoc, quiz: updatedQuiz });
        } else {
          setGeneratedDoc({ ...generatedDoc, quiz: updatedQuiz });
          if (generatedDocs.length > 0) {
            const docIndex = generatedDocs.findIndex(d => d === generatedDoc);
            if (docIndex !== -1) {
              const updatedDocs = [...generatedDocs];
              updatedDocs[docIndex] = { ...generatedDoc, quiz: updatedQuiz };
              setGeneratedDocs(updatedDocs);
            }
          }
        }
      };

      const handleQuizCorrectChange = (quizIndex, optionIndex) => {
        const targetDoc = editingDoc?.quiz ? editingDoc : generatedDoc;
        if (!targetDoc?.quiz) return;
        const updatedQuiz = [...targetDoc.quiz];
        updatedQuiz[quizIndex] = { 
          ...updatedQuiz[quizIndex], 
          correct: optionIndex,
          answer: updatedQuiz[quizIndex].options[optionIndex]
        };
        if (editingDoc?.quiz) {
          setEditingDoc({ ...editingDoc, quiz: updatedQuiz });
        } else {
          setGeneratedDoc({ ...generatedDoc, quiz: updatedQuiz });
          if (generatedDocs.length > 0) {
            const docIndex = generatedDocs.findIndex(d => d === generatedDoc);
            if (docIndex !== -1) {
              const updatedDocs = [...generatedDocs];
              updatedDocs[docIndex] = { ...generatedDoc, quiz: updatedQuiz };
              setGeneratedDocs(updatedDocs);
            }
          }
        }
      };

      const handleQuizDelete = (quizIndex) => {
        const targetDoc = editingDoc?.quiz ? editingDoc : generatedDoc;
        if (!targetDoc?.quiz || targetDoc.quiz.length <= 4) {
          Toast.warning('ìµœì†Œ 4ê°œ ì´ìƒì˜ í€´ì¦ˆê°€ í•„ìš”í•©ë‹ˆë‹¤.');
          return;
        }
        const updatedQuiz = targetDoc.quiz.filter((_, idx) => idx !== quizIndex);
        if (editingDoc?.quiz) {
          setEditingDoc({ ...editingDoc, quiz: updatedQuiz });
        } else {
          setGeneratedDoc({ ...generatedDoc, quiz: updatedQuiz });
          if (generatedDocs.length > 0) {
            const docIndex = generatedDocs.findIndex(d => d === generatedDoc);
            if (docIndex !== -1) {
              const updatedDocs = [...generatedDocs];
              updatedDocs[docIndex] = { ...generatedDoc, quiz: updatedQuiz };
              setGeneratedDocs(updatedDocs);
            }
          }
        }
        Toast.success('í€´ì¦ˆê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      };

      // ë¬¸ì„œ í¸ì§‘ í•¸ë“¤ëŸ¬ - ê¸°ì¡´ ë¬¸ì„œë¥¼ í¸ì§‘ì°½ì— ë¡œë“œ
      const handleEditDoc = (doc) => {
        setEditingDoc(doc);
        setInputTitle(doc.title || '');
        setInputTeam(doc.team || TEAMS[0]);
        setInputStep(doc.step || 1);

        // í¸ì§‘ ëª¨ë“œì—ì„œëŠ” ìë™ ë¶„í•  ë¹„í™œì„±í™” (ì¶©ëŒ ë°©ì§€)
        setAutoSplit(false);

        // ì„¹ì…˜ ë‚´ìš©ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•˜ì—¬ ì—ë””í„°ì— ë¡œë“œ
        if (doc.sections && doc.sections.length > 0) {
          const contentText = doc.sections.map(section => {
            let text = `## ${section.title}\n\n`;
            if (section.content) {
              text += section.content + '\n\n';
            }
            return text;
          }).join('');

          setRawInput(contentText);

          // Quill ì—ë””í„°ì— ë‚´ìš© ì„¤ì •
          if (quillInstanceRef.current) {
            quillInstanceRef.current.setText(contentText);
          }
        }

        // í¸ì§‘ ëª¨ë“œ: ê¸°ì¡´ ë¬¸ì„œë¥¼ generatedDocì— ë³µì‚¬ (source í•„ë“œ ìœ ì§€)
        // URL/PDF ë¬¸ì„œì˜ ê²½ìš° source_type, source_url, source_file í•„ë“œê°€ ë¯¸ë¦¬ë³´ê¸°ì— í‘œì‹œë¨
        // snake_case í•„ë“œëª… ê·¸ëŒ€ë¡œ ì‚¬ìš© (DB ìŠ¤í‚¤ë§ˆì™€ ì¼ì¹˜)
        setGeneratedDoc(doc);
        setGeneratedDocs([]);

        // ìŠ¤í¬ë¡¤ ë§¨ ìœ„ë¡œ
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };

      // í¸ì§‘ ì·¨ì†Œ í•¸ë“¤ëŸ¬
      const handleCancelEdit = () => {
        setEditingDoc(null);
        setInputTitle('');
        setRawInput('');
        setGeneratedDoc(null);
        setGeneratedDocs([]);
        // í¸ì§‘ ëª¨ë“œ í•´ì œ ì‹œ ìë™ ë¶„í•  ë³µì›
        setAutoSplit(true);
        if (quillInstanceRef.current) {
          quillInstanceRef.current.setText('');
        }
      };

      // =========================================
      // Mentee Handlers
      // =========================================
      const handleSelectDoc = (doc) => {
        setSelectedDoc(doc);
        setQuizMode(false);
        setViewState('mentee_study');
      };

      const startQuizSession = () => {
        if (!selectedDoc || !selectedDoc.quiz) return;

        const fullPool = [...selectedDoc.quiz];

        // í€´ì¦ˆ 4ê°œ ë¯¸ë§Œ ê²€ì¦
        if (fullPool.length < CONFIG.QUIZ_QUESTIONS_PER_TEST) {
          Toast.warning(`í€´ì¦ˆê°€ ${fullPool.length}ê°œë¿ì…ë‹ˆë‹¤. ìµœì†Œ ${CONFIG.QUIZ_QUESTIONS_PER_TEST}ê°œ í•„ìš” (ë¬¸ì„œ ê´€ë¦¬ì ë¬¸ì˜)`);
          return;
        }

        // Fisher-Yates ì…”í”Œ
        for (let i = fullPool.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [fullPool[i], fullPool[j]] = [fullPool[j], fullPool[i]];
        }
        setActiveQuizSet(fullPool.slice(0, CONFIG.QUIZ_QUESTIONS_PER_TEST));
        setQuizMode(true);
        setSelectedAnswers({});
        setQuizSubmitted(false);
        setCurrentQuizIndex(0);
        setScore(0);
        setPassed(false);
      };

      const handleAnswerSelect = (qIndex, optionIndex) => {
        if (quizSubmitted) return;
        setSelectedAnswers(prev => ({ ...prev, [qIndex]: optionIndex }));
      };

      const submitQuiz = () => {
        if (!activeQuizSet.length) return;
        let correctCount = 0;
        activeQuizSet.forEach((q, idx) => {
          // ë²„ê·¸ ìˆ˜ì •: hasOwnPropertyë¡œ ì¸ë±ìŠ¤ 0ë„ ì •í™•íˆ ê²€ì¦
          if (Object.prototype.hasOwnProperty.call(selectedAnswers, idx) && selectedAnswers[idx] === q.answer) {
            correctCount++;
          }
        });
        setScore(correctCount);
        setPassed(correctCount >= QUIZ_PASS_THRESHOLD);
        setQuizSubmitted(true);
      };

      // =========================================
      // Views
      // =========================================

      const AIStatusBadge = () => {
        // AI ì˜¨ë¼ì¸ ìƒíƒœ
        if (aiStatus.online) {
          return (
            <div className="flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-700">
              <Icon name="server" className="w-3 h-3" />
              Gemini: {GEMINI_MODEL}
            </div>
          );
        }

        // AI ì˜¤í”„ë¼ì¸ ìƒíƒœ
        return (
          <div className="flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700">
            <Icon name="server" className="w-3 h-3" />
            AI ì˜¤í”„ë¼ì¸
          </div>
        );
      };

      const LoginPage = () => {
        return (
          <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-indigo-50 via-white to-purple-50 p-6">
            <div className="max-w-md w-full bg-white rounded-2xl shadow-2xl p-10 text-center">
              <div className="mb-8">
                <div className="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  <Icon name="brain" className="w-12 h-12 text-indigo-600" />
                </div>
                <h1 className="text-3xl font-bold text-slate-800 mb-2">OJT Master</h1>
                <p className="text-slate-500">AI ê¸°ë°˜ ì˜¨ë³´ë”© êµìœ¡ í”Œë«í¼</p>
                <p className="text-xs text-slate-400 mt-1">v2.10.0 (65dcd49) | WebLLM ì˜¤í”ˆì†ŒìŠ¤ LLM í†µí•©</p>
                <p className="text-xs text-slate-400 mt-0.5 max-w-xs truncate" title="fix(auth): Critical ì„¤ê³„ ì˜¤ë¥˜ ìˆ˜ì •">fix: Auth ì„¤ê³„ ì˜¤ë¥˜ ìˆ˜ì • (Supabase-first)</p>
              </div>

              <div className="mb-6">
                <AIStatusBadge />
                {aiStatus.online && (
                  <p className="text-xs text-blue-600 mt-2">Google Gemini AIë¡œ ìë£Œë¥¼ ìƒì„±í•©ë‹ˆë‹¤</p>
                )}
              </div>

              <div className="space-y-4">
                <button
                  onClick={handleGoogleLogin}
                  className="w-full py-3 bg-white border-2 border-slate-200 text-slate-700 rounded-lg font-bold hover:bg-slate-50 hover:border-slate-300 transition-colors flex items-center justify-center gap-3"
                >
                  <svg className="w-5 h-5" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                  </svg>
                  Googleë¡œ ë¡œê·¸ì¸
                </button>
                <p className="text-xs text-slate-400 mt-4">
                  Google ê³„ì •ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ë¡œê·¸ì¸í•˜ì„¸ìš”.
                </p>
              </div>
            </div>
          </div>
        );
      };

      const Header = () => {
        const getRoleBadgeColor = (role, isTemp) => {
          if (isTemp) return 'bg-amber-500 text-white';
          switch (role) {
            case 'admin': return 'bg-red-600 text-white';
            case 'mentor': return 'bg-indigo-800 text-indigo-100';
            case 'mentee': return 'bg-green-600 text-white';
            default: return 'bg-slate-600 text-white';
          }
        };

        const handleHomeClick = () => {
          // ì„ì‹œ ëª¨ë“œì¼ ë•ŒëŠ” í•´ë‹¹ ëª¨ë“œì˜ í™ˆìœ¼ë¡œ
          const effectiveRole = sessionMode || user?.role;
          if (effectiveRole === 'admin') setViewState('admin_dashboard');
          else if (effectiveRole === 'mentor') setViewState('mentor_dashboard');
          else if (effectiveRole === 'mentee') { setViewState('mentee_list'); setSelectedTeam(null); }
        };

        return (
          <header className="bg-indigo-600 text-white p-4 shadow-md flex justify-between items-center sticky top-0 z-50">
            <div className="flex items-center gap-2 cursor-pointer" onClick={handleHomeClick}>
              <Icon name="brain" className="w-8 h-8" />
              <div>
                <h1 className="text-xl font-bold">OJT Master <span className="text-xs font-normal text-indigo-200">v2.10.0</span></h1>
                <p className="text-xs text-indigo-200">
                  {user ? (
                    sessionMode
                      ? `${sessionMode.toUpperCase()} MODE (ì„ì‹œ)`
                      : `${user.role?.toUpperCase()} MODE`
                  ) : 'Welcome'} | 65dcd49
                </p>
                <p className="text-xs text-indigo-300 opacity-70 truncate max-w-[200px]" title="fix(auth): Critical ì„¤ê³„ ì˜¤ë¥˜ ìˆ˜ì •">Auth ì˜¤ë¥˜ ìˆ˜ì •</p>
              </div>
            </div>
            <div className="flex items-center gap-3">
              <AIStatusBadge />
              {user && (
                <>
                  {/* Admin ëª¨ë“œ ì „í™˜ ë²„íŠ¼ */}
                  {user.role === 'admin' && (
                    <div className="relative mode-menu-container">
                      <button
                        onClick={() => setShowModeMenu(!showModeMenu)}
                        className="text-sm flex items-center gap-1 px-2 py-1 rounded hover:bg-indigo-700 transition border border-indigo-400"
                      >
                        <Icon name="settings" className="w-4 h-4" />
                        <span className="hidden sm:inline">ëª¨ë“œ</span>
                        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                        </svg>
                      </button>
                      {showModeMenu && (
                        <div className="absolute right-0 mt-2 w-48 bg-white text-slate-800 rounded-lg shadow-xl z-50 py-1">
                          <button
                            onClick={() => handleModeSwitch(null)}
                            className={`w-full text-left px-4 py-2 hover:bg-slate-100 text-sm flex items-center gap-2 ${!sessionMode ? 'bg-slate-100 font-semibold' : ''}`}
                          >
                            <Icon name="shield" className="w-4 h-4 text-red-600" />
                            Admin ëŒ€ì‹œë³´ë“œ
                            {!sessionMode && <span className="ml-auto text-green-600">âœ“</span>}
                          </button>
                          <button
                            onClick={() => handleModeSwitch('mentor')}
                            className={`w-full text-left px-4 py-2 hover:bg-slate-100 text-sm flex items-center gap-2 ${sessionMode === 'mentor' ? 'bg-slate-100 font-semibold' : ''}`}
                          >
                            <Icon name="edit" className="w-4 h-4 text-indigo-600" />
                            Mentor ì‘ì—…ì‹¤
                            {sessionMode === 'mentor' && <span className="ml-auto text-green-600">âœ“</span>}
                          </button>
                          <hr className="my-1" />
                          <button
                            onClick={() => setShowModeMenu(false)}
                            className="w-full text-left px-4 py-2 hover:bg-slate-100 text-sm text-slate-500"
                          >
                            ë‹«ê¸°
                          </button>
                        </div>
                      )}
                    </div>
                  )}
                  <span className="text-sm hidden sm:block">{user.name}</span>
                  <span className={`px-3 py-1 rounded-full text-xs font-bold uppercase ${getRoleBadgeColor(sessionMode || user.role, !!sessionMode)}`}>
                    {sessionMode || user.role}
                  </span>
                  <button onClick={handleLogout} className="text-sm flex items-center gap-1 hover:text-red-200">
                    <Icon name="logout" className="w-4 h-4" /> ë¡œê·¸ì•„ì›ƒ
                  </button>
                </>
              )}
            </div>
          </header>
        );
      };

      // =========================================
      // Admin Dashboard Component
      // =========================================
      const AdminDashboard = () => {
        const [adminTab, setAdminTab] = useState('users'); // 'users', 'content', 'departments', 'stats'
        const [allUsers, setAllUsers] = useState([]);
        const [allDocs, setAllDocs] = useState([]);
        const [allRecords, setAllRecords] = useState([]);
        const [allTeams, setAllTeams] = useState([]); // ë¶€ì„œ ëª©ë¡
        const [isLoading, setIsLoading] = useState(true);
        const [selectedUser, setSelectedUser] = useState(null);
        const [showRoleModal, setShowRoleModal] = useState(false);
        const [selectedDoc, setSelectedDoc] = useState(null); // ìƒì„¸ë³´ê¸°ìš© ë¬¸ì„œ
        const [showDocModal, setShowDocModal] = useState(false); // ë¬¸ì„œ ìƒì„¸ ëª¨ë‹¬
        const [showTeamModal, setShowTeamModal] = useState(false); // ë¶€ì„œ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬
        const [editingTeam, setEditingTeam] = useState(null); // ìˆ˜ì • ì¤‘ì¸ ë¶€ì„œ
        const [newTeamName, setNewTeamName] = useState(''); // ìƒˆ ë¶€ì„œëª…
        const [newTeamSlug, setNewTeamSlug] = useState(''); // ìƒˆ ë¶€ì„œ slug
        const [newTeamDesc, setNewTeamDesc] = useState(''); // ìƒˆ ë¶€ì„œ ì„¤ëª…
        const chartRef = useRef(null);
        const chartInstance = useRef(null);

        // ë°ì´í„° ë¡œë“œ
        useEffect(() => {
          const loadAdminData = async () => {
            setIsLoading(true);
            try {
              // ëª¨ë“  ì‚¬ìš©ì ì¡°íšŒ (Admin RLS ì •ì±… ì ìš©)
              const { data: users, error: usersError } = await supabase
                .from('users')
                .select('*')
                .order('created_at', { ascending: false });

              if (usersError) throw usersError;
              setAllUsers(users || []);

              // ëª¨ë“  ë¬¸ì„œ ì¡°íšŒ
              const { data: docs, error: docsError } = await supabase
                .from('ojt_docs')
                .select('*')
                .order('created_at', { ascending: false });

              if (docsError) throw docsError;
              setAllDocs(docs || []);

              // ëª¨ë“  í•™ìŠµ ê¸°ë¡ ì¡°íšŒ (Admin RLS ì •ì±… ì ìš©)
              const { data: records, error: recordsError } = await supabase
                .from('learning_records')
                .select('*')
                .order('completed_at', { ascending: false });

              if (!recordsError) setAllRecords(records || []);

              // ë¶€ì„œ(teams) ëª©ë¡ ì¡°íšŒ
              const { data: teams, error: teamsError } = await supabase
                .from('teams')
                .select('*')
                .order('display_order', { ascending: true });

              if (!teamsError) setAllTeams(teams || []);
            } catch (e) {
              console.error('Admin data load error:', e);
              Toast.error('ê´€ë¦¬ì ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
              setIsLoading(false);
            }
          };

          loadAdminData();
        }, []);

        // ì°¨íŠ¸ ìƒì„±/ì—…ë°ì´íŠ¸
        useEffect(() => {
          if (adminTab === 'stats' && chartRef.current && allUsers.length > 0) {
            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            if (chartInstance.current) {
              chartInstance.current.destroy();
            }

            // ì—­í• ë³„ ì‚¬ìš©ì ìˆ˜ ì§‘ê³„
            const roleCounts = allUsers.reduce((acc, user) => {
              acc[user.role] = (acc[user.role] || 0) + 1;
              return acc;
            }, {});

            const ctx = chartRef.current.getContext('2d');
            chartInstance.current = new Chart(ctx, {
              type: 'doughnut',
              data: {
                labels: ['ê´€ë¦¬ì', 'ë©˜í† ', 'ë©˜í‹°'],
                datasets: [{
                  data: [roleCounts.admin || 0, roleCounts.mentor || 0, roleCounts.mentee || 0],
                  backgroundColor: ['#dc2626', '#4f46e5', '#16a34a'],
                  borderWidth: 0
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: { position: 'bottom' }
                }
              }
            });
          }

          return () => {
            if (chartInstance.current) {
              chartInstance.current.destroy();
            }
          };
        }, [adminTab, allUsers]);

        // ë¶€ì„œ ë³€ê²½ í•¸ë“¤ëŸ¬
        const handleDepartmentChange = async (userId, newDepartment) => {
          try {
            const { error } = await supabase
              .from('users')
              .update({ department: newDepartment || null, updated_at: Date.now() })
              .eq('id', userId);

            if (error) throw error;

            setAllUsers(prev => prev.map(u => u.id === userId ? { ...u, department: newDepartment || null } : u));
            Toast.success('ë¶€ì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
          } catch (e) {
            console.error('Department change error:', e);
            Toast.error('ë¶€ì„œ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + e.message);
          }
        };

        // ì—­í•  ë³€ê²½ í•¸ë“¤ëŸ¬
        const handleRoleChange = async (userId, newRole) => {
          try {
            const { data, error } = await supabase
              .from('users')
              .update({ role: newRole })
              .eq('id', userId)
              .select();

            if (error) throw error;

            // RLSê°€ ì—…ë°ì´íŠ¸ë¥¼ ì°¨ë‹¨í•œ ê²½ìš° (0í–‰ ë°˜í™˜)
            if (!data || data.length === 0) {
              throw new Error('ê¶Œí•œì´ ì—†ê±°ë‚˜ RLS ì •ì±…ì— ì˜í•´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. Supabase ëŒ€ì‹œë³´ë“œì—ì„œ RLS ì •ì±…ì„ í™•ì¸í•˜ì„¸ìš”.');
            }

            // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
            setAllUsers(prev => prev.map(u => u.id === userId ? { ...u, role: newRole } : u));
            setShowRoleModal(false);
            setSelectedUser(null);
            Toast.success(`ì—­í• ì´ ${newRole}(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          } catch (e) {
            console.error('Role change error:', e);
            Toast.error('ì—­í•  ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + e.message);
          }
        };

        // ë¬¸ì„œ ì‚­ì œ í•¸ë“¤ëŸ¬ (CSRF ë°©ì–´ - ê³µí†µ í—¬í¼ ì‚¬ìš©)
        const handleDeleteDoc = async (docId) => {
          const doc = allDocs.find(d => d.id === docId);
          if (!doc) return;

          // CSRF ë°©ì–´: 2ë‹¨ê³„ í™•ì¸ (ê³µí†µ í—¬í¼ ì‚¬ìš©)
          if (!confirmDeleteWithCSRF(doc.title)) return;

          try {
            const { error } = await supabase
              .from('ojt_docs')
              .delete()
              .eq('id', docId);

            if (error) throw error;

            setAllDocs(prev => prev.filter(d => d.id !== docId));
            Toast.success('ë¬¸ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          } catch (e) {
            console.error('Delete doc error:', e);
            Toast.error('ë¬¸ì„œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + e.message);
          }
        };

        // ë¶€ì„œ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
        const openTeamModal = (team = null) => {
          if (team) {
            setEditingTeam(team);
            setNewTeamName(team.name);
            setNewTeamSlug(team.slug || '');
            setNewTeamDesc(team.description || '');
          } else {
            setEditingTeam(null);
            setNewTeamName('');
            setNewTeamSlug('');
            setNewTeamDesc('');
          }
          setShowTeamModal(true);
        };

        // ë¶€ì„œëª…ì—ì„œ slug ìë™ ìƒì„±
        const generateSlug = (name) => {
          return name
            .toLowerCase()
            .replace(/[^a-z0-9ê°€-í£\s]/g, '')
            .replace(/\s+/g, '_')
            .substring(0, 50);
        };

        // ë¶€ì„œ ì €ì¥ (ì¶”ê°€/ìˆ˜ì •)
        const handleSaveTeam = async () => {
          if (!newTeamName.trim()) {
            Toast.error('ë¶€ì„œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
          }

          const slug = newTeamSlug.trim() || generateSlug(newTeamName);

          try {
            if (editingTeam) {
              // ìˆ˜ì •
              const { error } = await supabase
                .from('teams')
                .update({
                  name: newTeamName.trim(),
                  slug: slug,
                  description: newTeamDesc.trim() || null
                })
                .eq('id', editingTeam.id);

              if (error) throw error;

              setAllTeams(prev => prev.map(t =>
                t.id === editingTeam.id
                  ? { ...t, name: newTeamName.trim(), slug, description: newTeamDesc.trim() || null }
                  : t
              ));
              Toast.success('ë¶€ì„œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
              // ì¶”ê°€
              const maxOrder = allTeams.length > 0 ? Math.max(...allTeams.map(t => t.display_order || 0)) : 0;
              const { data, error } = await supabase
                .from('teams')
                .insert({
                  name: newTeamName.trim(),
                  slug: slug,
                  description: newTeamDesc.trim() || null,
                  display_order: maxOrder + 1,
                  is_active: true
                })
                .select()
                .single();

              if (error) throw error;

              setAllTeams(prev => [...prev, data]);
              Toast.success('ë¶€ì„œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }

            setShowTeamModal(false);
            setEditingTeam(null);
            setNewTeamName('');
            setNewTeamSlug('');
            setNewTeamDesc('');
          } catch (e) {
            console.error('Save team error:', e);
            Toast.error('ë¶€ì„œ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + e.message);
          }
        };

        // ë¶€ì„œ ì‚­ì œ
        const handleDeleteTeam = async (teamId) => {
          const team = allTeams.find(t => t.id === teamId);
          if (!team) return;

          // í•´ë‹¹ ë¶€ì„œì— ì†í•œ ë¬¸ì„œ ìˆ˜ í™•ì¸
          const docsInTeam = allDocs.filter(d => d.team === team.name || d.team_id === teamId).length;
          if (docsInTeam > 0) {
            Toast.error(`ì´ ë¶€ì„œì— ${docsInTeam}ê°œì˜ ë¬¸ì„œê°€ ìˆì–´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            return;
          }

          if (!confirmDeleteWithCSRF(team.name)) return;

          try {
            const { error } = await supabase
              .from('teams')
              .delete()
              .eq('id', teamId);

            if (error) throw error;

            setAllTeams(prev => prev.filter(t => t.id !== teamId));
            Toast.success('ë¶€ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          } catch (e) {
            console.error('Delete team error:', e);
            Toast.error('ë¶€ì„œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + e.message);
          }
        };

        // ë¶€ì„œ í™œì„±í™”/ë¹„í™œì„±í™” í† ê¸€
        const handleToggleTeamActive = async (teamId, currentStatus) => {
          try {
            const { error } = await supabase
              .from('teams')
              .update({ is_active: !currentStatus })
              .eq('id', teamId);

            if (error) throw error;

            setAllTeams(prev => prev.map(t =>
              t.id === teamId ? { ...t, is_active: !currentStatus } : t
            ));
            Toast.success(currentStatus ? 'ë¶€ì„œê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ë¶€ì„œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
          } catch (e) {
            console.error('Toggle team active error:', e);
            Toast.error('ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + e.message);
          }
        };

        // í†µê³„ ê³„ì‚°
        const stats = useMemo(() => {
          const totalUsers = allUsers.length;
          const totalDocs = allDocs.length;
          const totalRecords = allRecords.length;
          const passedRecords = allRecords.filter(r => r.passed).length;
          const passRate = totalRecords > 0 ? Math.round((passedRecords / totalRecords) * 100) : 0;

          return { totalUsers, totalDocs, totalRecords, passRate };
        }, [allUsers, allDocs, allRecords]);

        if (isLoading) {
          return (
            <div className="flex items-center justify-center min-h-[calc(100vh-80px)]">
              <div className="text-center">
                <div className="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p className="text-slate-600">ê´€ë¦¬ì ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
              </div>
            </div>
          );
        }

        return (
          <div className="max-w-7xl mx-auto px-4 py-8">
            <h2 className="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2">
              <Icon name="settings" className="w-7 h-7 text-red-600" />
              ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ
            </h2>

            {/* í†µê³„ ì¹´ë“œ */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
              <div className="bg-white rounded-xl shadow p-6">
                <p className="text-sm text-slate-500">ì „ì²´ ì‚¬ìš©ì</p>
                <p className="text-3xl font-bold text-slate-800">{stats.totalUsers}</p>
              </div>
              <div className="bg-white rounded-xl shadow p-6">
                <p className="text-sm text-slate-500">ì „ì²´ ë¬¸ì„œ</p>
                <p className="text-3xl font-bold text-indigo-600">{stats.totalDocs}</p>
              </div>
              <div className="bg-white rounded-xl shadow p-6">
                <p className="text-sm text-slate-500">í•™ìŠµ ê¸°ë¡</p>
                <p className="text-3xl font-bold text-green-600">{stats.totalRecords}</p>
              </div>
              <div className="bg-white rounded-xl shadow p-6">
                <p className="text-sm text-slate-500">í€´ì¦ˆ í†µê³¼ìœ¨</p>
                <p className="text-3xl font-bold text-amber-600">{stats.passRate}%</p>
              </div>
            </div>

            {/* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */}
            <div className="flex gap-2 mb-6 border-b border-slate-200 overflow-x-auto">
              <button
                onClick={() => setAdminTab('users')}
                className={`px-4 py-2 font-medium transition-colors whitespace-nowrap ${adminTab === 'users' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-slate-500 hover:text-slate-700'}`}
              >
                <Icon name="user" className="w-4 h-4 inline mr-1" /> ì‚¬ìš©ì ê´€ë¦¬
              </button>
              <button
                onClick={() => setAdminTab('content')}
                className={`px-4 py-2 font-medium transition-colors whitespace-nowrap ${adminTab === 'content' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-slate-500 hover:text-slate-700'}`}
              >
                <Icon name="book" className="w-4 h-4 inline mr-1" /> ì½˜í…ì¸  ê´€ë¦¬
              </button>
              <button
                onClick={() => setAdminTab('departments')}
                className={`px-4 py-2 font-medium transition-colors whitespace-nowrap ${adminTab === 'departments' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-slate-500 hover:text-slate-700'}`}
              >
                <Icon name="box" className="w-4 h-4 inline mr-1" /> ë¶€ì„œ ê´€ë¦¬
              </button>
              <button
                onClick={() => setAdminTab('stats')}
                className={`px-4 py-2 font-medium transition-colors whitespace-nowrap ${adminTab === 'stats' ? 'text-indigo-600 border-b-2 border-indigo-600' : 'text-slate-500 hover:text-slate-700'}`}
              >
                <Icon name="server" className="w-4 h-4 inline mr-1" /> í†µê³„
              </button>
            </div>

            {/* ì‚¬ìš©ì ê´€ë¦¬ íƒ­ */}
            {adminTab === 'users' && (
              <div className="bg-white rounded-xl shadow overflow-hidden">
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-slate-50">
                      <tr>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">ì´ë¦„</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">ì—­í• </th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">ë¶€ì„œ</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">ê°€ì…ì¼</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">ì‘ì—…</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                      {allUsers.map(u => (
                        <tr key={u.id} className="hover:bg-slate-50">
                          <td className="px-4 py-3 text-sm font-medium text-slate-800">{u.name}</td>
                          <td className="px-4 py-3">
                            <span className={`px-2 py-1 rounded-full text-xs font-bold uppercase ${
                              u.role === 'admin' ? 'bg-red-100 text-red-700' :
                              u.role === 'mentor' ? 'bg-indigo-100 text-indigo-700' :
                              'bg-green-100 text-green-700'
                            }`}>
                              {u.role}
                            </span>
                          </td>
                          <td className="px-4 py-3">
                            <select
                              value={u.department || ''}
                              onChange={(e) => handleDepartmentChange(u.id, e.target.value)}
                              className="px-2 py-1 text-sm border border-slate-200 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            >
                              <option value="">ë¶€ì„œ ì„ íƒ</option>
                              {[...new Set(allDocs.map(d => d.team).filter(Boolean))].sort().map(team => (
                                <option key={team} value={team}>{team}</option>
                              ))}
                            </select>
                          </td>
                          <td className="px-4 py-3 text-sm text-slate-500">
                            {new Date(u.created_at).toLocaleDateString('ko-KR')}
                          </td>
                          <td className="px-4 py-3">
                            <button
                              onClick={() => { setSelectedUser(u); setShowRoleModal(true); }}
                              className="text-indigo-600 hover:text-indigo-800 text-sm font-medium"
                              disabled={u.id === user.id}
                            >
                              ì—­í•  ë³€ê²½
                            </button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
                {allUsers.length === 0 && (
                  <div className="text-center py-8 text-slate-500">ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                )}
              </div>
            )}

            {/* ì½˜í…ì¸  ê´€ë¦¬ íƒ­ */}
            {adminTab === 'content' && (
              <div className="bg-white rounded-xl shadow overflow-hidden">
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-slate-50">
                      <tr>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">ì œëª©</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">íŒ€</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">ìŠ¤í…</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">ì‘ì„±ì</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">ìƒì„±ì¼</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">ì‘ì—…</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                      {allDocs.map(doc => (
                        <tr key={doc.id} className="hover:bg-slate-50">
                          <td className="px-4 py-3 text-sm font-medium text-slate-800">{doc.title}</td>
                          <td className="px-4 py-3 text-sm text-slate-600">{doc.team}</td>
                          <td className="px-4 py-3 text-sm text-slate-600">Step {doc.step}</td>
                          <td className="px-4 py-3 text-sm text-slate-600">{doc.author_name || '-'}</td>
                          <td className="px-4 py-3 text-sm text-slate-500">
                            {new Date(doc.created_at).toLocaleDateString('ko-KR')}
                          </td>
                          <td className="px-4 py-3">
                            <div className="flex gap-2">
                              <button
                                onClick={() => { setSelectedDoc(doc); setShowDocModal(true); }}
                                className="text-indigo-600 hover:text-indigo-800 text-sm font-medium"
                              >
                                ë³´ê¸°
                              </button>
                              <button
                                onClick={() => {
                                  // Mentor ëª¨ë“œë¡œ ì „í™˜ í›„ í¸ì§‘
                                  SecureSession.set('ojt_sessionMode', 'mentor');
                                  setSessionMode('mentor');
                                  // docì€ dbGetAllì—ì„œ ì´ë¯¸ camelCase ë§¤í•‘ë¨ (ì¤‘ì•™ ì§‘ì¤‘ì‹)
                                  handleEditDoc(doc);
                                  setViewState('mentor_dashboard');
                                }}
                                className="text-green-600 hover:text-green-800 text-sm font-medium"
                              >
                                í¸ì§‘
                              </button>
                              <button
                                onClick={() => handleDeleteDoc(doc.id)}
                                className="text-red-600 hover:text-red-800 text-sm font-medium"
                              >
                                ì‚­ì œ
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
                {allDocs.length === 0 && (
                  <div className="text-center py-8 text-slate-500">ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                )}
              </div>
            )}

            {/* ë¬¸ì„œ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ */}
            {showDocModal && selectedDoc && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                  <div className="p-6 border-b border-slate-200 flex justify-between items-start">
                    <div>
                      <h3 className="text-xl font-bold text-slate-800">{selectedDoc.title}</h3>
                      <div className="flex gap-2 mt-2">
                        <span className="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded">{selectedDoc.team}</span>
                        <span className="text-xs bg-slate-100 text-slate-700 px-2 py-1 rounded">Step {selectedDoc.step}</span>
                        <span className="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded">ì‘ì„±ì: {selectedDoc.author_name || '-'}</span>
                      </div>
                    </div>
                    <button
                      onClick={() => setShowDocModal(false)}
                      className="text-slate-400 hover:text-slate-600 text-2xl leading-none"
                    >
                      &times;
                    </button>
                  </div>
                  <div className="p-6 overflow-y-auto max-h-[60vh]">
                    {selectedDoc.sections && selectedDoc.sections.map((section, idx) => (
                      <div key={idx} className="mb-6">
                        <h4 className="text-lg font-semibold text-slate-800 mb-2 flex items-center gap-2">
                          <span className="w-6 h-6 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-sm font-bold">{idx + 1}</span>
                          {section.title}
                        </h4>
                        <div className="text-slate-600 text-sm whitespace-pre-wrap bg-slate-50 p-4 rounded-lg">
                          {section.content || 'ë‚´ìš© ì—†ìŒ'}
                        </div>
                      </div>
                    ))}
                    {selectedDoc.quiz && selectedDoc.quiz.length > 0 && (
                      <div className="mt-6 pt-6 border-t border-slate-200">
                        <h4 className="text-lg font-semibold text-slate-800 mb-3">í€´ì¦ˆ ({selectedDoc.quiz.length}ë¬¸ì œ)</h4>
                        <div className="space-y-3">
                          {selectedDoc.quiz.slice(0, 5).map((q, idx) => (
                            <div key={idx} className="bg-amber-50 p-3 rounded-lg">
                              <p className="text-sm font-medium text-slate-800">Q{idx + 1}. {q.question}</p>
                              <p className="text-xs text-green-600 mt-1">ì •ë‹µ: {q.answer}</p>
                            </div>
                          ))}
                          {selectedDoc.quiz.length > 5 && (
                            <p className="text-xs text-slate-500">... ì™¸ {selectedDoc.quiz.length - 5}ë¬¸ì œ</p>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                  <div className="p-4 border-t border-slate-200 flex justify-end gap-2">
                    <button
                      onClick={() => {
                        setShowDocModal(false);
                        // Mentor ëª¨ë“œë¡œ ì „í™˜ í›„ í¸ì§‘ (snake_case ìœ ì§€)
                        SecureSession.set('ojt_sessionMode', 'mentor');
                        setSessionMode('mentor');
                        handleEditDoc(selectedDoc);
                        setViewState('mentor_dashboard');
                      }}
                      className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700"
                    >
                      í¸ì§‘í•˜ê¸°
                    </button>
                    <button
                      onClick={() => setShowDocModal(false)}
                      className="px-4 py-2 bg-slate-100 text-slate-600 rounded-lg text-sm font-medium hover:bg-slate-200"
                    >
                      ë‹«ê¸°
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* ë¶€ì„œ ê´€ë¦¬ íƒ­ */}
            {adminTab === 'departments' && (
              <div className="bg-white rounded-xl shadow overflow-hidden">
                <div className="p-4 border-b border-slate-200 flex justify-between items-center">
                  <h3 className="text-lg font-semibold text-slate-800">ë¶€ì„œ ëª©ë¡</h3>
                  <button
                    onClick={() => openTeamModal()}
                    className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 flex items-center gap-1"
                  >
                    <Icon name="plus" className="w-4 h-4" /> ë¶€ì„œ ì¶”ê°€
                  </button>
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-slate-50">
                      <tr>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">ë¶€ì„œëª…</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">Slug</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">ì„¤ëª…</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">ë¬¸ì„œ ìˆ˜</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">ìƒíƒœ</th>
                        <th className="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase">ì‘ì—…</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                      {allTeams.map(team => {
                        const docCount = allDocs.filter(d => d.team === team.name || d.team_id === team.id).length;
                        return (
                          <tr key={team.id} className="hover:bg-slate-50">
                            <td className="px-4 py-3 text-sm font-medium text-slate-800">{team.name}</td>
                            <td className="px-4 py-3 text-sm text-slate-500 font-mono">{team.slug}</td>
                            <td className="px-4 py-3 text-sm text-slate-600">{team.description || '-'}</td>
                            <td className="px-4 py-3 text-sm text-slate-600">{docCount}ê°œ</td>
                            <td className="px-4 py-3">
                              <button
                                onClick={() => handleToggleTeamActive(team.id, team.is_active)}
                                className={`px-2 py-1 rounded-full text-xs font-bold ${
                                  team.is_active
                                    ? 'bg-green-100 text-green-700 hover:bg-green-200'
                                    : 'bg-slate-100 text-slate-500 hover:bg-slate-200'
                                }`}
                              >
                                {team.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}
                              </button>
                            </td>
                            <td className="px-4 py-3">
                              <div className="flex gap-2">
                                <button
                                  onClick={() => openTeamModal(team)}
                                  className="text-indigo-600 hover:text-indigo-800 text-sm font-medium"
                                >
                                  ìˆ˜ì •
                                </button>
                                <button
                                  onClick={() => handleDeleteTeam(team.id)}
                                  className="text-red-600 hover:text-red-800 text-sm font-medium"
                                  disabled={docCount > 0}
                                  title={docCount > 0 ? 'ë¬¸ì„œê°€ ìˆëŠ” ë¶€ì„œëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤' : ''}
                                >
                                  ì‚­ì œ
                                </button>
                              </div>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
                {allTeams.length === 0 && (
                  <div className="text-center py-8 text-slate-500">
                    ë¶€ì„œê°€ ì—†ìŠµë‹ˆë‹¤. ìƒë‹¨ì˜ "ë¶€ì„œ ì¶”ê°€" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë¶€ì„œë¥¼ ìƒì„±í•˜ì„¸ìš”.
                  </div>
                )}
              </div>
            )}

            {/* ë¶€ì„œ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ */}
            {showTeamModal && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-md">
                  <h3 className="text-lg font-semibold text-slate-800 mb-4">
                    {editingTeam ? 'ë¶€ì„œ ìˆ˜ì •' : 'ë¶€ì„œ ì¶”ê°€'}
                  </h3>
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-slate-700 mb-1">ë¶€ì„œëª… *</label>
                      <input
                        type="text"
                        value={newTeamName}
                        onChange={(e) => {
                          setNewTeamName(e.target.value);
                          if (!editingTeam && !newTeamSlug) {
                            // ì‹ ê·œ ìƒì„± ì‹œ slug ìë™ ìƒì„± (ì§ì ‘ ì…ë ¥ ì „ê¹Œì§€ë§Œ)
                          }
                        }}
                        placeholder="ì˜ˆ: ê°œë°œíŒ€"
                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-slate-700 mb-1">Slug (URLìš©)</label>
                      <input
                        type="text"
                        value={newTeamSlug}
                        onChange={(e) => setNewTeamSlug(e.target.value.toLowerCase().replace(/[^a-z0-9_]/g, ''))}
                        placeholder="ì˜ˆ: dev (ìë™ ìƒì„±ë¨)"
                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono"
                      />
                      <p className="text-xs text-slate-500 mt-1">ë¹„ì›Œë‘ë©´ ë¶€ì„œëª…ì—ì„œ ìë™ ìƒì„±ë©ë‹ˆë‹¤.</p>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-slate-700 mb-1">ì„¤ëª…</label>
                      <textarea
                        value={newTeamDesc}
                        onChange={(e) => setNewTeamDesc(e.target.value)}
                        placeholder="ë¶€ì„œì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…"
                        rows={2}
                        className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                      />
                    </div>
                  </div>
                  <div className="flex gap-2 mt-6">
                    <button
                      onClick={handleSaveTeam}
                      className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700"
                    >
                      {editingTeam ? 'ìˆ˜ì •' : 'ì¶”ê°€'}
                    </button>
                    <button
                      onClick={() => {
                        setShowTeamModal(false);
                        setEditingTeam(null);
                        setNewTeamName('');
                        setNewTeamSlug('');
                        setNewTeamDesc('');
                      }}
                      className="flex-1 px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium hover:bg-slate-300"
                    >
                      ì·¨ì†Œ
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* í†µê³„ íƒ­ */}
            {adminTab === 'stats' && (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="bg-white rounded-xl shadow p-6">
                  <h3 className="text-lg font-semibold text-slate-800 mb-4">ì—­í• ë³„ ì‚¬ìš©ì ë¶„í¬</h3>
                  <div className="w-64 h-64 mx-auto">
                    <canvas ref={chartRef}></canvas>
                  </div>
                </div>
                <div className="bg-white rounded-xl shadow p-6">
                  <h3 className="text-lg font-semibold text-slate-800 mb-4">íŒ€ë³„ ë¬¸ì„œ í˜„í™©</h3>
                  <div className="space-y-3">
                    {Object.entries(
                      allDocs.reduce((acc, doc) => {
                        acc[doc.team] = (acc[doc.team] || 0) + 1;
                        return acc;
                      }, {})
                    ).map(([team, count]) => (
                      <div key={team} className="flex items-center justify-between">
                        <span className="text-sm text-slate-600">{team}</span>
                        <div className="flex items-center gap-2">
                          <div className="w-32 bg-slate-200 rounded-full h-2">
                            <div
                              className="bg-indigo-600 h-2 rounded-full"
                              style={{ width: `${Math.min((count / allDocs.length) * 100, 100)}%` }}
                            ></div>
                          </div>
                          <span className="text-sm font-medium text-slate-800">{count}</span>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {/* ì—­í•  ë³€ê²½ ëª¨ë‹¬ */}
            {showRoleModal && selectedUser && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-md">
                  <h3 className="text-lg font-semibold text-slate-800 mb-4">ì—­í•  ë³€ê²½</h3>
                  <p className="text-sm text-slate-600 mb-4">
                    <strong>{selectedUser.name}</strong>ë‹˜ì˜ ì—­í• ì„ ë³€ê²½í•©ë‹ˆë‹¤.
                  </p>
                  <div className="grid grid-cols-3 gap-2 mb-6">
                    {['admin', 'mentor', 'mentee'].map(role => (
                      <button
                        key={role}
                        onClick={() => handleRoleChange(selectedUser.id, role)}
                        disabled={selectedUser.role === role}
                        className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                          selectedUser.role === role
                            ? 'bg-slate-100 text-slate-400 cursor-not-allowed'
                            : role === 'admin'
                            ? 'bg-red-100 text-red-700 hover:bg-red-200'
                            : role === 'mentor'
                            ? 'bg-indigo-100 text-indigo-700 hover:bg-indigo-200'
                            : 'bg-green-100 text-green-700 hover:bg-green-200'
                        }`}
                      >
                        {role.toUpperCase()}
                      </button>
                    ))}
                  </div>
                  <button
                    onClick={() => { setShowRoleModal(false); setSelectedUser(null); }}
                    className="w-full px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300"
                  >
                    ì·¨ì†Œ
                  </button>
                </div>
              </div>
            )}
          </div>
        );
      };

      const RoleSelectionPage = () => (
        <div className="flex flex-col items-center justify-center min-h-[calc(100vh-80px)] bg-slate-50 p-6">
          <div className="max-w-3xl w-full bg-white rounded-2xl shadow-xl p-8 text-center">
            <Icon name="user" className="w-16 h-16 text-indigo-600 mx-auto mb-4" />
            <h2 className="text-3xl font-bold text-slate-800 mb-2">í™˜ì˜í•©ë‹ˆë‹¤, {user?.name}!</h2>
            <p className="text-slate-500 mb-8">ì„œë¹„ìŠ¤ ì´ìš©ì„ ìœ„í•´ ì—­í• ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <button
                onClick={() => handleRoleSelect('mentor')}
                className="group flex flex-col items-center p-8 border-2 border-slate-200 rounded-xl hover:border-indigo-500 hover:bg-indigo-50 transition-all"
              >
                <div className="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                  <Icon name="upload" className="w-8 h-8 text-indigo-600" />
                </div>
                <h3 className="text-xl font-bold text-slate-700">ë©˜í†  (Mentor)</h3>
                <p className="text-slate-500 mt-2 text-sm">OJT ìë£Œë¥¼ ìƒì„±í•˜ê³ <br />êµìœ¡ ê³¼ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
              </button>

              <button
                onClick={() => handleRoleSelect('mentee')}
                className="group flex flex-col items-center p-8 border-2 border-slate-200 rounded-xl hover:border-green-500 hover:bg-green-50 transition-all"
              >
                <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                  <Icon name="book" className="w-8 h-8 text-green-600" />
                </div>
                <h3 className="text-xl font-bold text-slate-700">ë©˜í‹° (Mentee)</h3>
                <p className="text-slate-500 mt-2 text-sm">ê³µê°œëœ êµìœ¡ ìë£Œë¥¼ í•™ìŠµí•˜ê³ <br />í€´ì¦ˆë¡œ ì´í•´ë„ë¥¼ ê²€ì¦í•©ë‹ˆë‹¤.</p>
              </button>
            </div>
          </div>
        </div>
      );

      const mentorDashboardContent = (
        <div className="max-w-6xl mx-auto p-6">
          <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2 mb-4">
            <Icon name="upload" className="w-6 h-6 text-indigo-600" />
            {editingDoc ? 'ë¬¸ì„œ ìˆ˜ì •' : 'ìë£Œ ìƒì„± ìŠ¤íŠœë””ì˜¤'}
          </h2>

          {/* í¸ì§‘ ëª¨ë“œ ë°°ë„ˆ */}
          {editingDoc && (
            <div className="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg flex items-center justify-between">
              <div className="flex items-center gap-3">
                <Icon name="edit" className="w-5 h-5 text-blue-600" />
                <div>
                  <p className="font-semibold text-blue-800">í¸ì§‘ ëª¨ë“œ: {editingDoc.title}</p>
                  <p className="text-sm text-blue-600">{editingDoc.team} - Step {editingDoc.step}</p>
                </div>
              </div>
              <div className="flex items-center gap-2">
                {editingDoc.quiz?.length > 0 && (
                  <button
                    onClick={() => setShowQuizPreview(true)}
                    className="text-xs bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full hover:bg-indigo-200 transition"
                  >
                    í€´ì¦ˆ ë¯¸ë¦¬ë³´ê¸°/ìˆ˜ì • ({editingDoc.quiz.length}ë¬¸ì œ)
                  </button>
                )}
                <button
                  onClick={handleCancelEdit}
                  className="text-blue-600 hover:text-blue-800 text-sm font-semibold px-3 py-1 rounded hover:bg-blue-100"
                >
                  í¸ì§‘ ì·¨ì†Œ
                </button>
              </div>
            </div>
          )}

          {!aiStatus.online && (
            <div className="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg flex items-start gap-3">
              <Icon name="alert" className="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5" />
              <div>
                <p className="font-bold text-yellow-800">Gemini AI ì—°ê²° í™•ì¸ ì¤‘...</p>
                <p className="text-sm text-yellow-700 mt-1">
                  Google Gemini AIì— ì—°ê²°ì„ ì‹œë„í•˜ê³  ìˆìŠµë‹ˆë‹¤.<br />
                  API í‚¤ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.
                </p>
              </div>
            </div>
          )}

          {/* íƒ­ UI - í¸ì§‘/ë¯¸ë¦¬ë³´ê¸° ì „í™˜ */}
          <div className="flex gap-2 mb-4 border-b border-slate-200 pb-3">
            <button
              onClick={() => setEditorTab('edit')}
              className={`flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-bold transition-all ${
                editorTab === 'edit'
                  ? 'bg-indigo-600 text-white shadow-md'
                  : 'bg-white text-slate-600 hover:bg-slate-100 border border-slate-200'
              }`}
            >
              <Icon name="edit" className="w-4 h-4" />
              í¸ì§‘
            </button>
            <button
              onClick={() => setEditorTab('preview')}
              className={`flex items-center gap-2 px-5 py-2.5 rounded-lg text-sm font-bold transition-all ${
                editorTab === 'preview'
                  ? 'bg-indigo-600 text-white shadow-md'
                  : 'bg-white text-slate-600 hover:bg-slate-100 border border-slate-200'
              }`}
            >
              <Icon name="eye" className="w-4 h-4" />
              ë¯¸ë¦¬ë³´ê¸°
              {(generatedDoc || generatedDocs.length > 0) && (
                <span className="ml-1 w-2 h-2 bg-green-400 rounded-full animate-pulse" />
              )}
            </button>
          </div>

          {/* í¸ì§‘ íƒ­ */}
          {editorTab === 'edit' && (
            <div className="flex flex-col gap-4 bg-white p-6 rounded-xl shadow-sm border border-slate-200">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-xs font-bold text-slate-500 mb-1">ëŒ€ìƒ íŒ€</label>
                  {!isCustomTeam ? (
                    <select
                      value={inputTeam}
                      onChange={(e) => { e.target.value === 'custom' ? (setIsCustomTeam(true), setInputTeam('')) : setInputTeam(e.target.value) }}
                      className="w-full p-2 border border-slate-300 rounded-lg text-sm bg-indigo-50"
                    >
                      {TEAMS.map(team => <option key={team} value={team}>{team}</option>)}
                      <option value="custom">+ ì§ì ‘ ì…ë ¥</option>
                    </select>
                  ) : (
                    <div className="flex gap-2">
                      <input type="text" value={inputTeam} onChange={(e) => setInputTeam(e.target.value)} className="w-full p-2 border rounded-lg text-sm" autoFocus />
                      <button onClick={() => { setIsCustomTeam(false); setInputTeam(TEAMS[0]); }} className="p-2 bg-slate-200 rounded"><Icon name="refresh" className="w-4 h-4" /></button>
                    </div>
                  )}
                </div>
                <div>
                  <label className="block text-xs font-bold text-slate-500 mb-1">ë‹¨ê³„</label>
                  {!isCustomStep ? (
                    <select
                      value={inputStep}
                      onChange={(e) => { e.target.value === 'custom' ? (setIsCustomStep(true), setInputStep('')) : setInputStep(e.target.value) }}
                      className="w-full p-2 border border-slate-300 rounded-lg text-sm bg-indigo-50"
                    >
                      {STEPS.map(step => <option key={step} value={step}>Step {step}</option>)}
                      <option value="custom">+ ì§ì ‘ ì…ë ¥</option>
                    </select>
                  ) : (
                    <div className="flex gap-2">
                      <input type="number" value={inputStep} onChange={(e) => setInputStep(e.target.value)} className="w-full p-2 border rounded-lg text-sm" autoFocus />
                      <button onClick={() => { setIsCustomStep(false); setInputStep(1); }} className="p-2 bg-slate-200 rounded"><Icon name="refresh" className="w-4 h-4" /></button>
                    </div>
                  )}
                </div>
              </div>
              <input type="text" placeholder="ì œëª© (ì„ íƒì‚¬í•­ - AIê°€ ìë™ ìƒì„±)" className="w-full p-3 border rounded-lg" value={inputTitle} onChange={(e) => setInputTitle(e.target.value)} />

              {/* ìë™ ë¶„í•  ì˜µì…˜ */}
              <div className={`flex items-center justify-between p-3 rounded-lg border ${editingDoc ? 'bg-slate-100 border-slate-300' : 'bg-slate-50 border-slate-200'}`}>
                <div className="flex items-center gap-2">
                  <Icon name="split" className={`w-5 h-5 ${editingDoc ? 'text-slate-400' : 'text-indigo-600'}`} />
                  <div>
                    <p className={`text-sm font-medium ${editingDoc ? 'text-slate-500' : 'text-slate-700'}`}>ìë™ ìŠ¤í… ë¶„í• </p>
                    <p className="text-xs text-slate-500">
                      {editingDoc
                        ? 'í¸ì§‘ ëª¨ë“œì—ì„œëŠ” ìë™ ë¶„í• ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
                        : '40ë¶„ ì´ìƒ ë¶„ëŸ‰ì€ ìë™ìœ¼ë¡œ ì—¬ëŸ¬ ìŠ¤í…ìœ¼ë¡œ ë‚˜ëˆ•ë‹ˆë‹¤'}
                    </p>
                  </div>
                </div>
                <button
                  onClick={() => !editingDoc && setAutoSplit(!autoSplit)}
                  disabled={!!editingDoc}
                  className={`relative w-12 h-6 rounded-full transition-colors ${
                    editingDoc
                      ? 'bg-slate-300 cursor-not-allowed'
                      : autoSplit ? 'bg-indigo-600' : 'bg-slate-300'
                  }`}
                  title={editingDoc ? 'í¸ì§‘ ëª¨ë“œì—ì„œëŠ” ì‚¬ìš© ë¶ˆê°€' : ''}
                >
                  <span className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-transform ${autoSplit && !editingDoc ? 'left-7' : 'left-1'}`} />
                </button>
              </div>

              {/* ì˜ˆìƒ í•™ìŠµ ì‹œê°„ í‘œì‹œ */}
              {rawInput && (
                <div className={`flex items-center gap-3 p-3 rounded-lg border ${
                  estimatedTime > STEP_TIME_LIMIT
                    ? 'bg-amber-50 border-amber-200'
                    : 'bg-green-50 border-green-200'
                }`}>
                  <Icon name="clock" className={`w-5 h-5 ${estimatedTime > STEP_TIME_LIMIT ? 'text-amber-600' : 'text-green-600'}`} />
                  <div className="flex-1">
                    <p className={`text-sm font-medium ${estimatedTime > STEP_TIME_LIMIT ? 'text-amber-800' : 'text-green-800'}`}>
                      ì˜ˆìƒ í•™ìŠµ ì‹œê°„: ì•½ {estimatedTime}ë¶„
                    </p>
                    {requiredSteps > 1 && autoSplit && (
                      <p className="text-xs text-slate-600">
                        <Icon name="layers" className="w-3 h-3 inline mr-1" />
                        ìë™ìœ¼ë¡œ {requiredSteps}ê°œ ìŠ¤í…ìœ¼ë¡œ ë¶„í• ë©ë‹ˆë‹¤ (ìŠ¤í…ë‹¹ ì•½ {Math.ceil(estimatedTime / requiredSteps)}ë¶„)
                      </p>
                    )}
                    {requiredSteps > 1 && !autoSplit && (
                      <p className="text-xs text-amber-600">
                        âš ï¸ 40ë¶„ ì´ˆê³¼ ë¶„ëŸ‰ì…ë‹ˆë‹¤. ìë™ ë¶„í• ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
                      </p>
                    )}
                  </div>
                </div>
              )}

              {/* ì…ë ¥ íƒ€ì… ì„ íƒ */}
              <div className="flex gap-2 border-b border-slate-200 pb-2">
                {INPUT_TYPES.map(type => (
                  <button
                    key={type.id}
                    onClick={() => setInputType(type.id)}
                    className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                      inputType === type.id
                        ? 'bg-indigo-600 text-white'
                        : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                    }`}
                  >
                    <Icon name={type.icon} className="w-4 h-4" />
                    {type.label}
                  </button>
                ))}
              </div>

              {/* ì…ë ¥ íƒ€ì…ë³„ UI */}
              {inputType === 'text' && (
                <div className="border border-slate-300 rounded-lg overflow-hidden relative">
                  <div ref={quillRef} />
                  {/* ì´ë¯¸ì§€ ì—…ë¡œë“œ ë¡œë”© ì˜¤ë²„ë ˆì´ */}
                  {isUploadingImage && (
                    <div className="absolute inset-0 bg-white/80 flex items-center justify-center z-10">
                      <div className="flex flex-col items-center gap-2">
                        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                        <span className="text-sm text-slate-600">ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...</span>
                      </div>
                    </div>
                  )}
                </div>
              )}

              {inputType === 'url' && (
                <div className="space-y-3">
                  <div className="flex gap-2">
                    <div className="flex-1 relative">
                      <Icon name="globe" className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" />
                      <input
                        type="url"
                        placeholder="https://example.com/article"
                        value={urlInput}
                        onChange={(e) => setUrlInput(e.target.value)}
                        className="w-full pl-10 p-3 border rounded-lg"
                      />
                    </div>
                  </div>
                  <p className="text-xs text-slate-500">
                    ğŸš€ Gemini URL Context Toolë¡œ ì›ë¬¸ì„ ì§ì ‘ ë¶„ì„í•˜ì—¬ í€´ì¦ˆë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ì›ë¬¸ì€ ê·¸ëŒ€ë¡œ ë³´ì¡´ë©ë‹ˆë‹¤.
                  </p>
                </div>
              )}

              {inputType === 'pdf' && (
                <div className="space-y-3">
                  <label className="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-slate-300 rounded-lg cursor-pointer hover:bg-slate-50 transition-colors">
                    <div className="flex flex-col items-center justify-center pt-5 pb-6">
                      <Icon name="file" className="w-10 h-10 mb-3 text-slate-400" />
                      {pdfFile ? (
                        <p className="text-sm text-indigo-600 font-medium">{pdfFile.name}</p>
                      ) : (
                        <>
                          <p className="mb-2 text-sm text-slate-500">
                            <span className="font-semibold">í´ë¦­í•˜ì—¬ PDF ì„ íƒ</span>
                          </p>
                          <p className="text-xs text-slate-400">PDF íŒŒì¼ë§Œ ì§€ì›</p>
                        </>
                      )}
                    </div>
                    <input
                      type="file"
                      accept=".pdf"
                      className="hidden"
                      onChange={(e) => setPdfFile(e.target.files?.[0] || null)}
                    />
                  </label>
                  {pdfFile && (
                    <>
                      <button
                        onClick={() => setPdfFile(null)}
                        className="text-sm text-red-500 hover:text-red-700"
                      >
                        íŒŒì¼ ì œê±°
                      </button>
                      <p className="text-xs text-slate-500">
                        ğŸš€ PDFê°€ R2ì— ì—…ë¡œë“œë˜ê³ , Gemini URL Context Toolë¡œ ë¶„ì„í•˜ì—¬ í€´ì¦ˆë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
                      </p>
                    </>
                  )}
                </div>
              )}

              <button
                onClick={handleGenerate}
                disabled={isProcessing || !aiStatus.online ||
                  (inputType === 'text' && !rawInput) ||
                  (inputType === 'url' && !urlInput) ||
                  (inputType === 'pdf' && !pdfFile)
                }
                className="w-full py-3 bg-indigo-600 text-white rounded-lg font-bold disabled:bg-slate-400 hover:bg-indigo-700 transition-colors"
              >
                {isProcessing ? processingStatus || "ìƒì„± ì¤‘..." : `AI ìë£Œ ìƒì„± (${GEMINI_MODEL})`}
              </button>
            </div>
          )}

          {/* ë¯¸ë¦¬ë³´ê¸° íƒ­ */}
          {editorTab === 'preview' && (
            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
              <div className="sticky top-0 bg-white pb-4 border-b border-slate-200 z-10">
                <div className="flex justify-between items-center">
                  <div className="flex items-center gap-3">
                    <button
                      onClick={() => setEditorTab('edit')}
                      className="flex items-center gap-1 text-sm text-slate-500 hover:text-indigo-600 transition-colors"
                    >
                      <Icon name="edit" className="w-4 h-4" />
                      í¸ì§‘ìœ¼ë¡œ
                    </button>
                    <h3 className="font-semibold text-slate-700">
                      ë¯¸ë¦¬ë³´ê¸°
                      {generatedDocs.length > 1 && (
                        <span className="ml-2 text-xs font-normal text-indigo-600">
                          ({generatedDocs.length}ê°œ ìŠ¤í… ìƒì„±ë¨)
                        </span>
                      )}
                    </h3>
                  </div>
                  {(generatedDoc || generatedDocs.length > 0) && (
                    <button onClick={handleSaveToDB} className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg font-bold text-sm hover:bg-green-700">
                      <Icon name="save" className="w-4 h-4" />
                      {editingDoc ? 'ìˆ˜ì • ì €ì¥' : (generatedDocs.length > 1 ? `${generatedDocs.length}ê°œ ëª¨ë‘ ì €ì¥` : 'ì €ì¥')}
                    </button>
                  )}
                </div>

                {/* ì—¬ëŸ¬ ìŠ¤í…ì¸ ê²½ìš° íƒ­ UI */}
                {generatedDocs.length > 1 && (
                  <div className="flex gap-1 mt-3 overflow-x-auto pb-2">
                    {generatedDocs.map((doc, idx) => (
                      <button
                        key={idx}
                        onClick={() => setGeneratedDoc(doc)}
                        className={`px-3 py-1.5 text-xs font-medium rounded-lg whitespace-nowrap transition-colors ${
                          generatedDoc === doc
                            ? 'bg-indigo-600 text-white'
                            : 'bg-white text-slate-600 hover:bg-slate-100 border border-slate-200'
                        }`}
                      >
                        Step {doc.step}
                        {doc.estimated_minutes && (
                          <span className="ml-1 opacity-70">({doc.estimated_minutes}ë¶„)</span>
                        )}
                      </button>
                    ))}
                  </div>
                )}
              </div>

              <div className="mt-4">
                {generatedDoc ? (
                  <div>
                    <div className="flex items-center gap-2 mb-4">
                      <h1 className="text-xl font-bold">{generatedDoc.title}</h1>
                      {generatedDoc.ai_processed === false && (
                        <span className="text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded-full flex items-center gap-1">
                          âš ï¸ AI ë¯¸ì²˜ë¦¬
                        </span>
                      )}
                      {generatedDoc.estimated_minutes && (
                        <span className="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full flex items-center gap-1">
                          <Icon name="clock" className="w-3 h-3" />
                          ì•½ {generatedDoc.estimated_minutes}ë¶„
                        </span>
                      )}
                    </div>
                    {/* AI ë¯¸ì²˜ë¦¬ ì•Œë¦¼ ë°°ë„ˆ */}
                    {generatedDoc.ai_processed === false && (
                      <div className="my-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                        <div className="flex items-start gap-3">
                          <span className="text-amber-500 text-lg">âš ï¸</span>
                          <div>
                            <p className="text-sm font-medium text-amber-800">AI ë¶„ì„ ì‹¤íŒ¨</p>
                            <p className="text-xs text-amber-700 mt-1">
                              {generatedDoc.ai_error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}ë¡œ ì¸í•´ í€´ì¦ˆê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
                            </p>
                            <p className="text-xs text-amber-600 mt-1">
                              ì›ë¬¸ì€ ì •ìƒì ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤. ì¶”í›„ AI ë³µêµ¬ ì‹œ ì¬ìƒì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.
                            </p>
                          </div>
                        </div>
                      </div>
                    )}
                    {generatedDoc.totalSteps > 1 && (
                      <p className="text-xs text-slate-500 mb-3">
                        ğŸ“š ì „ì²´ {generatedDoc.totalSteps}ê°œ ìŠ¤í… ì¤‘ {generatedDoc.stepIndex}ë²ˆì§¸
                      </p>
                    )}

                    {/* URL/PDF ì›ë¬¸ ë³´ê¸° - snake_case í•„ë“œ ì‚¬ìš© (DB ìŠ¤í‚¤ë§ˆ ì¼ì¹˜) */}
                    {/* ğŸ” DEBUG: ë Œë”ë§ ì¡°ê±´ ê²€ì¦ */}
                    {DEBUG.enabled && DEBUG.checkRenderCondition('Mentor ë¯¸ë¦¬ë³´ê¸° - ì›ë¬¸ ë³´ê¸° ë²„íŠ¼', {
                      'source_type': generatedDoc?.source_type,
                      'source_url': generatedDoc?.source_url,
                      'source_file': generatedDoc?.source_file,
                      'URL ì¡°ê±´': generatedDoc?.source_type === 'url' && !!generatedDoc?.source_url,
                      'PDF ì¡°ê±´': generatedDoc?.source_type === 'pdf' && !!generatedDoc?.source_file
                    })}
                    {generatedDoc.source_type === 'url' && generatedDoc.source_url && (
                      <div className="my-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <div className="flex items-center gap-3">
                          <Icon name="globe" className="w-6 h-6 text-blue-600" />
                          <div className="flex-1">
                            <p className="text-sm font-medium text-blue-800">URL ì›ë¬¸ ìë£Œ</p>
                            <p className="text-xs text-blue-600 truncate">{generatedDoc.source_url}</p>
                          </div>
                          <button
                            onClick={() => safeOpenUrl(generatedDoc.source_url)}
                            className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition"
                          >
                            ì›ë¬¸ ë³´ê¸° â†—
                          </button>
                        </div>
                      </div>
                    )}

                    {generatedDoc.source_type === 'pdf' && generatedDoc.source_file && (
                      <div className="my-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                        <div className="flex items-center gap-3">
                          <Icon name="file" className="w-6 h-6 text-red-600" />
                          <div className="flex-1">
                            <p className="text-sm font-medium text-red-800">PDF ì›ë¬¸ ìë£Œ</p>
                            <p className="text-xs text-red-600 truncate">R2 ì €ì¥ë¨</p>
                          </div>
                          <button
                            onClick={() => window.open(`https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(generatedDoc.source_file)}`, '_blank')}
                            className="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 transition"
                          >
                            PDF ë³´ê¸° â†—
                          </button>
                        </div>
                      </div>
                    )}

                    {/* ê¸°ì¡´ ì„¹ì…˜ ê¸°ë°˜ ì½˜í…ì¸  (manual íƒ€ì…) */}
                    {generatedDoc.sections?.length > 0 && generatedDoc.sections.map((s, i) => (
                      <div key={i} className="my-4 bg-white p-4 rounded shadow-sm">
                        <h3 className="font-bold text-indigo-700">{s.title}</h3>
                        <p className="text-sm text-slate-600 whitespace-pre-line mt-2">{s.content}</p>
                      </div>
                    ))}
                    <div className="flex items-center gap-3 mt-4">
                      <p className="text-sm text-slate-500">í€´ì¦ˆ {generatedDoc.quiz?.length || 0}ë¬¸ì œ ìƒì„±ë¨</p>
                      {generatedDoc.quiz?.length > 0 && (
                        <button
                          onClick={() => setShowQuizPreview(true)}
                          className="text-xs bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full hover:bg-indigo-200 transition"
                        >
                          í€´ì¦ˆ ë¯¸ë¦¬ë³´ê¸°
                        </button>
                      )}
                    </div>
                  </div>
                ) : (
                  <div className="flex justify-center items-center h-64 text-slate-400">ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
                )}
              </div>
            </div>
          )}

          {/* í€´ì¦ˆ ë¯¸ë¦¬ë³´ê¸°/ìˆ˜ì • ëª¨ë‹¬ */}
          {showQuizPreview && (generatedDoc?.quiz || editingDoc?.quiz) && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[85vh] overflow-hidden">
                <div className="p-4 border-b border-slate-200 flex justify-between items-center">
                  <div className="flex items-center gap-3">
                    <h3 className="text-lg font-bold text-slate-800">
                      í€´ì¦ˆ {quizEditMode ? 'ìˆ˜ì •' : 'ë¯¸ë¦¬ë³´ê¸°'} ({(generatedDoc?.quiz || editingDoc?.quiz).length}ë¬¸ì œ)
                    </h3>
                    <button
                      onClick={() => setQuizEditMode(!quizEditMode)}
                      className={`px-3 py-1 text-xs font-medium rounded-full transition ${quizEditMode ? 'bg-green-100 text-green-700' : 'bg-indigo-100 text-indigo-700 hover:bg-indigo-200'}`}
                    >
                      {quizEditMode ? 'âœ“ ìˆ˜ì • ëª¨ë“œ' : 'ìˆ˜ì •í•˜ê¸°'}
                    </button>
                  </div>
                  <button
                    onClick={() => { setShowQuizPreview(false); setQuizEditMode(false); }}
                    className="text-slate-400 hover:text-slate-600 text-2xl leading-none"
                  >&times;</button>
                </div>
                <div className="p-4 overflow-y-auto max-h-[calc(85vh-120px)]">
                  {(generatedDoc?.quiz || editingDoc?.quiz).map((q, idx) => (
                    <div key={idx} className="mb-4 p-4 bg-slate-50 rounded-lg">
                      <div className="flex items-start gap-2">
                        <span className="bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded">{idx + 1}</span>
                        {quizEditMode ? (
                          <input
                            type="text"
                            value={q.question}
                            onChange={(e) => handleQuizQuestionChange(idx, e.target.value)}
                            className="flex-1 px-2 py-1 border border-slate-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                          />
                        ) : (
                          <p className="font-medium text-slate-800 flex-1">{q.question}</p>
                        )}
                        {quizEditMode && (
                          <button
                            onClick={() => handleQuizDelete(idx)}
                            className="text-red-500 hover:text-red-700 text-sm px-2"
                            title="ì‚­ì œ"
                          >âœ•</button>
                        )}
                      </div>
                      <div className="mt-3 space-y-2 ml-7">
                        {q.options?.map((opt, optIdx) => (
                          <div key={optIdx} className={`p-2 rounded text-sm flex items-center gap-2 ${(q.answer === opt || q.correct === optIdx) ? 'bg-green-100 text-green-800 font-medium border border-green-300' : 'bg-white border border-slate-200'}`}>
                            {quizEditMode && (
                              <input
                                type="radio"
                                name={`quiz-${idx}-correct`}
                                checked={q.correct === optIdx || q.answer === opt}
                                onChange={() => handleQuizCorrectChange(idx, optIdx)}
                                className="w-4 h-4 text-green-600"
                                title="ì •ë‹µìœ¼ë¡œ ì„¤ì •"
                              />
                            )}
                            {quizEditMode ? (
                              <input
                                type="text"
                                value={opt}
                                onChange={(e) => handleQuizOptionChange(idx, optIdx, e.target.value)}
                                className="flex-1 px-2 py-1 border border-slate-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                              />
                            ) : (
                              <span className="flex-1">{opt}</span>
                            )}
                            {!quizEditMode && (q.answer === opt || q.correct === optIdx) && <span>âœ“</span>}
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
                <div className="p-4 border-t border-slate-200 flex justify-between">
                  <span className="text-xs text-slate-500">
                    {quizEditMode ? 'ë¼ë””ì˜¤ ë²„íŠ¼ìœ¼ë¡œ ì •ë‹µ ì„ íƒ' : 'ë…¹ìƒ‰ = ì •ë‹µ'}
                  </span>
                  <button
                    onClick={() => { setShowQuizPreview(false); setQuizEditMode(false); }}
                    className="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200"
                  >ë‹«ê¸°</button>
                </div>
              </div>
            </div>
          )}

          {/* ë‚´ê°€ ë§Œë“  ìë£Œ ëª©ë¡ */}
          {myDocs.length > 0 && (
            <div className="mt-8">
              <h3 className="text-lg font-bold text-slate-800 mb-4">ë‚´ê°€ ë§Œë“  ìë£Œ ({myDocs.length})</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {myDocs.map(doc => (
                  <div key={doc.id} className="bg-white p-4 rounded-xl shadow border flex justify-between items-start">
                    <div className="flex-1">
                      <span className="text-xs font-bold bg-indigo-100 text-indigo-700 px-2 py-1 rounded">{doc.team} - Step {doc.step}</span>
                      <h4 className="font-bold mt-2">{doc.title}</h4>
                      {doc.updated_at && (
                        <p className="text-xs text-slate-400 mt-1">ìˆ˜ì •ë¨: {new Date(doc.updated_at).toLocaleDateString()}</p>
                      )}
                    </div>
                    <div className="flex gap-2 ml-2">
                      <button
                        onClick={() => handleEditDoc(doc)}
                        className="text-indigo-500 hover:text-indigo-700 p-1"
                        title="í¸ì§‘"
                      >
                        <Icon name="edit" className="w-4 h-4" />
                      </button>
                      <button
                        onClick={() => handleDeleteDoc(doc.id)}
                        className="text-red-500 hover:text-red-700 p-1"
                        title="ì‚­ì œ"
                      >
                        <Icon name="trash" className="w-4 h-4" />
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      );

      // ë©˜í‹° ë¬¸ì„œ ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜
      const refreshPublicDocs = async () => {
        const allDocs = await dbGetAll("ojt_docs");
        allDocs.sort((a, b) => new Date(b.created_at || 0).getTime() - new Date(a.created_at || 0).getTime());
        setPublicDocs(allDocs);
      };

      // ë©˜í‹° ë¦¬ìŠ¤íŠ¸ ê³„ì‚°ê°’ (useMemoë¡œ ìµœì í™”)
      const availableTeams = useMemo(() =>
        Array.from(new Set(publicDocs.map(doc => doc.team).filter(Boolean))),
        [publicDocs]
      );
      const teamDocs = useMemo(() =>
        selectedTeam ? publicDocs.filter(doc => doc.team === selectedTeam).sort((a, b) => (a.step || 0) - (b.step || 0)) : [],
        [publicDocs, selectedTeam]
      );

      // ë©˜í‹° ë¦¬ìŠ¤íŠ¸ JSX
      const menteeListContent = !selectedTeam ? (
        <div className="max-w-4xl mx-auto p-6">
          <div className="flex justify-between items-center mb-6">
            <h2 className="text-2xl font-bold text-slate-800">í•™ìŠµí•  íŒ€ì„ ì„ íƒí•˜ì„¸ìš”</h2>
            <button onClick={refreshPublicDocs} className="text-slate-500 hover:text-slate-700">
              <Icon name="refresh" className="w-5 h-5" />
            </button>
          </div>
          {availableTeams.length > 0 ? (
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              {availableTeams.map(team => (
                <button key={team} onClick={() => setSelectedTeam(team)} className="bg-white p-6 rounded-xl shadow hover:shadow-lg border text-left transition-shadow">
                  <h3 className="font-bold text-lg text-slate-800">{team}</h3>
                  <p className="text-sm text-slate-500 mt-1">{publicDocs.filter(d => d.team === team).length}ê°œ ê³¼ì •</p>
                </button>
              ))}
            </div>
          ) : (
            <div className="text-center py-16 text-slate-500">
              <Icon name="book" className="w-16 h-16 mx-auto mb-4 text-slate-300" />
              <p>ì•„ì§ ë“±ë¡ëœ êµìœ¡ ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
              <p className="text-sm mt-2">ë©˜í† ê°€ ìë£Œë¥¼ ë“±ë¡í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
          )}
        </div>
      ) : (
        <div className="max-w-4xl mx-auto p-6">
          <button onClick={() => setSelectedTeam(null)} className="mb-4 text-slate-500 hover:text-slate-700">&larr; ë’¤ë¡œê°€ê¸°</button>
          <h2 className="text-2xl font-bold mb-6">{selectedTeam} ë¡œë“œë§µ</h2>
          <div className="space-y-4">
            {teamDocs.map((doc) => (
              <div key={doc.id} className="bg-white p-6 rounded-xl shadow border flex justify-between items-center">
                <div>
                  <span className="text-xs font-bold bg-indigo-100 text-indigo-700 px-2 py-1 rounded">Step {doc.step}</span>
                  <h3 className="font-bold text-lg mt-2">{doc.title}</h3>
                  <p className="text-xs text-slate-400 mt-1">ì‘ì„±ì: {doc.author_name}</p>
                </div>
                <button onClick={() => handleSelectDoc(doc)} className="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition-colors">í•™ìŠµí•˜ê¸°</button>
              </div>
            ))}
          </div>
        </div>
      );

      // ë©˜í‹° í•™ìŠµ JSX
      const menteeStudyContent = selectedDoc ? (
        <div className="max-w-4xl mx-auto p-6">
          <button onClick={() => { setViewState('mentee_list'); setSelectedDoc(null); }} className="mb-4 text-slate-500 hover:text-slate-700">&larr; ëª©ë¡ìœ¼ë¡œ</button>

          {!quizMode ? (
            <div className="bg-white p-8 rounded-xl shadow border">
              <div className="flex justify-between items-start mb-6">
                <div>
                  <span className="text-xs font-bold bg-indigo-100 text-indigo-700 px-2 py-1 rounded">{selectedDoc.team} - Step {selectedDoc.step}</span>
                  <h1 className="text-2xl font-bold mt-2">{selectedDoc.title}</h1>
                  <p className="text-sm text-slate-400 mt-1">ì‘ì„±ì: {selectedDoc.author_name}</p>
                </div>
              </div>

              {/* URL ì›ë¬¸ ë³´ê¸° - snake_case í•„ë“œ ì‚¬ìš© (DB ìŠ¤í‚¤ë§ˆ ì¼ì¹˜) */}
              {/* ğŸ” DEBUG: Mentee í•™ìŠµ í™”ë©´ ë Œë”ë§ ì¡°ê±´ ê²€ì¦ */}
              {DEBUG.enabled && DEBUG.checkRenderCondition('Mentee í•™ìŠµ - ì›ë¬¸ ë³´ê¸° ë²„íŠ¼', {
                'source_type': selectedDoc?.source_type,
                'source_url': selectedDoc?.source_url,
                'source_file': selectedDoc?.source_file,
                'author_id': selectedDoc?.author_id,
                'URL ì¡°ê±´': selectedDoc?.source_type === 'url' && !!selectedDoc?.source_url,
                'PDF ì¡°ê±´': selectedDoc?.source_type === 'pdf' && !!selectedDoc?.source_file
              })}
              {selectedDoc.source_type === 'url' && selectedDoc.source_url && (
                <div className="mb-6 p-6 bg-blue-50 border-2 border-blue-200 rounded-xl">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-4">
                      <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <Icon name="globe" className="w-6 h-6 text-blue-600" />
                      </div>
                      <div>
                        <p className="font-semibold text-blue-800">ì›¹í˜ì´ì§€ í•™ìŠµ ìë£Œ</p>
                        <p className="text-sm text-blue-600">ì›ë¬¸ì„ ë¨¼ì € ì½ì€ í›„ í€´ì¦ˆì— ë„ì „í•˜ì„¸ìš”</p>
                      </div>
                    </div>
                    <button
                      onClick={() => safeOpenUrl(selectedDoc.source_url)}
                      className="px-6 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition flex items-center gap-2"
                    >
                      <Icon name="eye" className="w-5 h-5" />
                      ì›ë¬¸ ë³´ê¸°
                    </button>
                  </div>
                </div>
              )}

              {/* PDF ì›ë¬¸ ë³´ê¸° */}
              {selectedDoc.source_type === 'pdf' && selectedDoc.source_file && (
                <div className="mb-6 p-6 bg-red-50 border-2 border-red-200 rounded-xl">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-4">
                      <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                        <Icon name="file" className="w-6 h-6 text-red-600" />
                      </div>
                      <div>
                        <p className="font-semibold text-red-800">PDF í•™ìŠµ ìë£Œ</p>
                        <p className="text-sm text-red-600">PDFë¥¼ ë¨¼ì € ì½ì€ í›„ í€´ì¦ˆì— ë„ì „í•˜ì„¸ìš”</p>
                      </div>
                    </div>
                    <button
                      onClick={() => window.open(`https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(selectedDoc.source_file)}`, '_blank')}
                      className="px-6 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition flex items-center gap-2"
                    >
                      <Icon name="eye" className="w-5 h-5" />
                      PDF ë³´ê¸°
                    </button>
                  </div>
                </div>
              )}

              {/* AI ë¯¸ì²˜ë¦¬ ë¬¸ì„œ ì•Œë¦¼ */}
              {selectedDoc.ai_processed === false && (
                <div className="mb-6 p-4 bg-amber-50 border-2 border-amber-200 rounded-xl">
                  <div className="flex items-start gap-3">
                    <span className="text-amber-500 text-xl">âš ï¸</span>
                    <div>
                      <p className="font-semibold text-amber-800">AI ë¯¸ì²˜ë¦¬ ë¬¸ì„œ</p>
                      <p className="text-sm text-amber-700 mt-1">
                        ì´ ë¬¸ì„œëŠ” AI ë¶„ì„ ì—†ì´ ì›ë¬¸ ê·¸ëŒ€ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. í€´ì¦ˆê°€ ì œê³µë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                      </p>
                      {selectedDoc.ai_error && (
                        <p className="text-xs text-amber-600 mt-2">ì‚¬ìœ : {selectedDoc.ai_error}</p>
                      )}
                    </div>
                  </div>
                </div>
              )}

              {/* ê¸°ì¡´ ì„¹ì…˜ ê¸°ë°˜ ì½˜í…ì¸  (manual íƒ€ì…) */}
              {selectedDoc.sections?.length > 0 && selectedDoc.sections.map((s, i) => (
                <div key={i} className="mb-6">
                  <h3 className="font-bold text-indigo-700 mb-2">{s.title}</h3>
                  <p className="whitespace-pre-line text-slate-700">{s.content}</p>
                </div>
              ))}

              {/* í€´ì¦ˆ ë²„íŠ¼ - í€´ì¦ˆê°€ ìˆì„ ë•Œë§Œ í‘œì‹œ */}
              {selectedDoc.quiz && selectedDoc.quiz.length >= CONFIG.QUIZ_QUESTIONS_PER_TEST ? (
                <button onClick={startQuizSession} className="w-full py-4 bg-indigo-600 text-white rounded-lg font-bold mt-8 hover:bg-indigo-700 transition-colors">
                  í€´ì¦ˆ ë„ì „ ({selectedDoc.quiz.length}ë¬¸ì œ ì¤‘ 4ë¬¸ì œ ì¶œì œ)
                </button>
              ) : (
                <div className="w-full py-4 bg-slate-100 text-slate-500 rounded-lg font-bold mt-8 text-center">
                  {selectedDoc.ai_processed === false
                    ? 'í€´ì¦ˆ ì—†ìŒ (AI ë¯¸ì²˜ë¦¬ ë¬¸ì„œ)'
                    : `í€´ì¦ˆ ë¶€ì¡± (${selectedDoc.quiz?.length || 0}ë¬¸ì œ - ìµœì†Œ ${CONFIG.QUIZ_QUESTIONS_PER_TEST}ë¬¸ì œ í•„ìš”)`}
                </div>
              )}
            </div>
          ) : (
            <div className="bg-white p-8 rounded-xl shadow border">
              {!quizSubmitted ? (
                <div>
                  <div className="flex justify-between mb-4">
                    <span className="font-bold text-indigo-600">Q{currentQuizIndex + 1} / 4</span>
                    <button onClick={() => setQuizMode(false)} className="text-slate-400 hover:text-slate-600"><Icon name="x" /></button>
                  </div>
                  <h3 className="text-xl font-bold mb-6">{activeQuizSet[currentQuizIndex]?.question}</h3>
                  <div className="space-y-2">
                    {activeQuizSet[currentQuizIndex]?.options?.map((opt, i) => (
                      <button
                        key={i}
                        onClick={() => handleAnswerSelect(currentQuizIndex, i)}
                        className={`w-full p-4 border rounded text-left transition-colors ${selectedAnswers[currentQuizIndex] === i ? 'bg-indigo-50 border-indigo-600' : 'hover:bg-slate-50'}`}
                      >
                        {opt}
                      </button>
                    ))}
                  </div>
                  <div className="flex justify-between mt-6">
                    <button
                      onClick={() => setCurrentQuizIndex(prev => Math.max(0, prev - 1))}
                      disabled={currentQuizIndex === 0}
                      className="text-slate-400 disabled:opacity-50"
                    >
                      ì´ì „
                    </button>
                    {currentQuizIndex < 3 ? (
                      <button onClick={() => setCurrentQuizIndex(prev => prev + 1)} className="bg-slate-800 text-white px-4 py-2 rounded hover:bg-slate-900">ë‹¤ìŒ</button>
                    ) : (
                      <button onClick={submitQuiz} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">ì œì¶œ</button>
                    )}
                  </div>
                </div>
              ) : (
                <div className="text-center py-8">
                  <h2 className="text-3xl font-bold mb-2">{passed ? "í†µê³¼!" : "ì•„ì‰¬ì›Œìš”"}</h2>
                  <p className="text-xl mb-2 text-slate-600">{score} / 4 ë¬¸ì œ ì •ë‹µ</p>
                  <p className="text-slate-500 mb-6">{passed ? "í›Œë¥­í•©ë‹ˆë‹¤! ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°€ì„¸ìš”." : `${QUIZ_PASS_THRESHOLD}ë¬¸ì œ ì´ìƒ ë§ì¶°ì•¼ í†µê³¼ì…ë‹ˆë‹¤.`}</p>
                  <div className="flex gap-4 justify-center">
                    {!passed && (
                      <button onClick={startQuizSession} className="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700">ë‹¤ì‹œ ë„ì „</button>
                    )}
                    <button onClick={() => { setViewState('mentee_list'); setSelectedDoc(null); setSelectedTeam(null); }} className="bg-slate-600 text-white px-6 py-2 rounded hover:bg-slate-700">ëª©ë¡ìœ¼ë¡œ</button>
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
      ) : null;

      // =========================================
      // Main Render
      // =========================================

      // ë¡œë”© ì¤‘ (ì´ˆê¸° ë¡œë“œ ë˜ëŠ” ì¸ì¦ ì²˜ë¦¬ ì¤‘)
      if (isLoadingAuth || viewState === 'loading') {
        return (
          <div className="flex h-screen items-center justify-center">
            <Icon name="refresh" className="w-8 h-8 animate-spin text-indigo-600" />
          </div>
        );
      }

      // ë¡œê·¸ì¸ í˜ì´ì§€
      if (viewState === 'login') {
        return <LoginPage />;
      }

      // ë©”ì¸ ì•± (ë¡œê·¸ì¸ í›„)
      return (
        <div className="min-h-screen bg-slate-50 font-sans text-slate-900">
          <Header />
          {/* Admin ì„ì‹œ ëª¨ë“œ ê²½ê³  ë°°ë„ˆ */}
          {user?.role === 'admin' && sessionMode && (
            <div className="bg-amber-100 border-b-2 border-amber-400 px-4 py-2 flex items-center justify-between">
              <div className="flex items-center gap-2 text-amber-800">
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <span className="text-sm font-medium">
                  <strong>{sessionMode.toUpperCase()}</strong> ëª¨ë“œë¡œ ì‘ì—… ì¤‘ì…ë‹ˆë‹¤ (ì„ì‹œ)
                </span>
              </div>
              <button
                onClick={() => handleModeSwitch(null)}
                className="text-amber-700 hover:text-amber-900 text-sm font-semibold px-3 py-1 rounded hover:bg-amber-200 transition"
              >
                Adminìœ¼ë¡œ ëŒì•„ê°€ê¸°
              </button>
            </div>
          )}
          <main>
            {viewState === 'role_select' && <RoleSelectionPage />}
            {viewState === 'admin_dashboard' && <AdminDashboard />}
            {viewState === 'mentor_dashboard' && mentorDashboardContent}
            {viewState === 'mentee_list' && menteeListContent}
            {viewState === 'mentee_study' && menteeStudyContent}
          </main>
          {/* Toast Container */}
          {typeof window.reactHotToast !== 'undefined' && window.reactHotToast.Toaster && (
            <window.reactHotToast.Toaster
              position="top-center"
              toastOptions={{
                style: { background: '#333', color: '#fff', maxWidth: '500px' },
                success: { duration: 3000, iconTheme: { primary: '#10b981', secondary: '#fff' } },
                error: { duration: 5000, iconTheme: { primary: '#ef4444', secondary: '#fff' } }
              }}
            />
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
