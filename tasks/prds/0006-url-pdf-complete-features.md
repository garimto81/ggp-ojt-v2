# PRD-0006: URL/PDF 콘텐츠 완전 기능 명세

**Version**: 1.1.0
**Date**: 2025-12-05
**Author**: Claude (AI Assistant)
**Status**: Verified (논리적 검증 완료)
**Related Issues**: #36 (PDF 업로드), #43 (URL/PDF 미리보기 UI)
**Depends On**: PRD-0004 (원문 뷰어)

---

## 0. 검증 요약 (Validation Summary)

### 논리적 검증 결과 (2025-12-05)

| 검증 항목 | 상태 | 비고 |
|----------|------|------|
| 기능 완결성 (CRUD) | ⚠️ 부분 충족 | DocsContext CRUD 함수 추가 필요 |
| 의존성 일관성 | ✅ 충족 | 순환 의존성 없음 |
| 기술적 실현 가능성 | ⚠️ 부분 충족 | `react-pdf` 설치, R2 Worker 확장 필요 |
| 사용자 스토리 매핑 | ✅ 충족 | 11개 스토리 모두 FR 연결 |
| 에러 처리 완결성 | ⚠️ 부분 충족 | PDF 업로드 에러 케이스 추가됨 |
| 보안 고려사항 | ✅ 충족 | SSRF, XSS, 파일 검증 완료 |
| 성능 목표 | ✅ 현실적 | 모든 목표치 달성 가능 |

### 구현 전 필수 조치 (Critical Prerequisites)

| 우선순위 | 조치 항목 | 담당 |
|---------|----------|------|
| **P0** | `npm install react-pdf` (src-vite) | 개발팀 |
| **P0** | R2 Worker 파일 크기 50MB 확대 + 청크 업로드 | 개발팀 |
| **P0** | DocsContext에 CRUD 함수 추가 | 개발팀 |
| **P1** | PDF 업로드 에러 케이스 구현 | 개발팀 |

---

## 1. 개요 (Executive Summary)

### 1.1 목적

URL/PDF 기반 OJT 콘텐츠의 전체 생명주기(CRUD + 미리보기 + 재생성)를 정의하여, 현업에서 실제 사용 가능한 완성도 높은 기능 제공.

### 1.2 현재 상태 분석

| 기능 | PRD-0004 상태 | 실제 구현 | 누락 기능 |
|------|--------------|----------|----------|
| URL 입력 | ✅ 정의 | ✅ 구현 | 미리보기, 수정 |
| PDF 업로드 | ✅ 정의 | ❌ 미구현 | 전체 |
| 원문 뷰어 (Mentee) | ✅ 정의 | ⚠️ 부분 | Split View |
| 퀴즈 생성 | ✅ 정의 | ✅ 구현 | 재생성 |
| 콘텐츠 수정 | ❌ 미정의 | ❌ 미구현 | 전체 |
| 콘텐츠 삭제 | ✅ 정의 | ✅ 구현 | - |

### 1.3 목표

1. **Mentor 경험 완성**: URL/PDF → 미리보기 → 생성 → 수정 → 재생성
2. **Mentee 경험 개선**: 원문과 학습 콘텐츠 동시 비교 (Split View)
3. **반응형 지원**: 데스크톱/태블릿/모바일 최적화

---

## 2. 사용자 스토리 (User Stories)

### 2.1 Mentor 스토리

| ID | As a | I want to | So that |
|----|------|-----------|---------|
| M-01 | Mentor | URL을 입력하면 원문 미리보기를 볼 수 있다 | 올바른 콘텐츠인지 확인 후 생성할 수 있다 |
| M-02 | Mentor | PDF를 업로드하면 미리보기를 볼 수 있다 | 올바른 파일인지 확인할 수 있다 |
| M-03 | Mentor | 생성된 퀴즈를 검토하고 수정할 수 있다 | 부적절한 문제를 교정할 수 있다 |
| M-04 | Mentor | 특정 퀴즈만 선택하여 재생성할 수 있다 | 품질이 낮은 문제만 개선할 수 있다 |
| M-05 | Mentor | 저장된 문서의 원본 URL/PDF를 변경할 수 있다 | 원문이 변경되었을 때 업데이트할 수 있다 |
| M-06 | Mentor | 저장된 문서의 섹션 내용을 수정할 수 있다 | AI 생성 결과를 보완할 수 있다 |
| M-07 | Mentor | PDF 업로드 진행률을 확인할 수 있다 | 대용량 파일 업로드 상태를 알 수 있다 |

### 2.2 Mentee 스토리

| ID | As a | I want to | So that |
|----|------|-----------|---------|
| E-01 | Mentee | 학습 중 원문을 동시에 볼 수 있다 | 맥락을 이해하며 학습할 수 있다 |
| E-02 | Mentee | URL 원문을 새 탭에서 열 수 있다 | 전체 화면으로 원문을 볼 수 있다 |
| E-03 | Mentee | PDF를 인앱 뷰어로 볼 수 있다 | 앱을 벗어나지 않고 원문을 볼 수 있다 |
| E-04 | Mentee | 모바일에서도 원문을 볼 수 있다 | 언제 어디서든 학습할 수 있다 |

---

## 3. 기능 요구사항 (Functional Requirements)

### 3.1 URL 콘텐츠 관리

#### FR-101: URL 입력 및 미리보기

**트리거**: Mentor가 URL 탭 선택 후 URL 입력

**처리 흐름**:
```
┌──────────────────────────────────────────────────────────────┐
│ 1. URL 입력                                                   │
│    ┌─────────────────────────────────────────────────────┐   │
│    │ https://example.com/article                    [추출] │   │
│    └─────────────────────────────────────────────────────┘   │
│                            │                                  │
│                            ▼                                  │
│ 2. 미리보기 패널 (추출 성공 시)                               │
│    ┌─────────────────────────────────────────────────────┐   │
│    │ 📄 원문 미리보기                              [새탭]  │   │
│    │ ─────────────────────────────────────────────────── │   │
│    │ 제목: Sample Article Title                          │   │
│    │ 글자수: 3,500자 | 예상 시간: 15분                    │   │
│    │ ─────────────────────────────────────────────────── │   │
│    │ [추출된 텍스트 첫 500자 미리보기...]                 │   │
│    └─────────────────────────────────────────────────────┘   │
│                            │                                  │
│                            ▼                                  │
│ 3. [AI로 교육 자료 생성] 버튼                                 │
└──────────────────────────────────────────────────────────────┘
```

**검증 규칙**:
- URL 형식 유효성 (`URL` 객체 생성 가능)
- SSRF 방어 (`validateUrlForSSRF()`)
- 프로토콜 제한 (http/https만 허용)

**에러 처리**:
| 에러 | 메시지 | 대응 |
|------|--------|------|
| 유효하지 않은 URL | "올바른 URL 형식이 아닙니다" | 입력 필드 하이라이트 |
| SSRF 차단 | "내부 네트워크 URL은 사용할 수 없습니다" | 경고 표시 |
| 추출 실패 | "텍스트 추출에 실패했습니다. 직접 입력하세요" | 텍스트 탭 전환 유도 |
| CORS 차단 | "접근이 차단된 URL입니다" | 대안 제시 |

#### FR-102: URL 콘텐츠 수정

**트리거**: Mentor가 저장된 URL 문서의 "수정" 버튼 클릭

**수정 가능 필드**:
| 필드 | 수정 가능 | 비고 |
|------|----------|------|
| title | ✅ | 텍스트 입력 |
| source_url | ✅ | URL 변경 + 재추출 옵션 |
| sections | ✅ | Quill 에디터 |
| quiz | ✅ | 개별 문제 수정/삭제/재생성 |
| team | ✅ | 드롭다운 선택 |
| step | ✅ | 1-5 선택 |

**UI 구조**:
```
┌──────────────────────────────────────────────────────────────┐
│ 문서 수정: [제목 입력 필드]                                    │
├──────────────────────────────────────────────────────────────┤
│ 원본 URL                                                      │
│ ┌─────────────────────────────────────────────────────────┐  │
│ │ https://original-url.com/article          [변경] [재추출]│  │
│ └─────────────────────────────────────────────────────────┘  │
├──────────────────────────────────────────────────────────────┤
│ 섹션 편집                                                     │
│ ┌─────────────────────────────────────────────────────────┐  │
│ │ [Quill Rich Text Editor]                                │  │
│ │ 섹션 1: 학습 목표                              [삭제]   │  │
│ │ 섹션 2: 핵심 내용                              [삭제]   │  │
│ │                                        [+ 섹션 추가]    │  │
│ └─────────────────────────────────────────────────────────┘  │
├──────────────────────────────────────────────────────────────┤
│ 퀴즈 편집                                                     │
│ [퀴즈 목록 - FR-105 참조]                                     │
├──────────────────────────────────────────────────────────────┤
│ [취소]                                              [저장]    │
└──────────────────────────────────────────────────────────────┘
```

### 3.2 PDF 콘텐츠 관리

#### FR-201: PDF 업로드 및 미리보기

**트리거**: Mentor가 PDF 탭 선택 후 파일 선택/드래그

**처리 흐름**:
```
┌──────────────────────────────────────────────────────────────┐
│ 1. 파일 선택                                                  │
│    ┌─────────────────────────────────────────────────────┐   │
│    │  ┌──────────────────────────────────────────────┐   │   │
│    │  │     📄 드래그 앤 드롭 또는 클릭하여 선택      │   │   │
│    │  │         PDF 파일 (최대 50MB)                 │   │   │
│    │  └──────────────────────────────────────────────┘   │   │
│    └─────────────────────────────────────────────────────┘   │
│                            │                                  │
│                            ▼                                  │
│ 2. 업로드 진행률                                              │
│    ┌─────────────────────────────────────────────────────┐   │
│    │ 📄 document.pdf (3.5MB)                             │   │
│    │ ████████████░░░░░░░░ 60% (2.1MB / 3.5MB)    [취소]  │   │
│    └─────────────────────────────────────────────────────┘   │
│                            │                                  │
│                            ▼                                  │
│ 3. 미리보기 (업로드 완료 시)                                  │
│    ┌─────────────────────────────────────────────────────┐   │
│    │ 📄 PDF 미리보기                           [전체보기] │   │
│    │ ─────────────────────────────────────────────────── │   │
│    │ ┌───────────────────────────────────────────────┐   │   │
│    │ │                                               │   │   │
│    │ │         [PDF 첫 페이지 썸네일]                │   │   │
│    │ │                                               │   │   │
│    │ └───────────────────────────────────────────────┘   │   │
│    │ 페이지: 12 | 파일 크기: 3.5MB                        │   │
│    └─────────────────────────────────────────────────────┘   │
│                            │                                  │
│                            ▼                                  │
│ 4. [AI로 퀴즈 생성] 버튼                                      │
└──────────────────────────────────────────────────────────────┘
```

**파일 검증**:
| 검증 | 조건 | 에러 메시지 |
|------|------|------------|
| 파일 타입 | `application/pdf` | "PDF 파일만 업로드 가능합니다" |
| 파일 크기 | ≤ 50MB | "파일 크기는 50MB를 초과할 수 없습니다" |
| MAGIC_NUMBER | `%PDF-` | "손상된 PDF 파일입니다" |

**업로드 방식**:
| 파일 크기 | 방식 | 설명 |
|----------|------|------|
| < 5MB | 직접 업로드 | 단일 PUT 요청 |
| 5MB - 50MB | 청크 업로드 | 5MB 단위 분할 후 병합 |

**업로드 에러 처리** (검증 추가):
| 에러 | 메시지 | 대응 |
|------|--------|------|
| 네트워크 타임아웃 | "네트워크 연결이 불안정합니다" | 자동 재시도 (3회) |
| 청크 업로드 실패 | "파일 업로드 중 일부가 실패했습니다" | 실패 청크만 재시도 |
| 재시도 초과 | "업로드에 실패했습니다. 다시 시도해주세요" | 전체 재시작 안내 |
| R2 저장 실패 | "서버 저장에 실패했습니다" | 관리자 문의 안내 |

**업로드 취소/일시정지** (검증 추가):
- 취소 버튼으로 진행 중 업로드 중단 가능
- 청크 업로드 중 일시정지/재개 미지원 (복잡도 대비 효용 낮음)

#### FR-202: PDF 콘텐츠 수정

FR-102와 동일한 수정 UI, 추가 필드:
- `source_file`: R2 URL (변경 시 새 파일 업로드)

**파일 교체 흐름**:
```
[기존 PDF 표시] → [새 파일 선택] → [업로드] → [기존 파일 삭제 여부 확인]
                                              ↓
                                   [예: 삭제] [아니오: 유지 (orphan)]
```

### 3.3 퀴즈 관리

#### FR-301: 퀴즈 미리보기 (생성 후)

**현재 구현**: ✅ 완료 (`handleQuizPreview`)

**기능**:
- 전체 퀴즈 목록 표시
- 더미 문제 하이라이트 (노란 배경)
- 개별 퀴즈 선택 체크박스

#### FR-302: 퀴즈 개별 수정

**트리거**: 퀴즈 항목 클릭 → 편집 모드

**편집 가능 필드**:
```jsx
{
  question: "문제 텍스트",      // textarea
  options: ["A", "B", "C", "D"], // 4개 input
  correct: 0,                   // radio button
  explanation: "해설"           // textarea (optional)
}
```

**UI**:
```
┌──────────────────────────────────────────────────────────────┐
│ Q3. [문제 텍스트 편집 textarea]                               │
├──────────────────────────────────────────────────────────────┤
│ ○ A. [선택지 1 input]                                        │
│ ● B. [선택지 2 input] ← 정답 (라디오 선택)                   │
│ ○ C. [선택지 3 input]                                        │
│ ○ D. [선택지 4 input]                                        │
├──────────────────────────────────────────────────────────────┤
│ 해설 (선택)                                                   │
│ [해설 textarea]                                               │
├──────────────────────────────────────────────────────────────┤
│ [취소]              [삭제]                        [저장]      │
└──────────────────────────────────────────────────────────────┘
```

#### FR-303: 퀴즈 선택 재생성

**현재 구현**: ✅ 완료 (`handleRegenerateQuizzes`)

**개선 사항**:
- 재생성 시 원본 컨텍스트 유지 (URL/PDF 다시 분석)
- 재생성 개수 옵션 (선택된 개수 또는 전체)

#### FR-304: 퀴즈 추가

**트리거**: "퀴즈 추가" 버튼 클릭

**옵션**:
1. **수동 추가**: 빈 퀴즈 폼 표시 → 직접 입력
2. **AI 추가**: N개 퀴즈 추가 생성 (원본 컨텍스트 기반)

#### FR-305: 퀴즈 삭제

**트리거**: 개별 퀴즈 "삭제" 버튼

**제약**:
- 최소 4개 퀴즈 유지 (테스트 진행 최소 요건)
- 4개 이하 시 삭제 버튼 비활성화 + 경고

### 3.4 원문 뷰어 (Mentee)

#### FR-401: Split View (데스크톱)

**화면 구성**:
```
┌────────────────────────────────────────────────────────────────┐
│ 📚 OJT 문서 학습: [문서 제목]                                   │
├──────────────────────────────┬─────────────────────────────────┤
│ 원문 (40%)                   │ 학습 콘텐츠 (60%)               │
│                              │                                 │
│ ┌──────────────────────────┐ │ ┌─────────────────────────────┐ │
│ │ [URL: iframe/새탭링크]   │ │ │ 섹션 1: 학습 목표            │ │
│ │ 또는                     │ │ │ ─────────────────────────── │ │
│ │ [PDF: react-pdf 뷰어]    │ │ │ 콘텐츠...                   │ │
│ │                          │ │ │                             │ │
│ │ ← 스크롤 독립 →          │ │ │ ← 스크롤 독립 →             │ │
│ │                          │ │ │                             │ │
│ └──────────────────────────┘ │ │ 섹션 2: 핵심 내용            │ │
│                              │ │ ...                         │ │
│ [전체화면] [새탭열기]        │ │                             │ │
│                              │ └─────────────────────────────┘ │
│                              │                                 │
│                              │ [퀴즈 시작]                     │
├──────────────────────────────┴─────────────────────────────────┤
│ 📄 출처: https://example.com/article                           │
└────────────────────────────────────────────────────────────────┘
```

**구현 기술**:
- CSS Grid 또는 Flexbox (40:60 비율)
- `resize` 핸들로 비율 조절 가능
- 각 패널 독립 스크롤 (`overflow-y: auto`)

#### FR-402: Tab Switching (모바일)

**화면 구성**:
```
┌────────────────────────────────────┐
│ 📚 [문서 제목]                      │
├────────────────────────────────────┤
│ [학습]          [원문]              │
│   ▲                                │
│   └── 활성 탭 하이라이트            │
├────────────────────────────────────┤
│                                    │
│ 현재 선택된 탭 콘텐츠               │
│ (전체 화면 표시)                    │
│                                    │
│                                    │
├────────────────────────────────────┤
│ [퀴즈 시작]                         │
└────────────────────────────────────┘
```

#### FR-403: PDF 인앱 뷰어

**라이브러리**: `react-pdf` (wojtekmaj)

**기능**:
| 기능 | 구현 |
|------|------|
| 페이지 네비게이션 | `<Page pageNumber={n}>` + 이전/다음 버튼 |
| 확대/축소 | `scale` prop + 버튼 (+/-) |
| 전체화면 | Fullscreen API |
| 다운로드 | `<a href={source_file} download>` |
| 페이지 썸네일 | 선택적 (성능 고려) |

**설정**:
```javascript
// constants.js
export const PDF_VIEWER_CONFIG = {
  DEFAULT_SCALE: 1.0,
  MIN_SCALE: 0.5,
  MAX_SCALE: 3.0,
  SCALE_STEP: 0.25,
};
```

---

## 4. 비기능 요구사항 (Non-Functional Requirements)

### 4.1 성능

| 지표 | 목표 | 측정 방법 |
|------|------|----------|
| URL 추출 시간 | < 5초 | API 응답 시간 |
| PDF 업로드 (5MB) | < 10초 | 업로드 완료 시간 |
| 퀴즈 생성 시간 | < 30초 | Gemini API 응답 |
| PDF 첫 페이지 렌더링 | < 2초 | FCP 측정 |
| Split View 전환 | < 100ms | 애니메이션 |

### 4.2 반응형 브레이크포인트

| 디바이스 | 너비 | 레이아웃 |
|---------|------|---------|
| Desktop | ≥ 1024px | Split View (40:60) |
| Tablet | 768-1023px | Split View (50:50) 또는 Drawer |
| Mobile | < 768px | Tab Switching |

### 4.3 접근성

- 키보드 네비게이션 (Tab, Enter)
- 스크린 리더 지원 (aria-label)
- 색상 대비 WCAG 2.1 AA 준수

### 4.4 오프라인 지원

| 데이터 | 오프라인 가용성 |
|--------|---------------|
| 문서 메타데이터 | ✅ Dexie 캐시 |
| 섹션 콘텐츠 | ✅ Dexie 캐시 |
| 퀴즈 데이터 | ✅ Dexie 캐시 |
| URL 원문 | ❌ 온라인 필요 |
| PDF 파일 | ⚠️ 캐시 옵션 (용량 주의) |

**PDF 오프라인 캐시 정책** (검증 추가):
- 최대 캐시 용량: 100MB
- 캐시 정책: LRU (Least Recently Used)
- 사용자 선택적 다운로드 (자동 캐시 아님)
- 캐시 초과 시 오래된 파일 자동 정리

---

## 5. 기술 설계

### 5.1 컴포넌트 구조

```
src-vite/src/components/
├── MentorDashboard.jsx          # 기존 (수정 예정)
│   ├── UrlPreviewPanel.jsx      # 신규: URL 미리보기
│   ├── PdfUploader.jsx          # 신규: PDF 업로드 + 진행률
│   ├── ContentEditor.jsx        # 신규: 섹션 편집 (Quill)
│   └── QuizEditor.jsx           # 신규: 퀴즈 편집/재생성
│
├── MenteeStudy.jsx              # 기존 (수정 예정)
│   ├── SplitViewLayout.jsx      # 신규: 데스크톱 레이아웃
│   ├── TabLayout.jsx            # 신규: 모바일 레이아웃
│   ├── SourceViewer.jsx         # 신규: URL/PDF 통합 뷰어
│   └── PdfViewer.jsx            # 신규: react-pdf 래퍼
│
└── common/
    ├── ProgressBar.jsx          # 업로드 진행률
    └── ResponsiveLayout.jsx     # 반응형 감지 훅
```

### 5.2 상태 관리 확장

```javascript
// contexts/DocsContext.jsx 확장
const DocsContext = {
  // 기존
  docs: [],
  selectedDoc: null,
  myDocs: [],

  // 신규
  editingDoc: null,           // 수정 중인 문서
  previewContent: null,       // URL/PDF 미리보기 데이터
  uploadProgress: {           // 업로드 상태
    uploading: false,
    progress: 0,
    file: null
  },

  // 액션 (기존)
  saveDocument: async (doc) => {},  // 신규 문서 저장
  deleteDocument: async (docId) => {},  // 문서 삭제

  // 액션 (신규 - 검증 추가)
  updateDocument: async (docId, updates) => {},  // 문서 부분 수정
  setEditingDoc: (doc) => {},
  setPreviewContent: (content) => {},
  updateQuiz: (docId, quizIndex, updates) => {},
  deleteQuiz: (docId, quizIndex) => {},
  addQuiz: (docId, quiz) => {},
  regenerateQuizzes: (docId, indices) => {},
};

// DocsContext 신규 함수 명세 (검증 추가)
/**
 * updateDocument - 문서 부분 수정
 * @param {string} docId - 문서 ID
 * @param {object} updates - 수정할 필드 { title?, source_url?, sections?, quiz?, team?, step? }
 * @returns {Promise<object>} 수정된 문서
 *
 * 처리:
 * 1. Supabase ojt_docs 테이블 UPDATE
 * 2. Dexie 로컬 캐시 업데이트
 * 3. 실패 시 sync_queue에 저장 (오프라인 지원)
 */

/**
 * updateQuiz - 개별 퀴즈 수정
 * @param {string} docId - 문서 ID
 * @param {number} quizIndex - 퀴즈 인덱스
 * @param {object} updates - { question?, options?, correct?, explanation? }
 * @returns {Promise<void>}
 */

/**
 * deleteQuiz - 퀴즈 삭제
 * @param {string} docId - 문서 ID
 * @param {number} quizIndex - 삭제할 퀴즈 인덱스
 * @throws {Error} 퀴즈가 4개 이하면 삭제 불가
 */

/**
 * addQuiz - 퀴즈 추가
 * @param {string} docId - 문서 ID
 * @param {object} quiz - { question, options, correct, explanation? }
 * @returns {Promise<number>} 추가된 퀴즈 인덱스
 */
```

### 5.3 R2 Worker 확장

```javascript
// ojt-r2-upload/src/index.js

// 기존: 이미지 업로드
// 추가: PDF 업로드 + 청크 지원

export default {
  async fetch(request, env) {
    const url = new URL(request.url);

    // PDF 업로드 (단일)
    if (url.pathname === '/upload/pdf' && request.method === 'PUT') {
      return handlePdfUpload(request, env);
    }

    // PDF 청크 업로드 시작
    if (url.pathname === '/upload/pdf/init' && request.method === 'POST') {
      return initChunkedUpload(request, env);
    }

    // PDF 청크 업로드 (개별)
    if (url.pathname.startsWith('/upload/pdf/chunk/') && request.method === 'PUT') {
      return uploadChunk(request, env);
    }

    // PDF 청크 병합
    if (url.pathname.startsWith('/upload/pdf/complete/') && request.method === 'POST') {
      return completeChunkedUpload(request, env);
    }

    // URL 프록시 (CORS 해결)
    if (url.pathname === '/proxy' && request.method === 'GET') {
      return proxyUrl(request, env);
    }

    // 기존 이미지 업로드 로직...
  }
};
```

### 5.4 PDF 뷰어 컴포넌트

```jsx
// components/PdfViewer.jsx
import { Document, Page, pdfjs } from 'react-pdf';
import 'react-pdf/dist/esm/Page/AnnotationLayer.css';
import 'react-pdf/dist/esm/Page/TextLayer.css';

pdfjs.GlobalWorkerOptions.workerSrc = new URL(
  'pdfjs-dist/build/pdf.worker.min.mjs',
  import.meta.url,
).toString();

export default function PdfViewer({ fileUrl }) {
  const [numPages, setNumPages] = useState(null);
  const [pageNumber, setPageNumber] = useState(1);
  const [scale, setScale] = useState(1.0);

  return (
    <div className="pdf-viewer">
      <div className="controls">
        <button onClick={() => setPageNumber(p => Math.max(1, p - 1))}>이전</button>
        <span>{pageNumber} / {numPages}</span>
        <button onClick={() => setPageNumber(p => Math.min(numPages, p + 1))}>다음</button>
        <button onClick={() => setScale(s => Math.max(0.5, s - 0.25))}>-</button>
        <span>{Math.round(scale * 100)}%</span>
        <button onClick={() => setScale(s => Math.min(3, s + 0.25))}>+</button>
      </div>

      <Document
        file={fileUrl}
        onLoadSuccess={({ numPages }) => setNumPages(numPages)}
        loading={<div>PDF 로딩 중...</div>}
        error={<div>PDF를 불러올 수 없습니다</div>}
      >
        <Page pageNumber={pageNumber} scale={scale} />
      </Document>
    </div>
  );
}
```

---

## 6. 데이터 흐름 다이어그램

### 6.1 URL 콘텐츠 생성 흐름

```
[Mentor]
    │
    ▼
┌────────────────┐
│ URL 입력        │
└────────────────┘
    │
    ▼
┌────────────────┐     ┌────────────────┐
│ 유효성 검증     │────▶│ SSRF 방어      │
└────────────────┘     └────────────────┘
    │ 통과
    ▼
┌────────────────┐     ┌────────────────┐
│ 텍스트 추출     │────▶│ R2 Worker      │
│ (extractUrlText)│     │ /proxy         │
└────────────────┘     └────────────────┘
    │
    ▼
┌────────────────┐
│ 미리보기 표시   │
│ - 제목, 글자수  │
│ - 텍스트 일부   │
└────────────────┘
    │ [생성] 클릭
    ▼
┌────────────────┐     ┌────────────────┐
│ Gemini API     │────▶│ URL Context    │
│ 퀴즈 생성       │     │ Tool           │
└────────────────┘     └────────────────┘
    │
    ▼
┌────────────────┐
│ 퀴즈 미리보기   │
│ - 검증 결과     │
│ - 재생성 옵션   │
└────────────────┘
    │ [저장] 클릭
    ▼
┌────────────────┐     ┌────────────────┐
│ Supabase 저장   │────▶│ Dexie 캐시     │
└────────────────┘     └────────────────┘
```

### 6.2 PDF 콘텐츠 생성 흐름

```
[Mentor]
    │
    ▼
┌────────────────┐
│ PDF 선택/드롭   │
└────────────────┘
    │
    ▼
┌────────────────┐
│ 파일 검증       │
│ - 타입, 크기   │
│ - MAGIC_NUMBER │
└────────────────┘
    │ 통과
    ▼
┌────────────────┐
│ 크기 분기       │
├────────────────┤
│ < 5MB: 직접    │
│ ≥ 5MB: 청크    │
└────────────────┘
    │
    ▼
┌────────────────┐     ┌────────────────┐
│ R2 업로드       │────▶│ 진행률 표시    │
└────────────────┘     └────────────────┘
    │ 완료
    ▼
┌────────────────┐
│ 미리보기 표시   │
│ - 첫 페이지    │
│ - 페이지 수    │
└────────────────┘
    │ [생성] 클릭
    ▼
┌────────────────┐     ┌────────────────┐
│ Gemini API     │────▶│ URL Context    │
│ (R2 공개 URL)   │     │ Tool           │
└────────────────┘     └────────────────┘
    │
    ▼
[이후 URL과 동일]
```

---

## 7. 의존성 분석

### 7.1 기능 의존성 그래프

```
                    ┌─────────────────────────┐
                    │ PRD-0004: 원문 뷰어      │
                    │ (기반 정의)              │
                    └───────────┬─────────────┘
                                │
                ┌───────────────┼───────────────┐
                │               │               │
                ▼               ▼               ▼
        ┌───────────────┐ ┌───────────────┐ ┌───────────────┐
        │ Issue #36     │ │ Issue #43     │ │ 현재 구현     │
        │ PDF 업로드    │ │ 미리보기 UI   │ │ URL 기본 기능 │
        └───────┬───────┘ └───────┬───────┘ └───────┬───────┘
                │               │               │
                └───────────────┼───────────────┘
                                │
                                ▼
                    ┌─────────────────────────┐
                    │ PRD-0006 (본 문서)       │
                    │ 완전 기능 명세           │
                    └─────────────────────────┘
```

### 7.2 구현 우선순위

| 우선순위 | 기능 | 의존성 | 난이도 |
|---------|------|--------|--------|
| **P0** | URL 미리보기 (FR-101) | 없음 | 낮음 |
| **P0** | 퀴즈 개별 수정 (FR-302) | 없음 | 중간 |
| **P1** | PDF 업로드 (FR-201) | R2 Worker 확장 | 중간 |
| **P1** | PDF 미리보기 (FR-201) | react-pdf 설치 | 중간 |
| **P2** | Split View (FR-401) | URL/PDF 뷰어 완료 | 중간 |
| **P2** | URL/PDF 수정 (FR-102, FR-202) | CRUD 완료 | 높음 |
| **P3** | Tab Switching (FR-402) | Split View 완료 | 낮음 |
| **P3** | 퀴즈 추가 (FR-304) | 편집 UI 완료 | 낮음 |

### 7.3 기술 의존성

| 기능 | 필요 패키지 | 현재 상태 |
|------|------------|----------|
| PDF 뷰어 | `react-pdf` | ❌ 설치 필요 |
| PDF 추출 | `pdfjs-dist` | ✅ 설치됨 |
| Rich Editor | `quill` | ✅ 설치됨 |
| XSS 방어 | `dompurify` | ✅ 설치됨 |

---

## 8. 검증 체크리스트

### 8.1 논리적 완결성

- [x] 모든 CRUD 작업 정의됨 (생성, 조회, 수정, 삭제)
- [x] 에러 케이스 정의됨
- [x] 사용자 스토리와 기능 매핑됨
- [x] 반응형 레이아웃 정의됨
- [x] 오프라인 시나리오 고려됨

### 8.2 기술적 실현 가능성

- [x] 의존 라이브러리 확인됨 (`react-pdf` 설치 필요)
- [x] API 호환성 확인됨 (Gemini URL Context Tool)
- [x] R2 Worker 확장 가능 확인됨
- [x] 성능 목표 달성 가능 확인됨

### 8.3 보안 고려사항

- [x] SSRF 방어 유지
- [x] XSS 방어 (DOMPurify) 유지
- [x] 파일 업로드 검증 정의됨
- [x] 권한 검증 (RLS) 정의됨

### 8.4 사용자 경험

- [x] 진행 상태 피드백 정의됨 (업로드 진행률)
- [x] 에러 메시지 정의됨
- [x] 접근성 고려됨 (키보드, 스크린 리더)
- [x] 모바일 경험 정의됨

---

## 9. 테스트 계획

### 9.1 단위 테스트

| 함수 | 테스트 케이스 |
|------|-------------|
| `validateUrlForSSRF` | localhost 차단, 내부 IP 차단, 정상 URL 통과 |
| `validatePdfFile` | 타입 검증, 크기 검증, MAGIC_NUMBER 검증 |
| `uploadToR2` | 성공, 네트워크 에러, 타임아웃 |
| `generateQuizWithUrlContext` | 성공, API 에러, 파싱 에러 |

### 9.2 통합 테스트

| 시나리오 | 검증 항목 |
|---------|----------|
| URL → 미리보기 → 생성 → 저장 | 전체 흐름 |
| PDF → 업로드 → 미리보기 → 생성 | 대용량 파일 포함 |
| 문서 수정 → 퀴즈 재생성 | 부분 업데이트 |
| Split View 토글 | 레이아웃 전환 |

### 9.3 E2E 테스트 (Playwright)

| 테스트 파일 | 커버리지 |
|-----------|---------|
| `e2e-url-workflow.spec.js` | FR-101 ~ FR-102 |
| `e2e-pdf-workflow.spec.js` | FR-201 ~ FR-202 |
| `e2e-quiz-editor.spec.js` | FR-301 ~ FR-305 |
| `e2e-split-view.spec.js` | FR-401 ~ FR-403 |

---

## 10. 구현 마일스톤

### Phase 1: URL 기능 완성 (P0)

- [ ] FR-101: URL 미리보기 패널
- [ ] FR-302: 퀴즈 개별 수정 UI
- [ ] FR-303: 퀴즈 선택 재생성 개선

### Phase 2: PDF 기능 구현 (P1)

- [ ] R2 Worker PDF 업로드 엔드포인트
- [ ] FR-201: PDF 업로드 + 진행률
- [ ] FR-201: PDF 미리보기 (react-pdf)
- [ ] FR-403: PDF 인앱 뷰어

### Phase 3: 수정 기능 구현 (P2)

- [ ] FR-102: URL 문서 수정
- [ ] FR-202: PDF 문서 수정
- [ ] FR-401: Split View 레이아웃

### Phase 4: 모바일 최적화 (P3)

- [ ] FR-402: Tab Switching 레이아웃
- [ ] FR-304: 퀴즈 추가 기능
- [ ] 반응형 테스트

---

## 11. 승인

| 역할 | 이름 | 날짜 | 서명 |
|------|------|------|------|
| 작성자 | Claude (AI) | 2025-12-05 | ✅ |
| 기술 검토 | | | |
| 최종 승인 | | | |

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|----------|--------|
| 1.0.0 | 2025-12-05 | 초안 작성 | Claude |
| 1.1.0 | 2025-12-05 | 논리적 검증 결과 반영 (에러 케이스, DocsContext 함수, 캐시 정책 추가) | Claude |
