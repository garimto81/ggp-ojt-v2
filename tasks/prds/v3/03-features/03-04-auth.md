# 03-04. Authentication & Authorization

> **Parent**: [Master PRD](../00-master-prd.md) | **Version**: 3.0.0

## 3.4.1 Overview

Supabase Authë¥¼ í™œìš©í•œ ì¸ì¦ ë° ì—­í•  ê¸°ë°˜ ê¶Œí•œ ê´€ë¦¬ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

### Auth Providers

| Provider | ìƒíƒœ | ì„¤ëª… |
|----------|------|------|
| Google OAuth | âœ… Active | ì£¼ìš” ë¡œê·¸ì¸ ë°©ì‹ |
| Email/Password | âœ… Active | ëŒ€ì•ˆ ë¡œê·¸ì¸ |
| Magic Link | ğŸ”® Future | ë¹„ë°€ë²ˆí˜¸ ì—†ëŠ” ë¡œê·¸ì¸ |

---

## 3.4.2 Authentication Flow

### Google OAuth Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Supabase Auth â†’ Google OAuth                â”‚
â”‚     supabase.auth.signInWithOAuth({             â”‚
â”‚       provider: 'google'                        â”‚
â”‚     })                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Google ë¡œê·¸ì¸ í˜ì´ì§€                         â”‚
â”‚     - ê³„ì • ì„ íƒ                                  â”‚
â”‚     - ê¶Œí•œ ìŠ¹ì¸                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. ì½œë°± ì²˜ë¦¬                                    â”‚
â”‚     - auth.users ìë™ ìƒì„±                      â”‚
â”‚     - JWT í† í° ë°œê¸‰                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. í”„ë¡œí•„ í™•ì¸                                  â”‚
â”‚     - users í…Œì´ë¸” ì¡°íšŒ                         â”‚
â”‚     - ì‹ ê·œ ì‚¬ìš©ì: ì—­í•  ì„ íƒ í˜ì´ì§€              â”‚
â”‚     - ê¸°ì¡´ ì‚¬ìš©ì: ëŒ€ì‹œë³´ë“œ ì´ë™                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Email/Password Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  íšŒì›ê°€ì…                                        â”‚
â”‚  1. Email + Password ì…ë ¥                       â”‚
â”‚  2. supabase.auth.signUp()                      â”‚
â”‚  3. ì´ë©”ì¼ í™•ì¸ (ì„ íƒ)                          â”‚
â”‚  4. ì—­í•  ì„ íƒ â†’ users í…Œì´ë¸” ìƒì„±               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ë¡œê·¸ì¸                                          â”‚
â”‚  1. Email + Password ì…ë ¥                       â”‚
â”‚  2. supabase.auth.signInWithPassword()          â”‚
â”‚  3. JWT í† í° ë°œê¸‰                               â”‚
â”‚  4. ëŒ€ì‹œë³´ë“œ ì´ë™                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3.4.3 Role-Based Access Control

### Roles

| Role | ì½”ë“œ | ì„¤ëª… |
|------|------|------|
| Admin | `admin` | ì‹œìŠ¤í…œ ì „ì²´ ê´€ë¦¬ |
| Mentor | `mentor` | ì½˜í…ì¸  ìƒì„± ë° ê´€ë¦¬ |
| Mentee | `mentee` | í•™ìŠµ ë° í€´ì¦ˆ ì‘ì‹œ |

### Permission Matrix

| Action | Admin | Mentor | Mentee |
|--------|-------|--------|--------|
| View All Users | âœ… | âŒ | âŒ |
| Change User Role | âœ… | âŒ | âŒ |
| View All Documents | âœ… | âœ… | âœ… |
| Create Document | âœ… | âœ… | âŒ |
| Edit Any Document | âœ… | Own Only | âŒ |
| Delete Any Document | âœ… | Own Only | âŒ |
| View Learning Records | All | Own Team | Own |
| Take Quiz | âœ… | âœ… | âœ… |

---

## 3.4.4 Role Selection

### ì‹ ê·œ ì‚¬ìš©ì ì—­í•  ì„ íƒ

```jsx
// RoleSelectionPage.jsx
const roles = [
  { id: 'mentor', label: 'ë©˜í† ', description: 'êµìœ¡ ìë£Œë¥¼ ë§Œë“¤ì–´ìš”' },
  { id: 'mentee', label: 'ë©˜í‹°', description: 'í•™ìŠµì„ ì§„í–‰í•´ìš”' },
];

// Adminì€ UIì—ì„œ ì„ íƒ ë¶ˆê°€ (DBì—ì„œ ì§ì ‘ ì„¤ì • ë˜ëŠ” ê¸°ì¡´ Adminì´ ë¶€ì—¬)
```

### ì—­í•  ë³€ê²½ (Admin Only)

```javascript
// adminë§Œ ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ì—­í•  ë³€ê²½ ê°€ëŠ¥
const changeUserRole = async (userId, newRole) => {
  const { error } = await supabase
    .from('users')
    .update({ role: newRole })
    .eq('id', userId);
};
```

---

## 3.4.5 Session Management

### AuthContext

```jsx
// contexts/AuthContext.jsx
const AuthContext = createContext();

export function AuthProvider({ children }) {
  const [user, setUser] = useState(null);
  const [session, setSession] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // ì´ˆê¸° ì„¸ì…˜ í™•ì¸
    supabase.auth.getSession().then(({ data: { session } }) => {
      setSession(session);
      if (session?.user) fetchUserProfile(session.user.id);
    });

    // ì„¸ì…˜ ë³€ê²½ êµ¬ë…
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      (_event, session) => {
        setSession(session);
        if (session?.user) fetchUserProfile(session.user.id);
        else setUser(null);
      }
    );

    return () => subscription.unsubscribe();
  }, []);

  return (
    <AuthContext.Provider value={{ user, session, loading, signIn, signOut }}>
      {children}
    </AuthContext.Provider>
  );
}
```

### Session Expiry

| ì„¤ì • | ê°’ | ì„¤ëª… |
|------|-----|------|
| JWT Expiry | 1ì‹œê°„ | Supabase ê¸°ë³¸ê°’ |
| Refresh Token | 7ì¼ | ìë™ ê°±ì‹  |
| Session Storage | localStorage | ë¸Œë¼ìš°ì € ì„¸ì…˜ ìœ ì§€ |

---

## 3.4.6 Security Considerations

### Client-Side

| í•­ëª© | êµ¬í˜„ |
|------|------|
| Token Storage | `localStorage` (Supabase ê¸°ë³¸) |
| CORS | Supabase ë„ë©”ì¸ í—ˆìš© |
| XSS Protection | DOMPurifyë¡œ ì…ë ¥ sanitize |

### Server-Side (Supabase)

| í•­ëª© | êµ¬í˜„ |
|------|------|
| RLS | í…Œì´ë¸”ë³„ Row Level Security |
| API Key | anon keyë§Œ í´ë¼ì´ì–¸íŠ¸ ë…¸ì¶œ |
| Password | bcrypt í•´ì‹± (Supabase ë‚´ì¥) |

### RLS Helper Functions

```sql
-- í˜„ì¬ ì‚¬ìš©ì ì—­í•  ì¡°íšŒ (RLS ì¬ê·€ ë°©ì§€)
CREATE OR REPLACE FUNCTION public.rls_get_role()
RETURNS TEXT
LANGUAGE sql
SECURITY DEFINER
STABLE
AS $$
  SELECT role FROM public.users WHERE id = auth.uid()
$$;

-- Admin ì—¬ë¶€ í™•ì¸
CREATE OR REPLACE FUNCTION public.rls_is_admin()
RETURNS BOOLEAN
LANGUAGE sql
SECURITY DEFINER
STABLE
AS $$
  SELECT COALESCE(
    (SELECT role = 'admin' FROM public.users WHERE id = auth.uid()),
    false
  )
$$;
```

---

## 3.4.7 Error Handling

| ì—ëŸ¬ | ì½”ë“œ | ëŒ€ì‘ |
|------|------|------|
| Invalid credentials | 400 | "ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤" |
| Email not confirmed | 400 | "ì´ë©”ì¼ ì¸ì¦ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”" |
| Session expired | 401 | ìë™ ë¡œê·¸ì•„ì›ƒ â†’ ë¡œê·¸ì¸ í˜ì´ì§€ |
| Unauthorized | 403 | "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤" |
| Rate limit | 429 | "ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”" |

---

## Related Documents

- [User Personas](../02-user-personas.md)
- [Dashboard](./03-03-dashboard.md)
- [RLS Policies](../04-database/04-02-rls-policies.md)
